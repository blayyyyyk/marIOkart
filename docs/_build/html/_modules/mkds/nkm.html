<!DOCTYPE html>
<html lang="en" data-accent-color="purple" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>mkds.nkm - MarI/O Kart documentation</title><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b1a1f93b" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=bb284d7b" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="mkds.nkm"/>
<meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../index.html">
      
      
      <strong>MarI/O Kart</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../OVERLAYS.html">MKDS Overlay System — Extensible Overlays for Mario Kart DS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../READING_FILES.html"><code class="docutils literal notranslate"><span class="pre">mkds</span></code> — Mario Kart DS NKM &amp; KCL Readers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../READING_MEMORY.html">MKDS Emulator I/O &amp; Geometry Utilities</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">MarI/O Kart</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">mkds.nkm</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for mkds.nkm</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span data-line="2">    <span class="n">read_u8</span><span class="p">,</span>
</span><span data-line="3">    <span class="n">read_u16</span><span class="p">,</span>
</span><span data-line="4">    <span class="n">read_u32</span><span class="p">,</span>
</span><span data-line="5">    <span class="n">read_s16</span><span class="p">,</span>
</span><span data-line="6">    <span class="n">read_s32</span><span class="p">,</span>
</span><span data-line="7">    <span class="n">read_fx16</span><span class="p">,</span>
</span><span data-line="8">    <span class="n">read_fx32</span><span class="p">,</span>
</span><span data-line="9">    <span class="n">read_vector_2d_fx32</span><span class="p">,</span>
</span><span data-line="10">    <span class="n">read_vector_3d_fx32</span><span class="p">,</span>
</span><span data-line="11"><span class="p">)</span>
</span><span data-line="12">
</span><span data-line="13">
<div class="viewcode-block" id="Section">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.Section">[docs]</a>
</span><span data-line="14"><span class="k">class</span><span class="w"> </span><span class="nc">Section</span><span class="p">:</span>
</span><span data-line="15"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="16"><span class="sd">    Base class for sections in an NKM file.</span>
</span><span data-line="17">
</span><span data-line="18"><span class="sd">    Overview</span>
</span><span data-line="19"><span class="sd">    --------</span>
</span><span data-line="20"><span class="sd">    Most NKM sections (all except STAG) begin with an 8-byte section header:</span>
</span><span data-line="21"><span class="sd">      - 0x00 (4 bytes): Section magic (ASCII, e.g., &quot;OBJI&quot;).</span>
</span><span data-line="22"><span class="sd">      - 0x04 (4 bytes): Number of entries in the section (UInt32).</span>
</span><span data-line="23"><span class="sd">    Immediately after the header the section contains `entry_count` entries,</span>
</span><span data-line="24"><span class="sd">    each with a fixed stride (size) which is specified by the concrete Section</span>
</span><span data-line="25"><span class="sd">    subclass.</span>
</span><span data-line="26">
</span><span data-line="27"><span class="sd">    This base class encapsulates:</span>
</span><span data-line="28"><span class="sd">      - raw `data` for the whole section (header + entries)</span>
</span><span data-line="29"><span class="sd">      - `stride` (size in bytes of a single entry)</span>
</span><span data-line="30"><span class="sd">      - `entry_count` parsed from the header</span>
</span><span data-line="31"><span class="sd">      - an iterator over each fixed-size entry slice</span>
</span><span data-line="32">
</span><span data-line="33"><span class="sd">    Notes / Caveats</span>
</span><span data-line="34"><span class="sd">    ----------------</span>
</span><span data-line="35"><span class="sd">    * This class assumes the `data` passed includes the section header.</span>
</span><span data-line="36"><span class="sd">    * If a section contains variable-length entries (rare in NKM), a custom</span>
</span><span data-line="37"><span class="sd">      parser should be used instead of relying on a fixed stride.</span>
</span><span data-line="38"><span class="sd">    * Many sections have fields where 0xFFFF or 0xFF indicates &quot;unused&quot; or</span>
</span><span data-line="39"><span class="sd">      &quot;none&quot; — callers should treat those sentinel values accordingly.</span>
</span><span data-line="40"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="41">
</span><span data-line="42">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span><span data-line="43">        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
</span><span data-line="44">        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">size</span><span class="p">)</span>
</span><span data-line="45">        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">size</span>
</span><span data-line="46">        <span class="c1"># Number of entries (UInt32 at offset 0x04 of the section header).</span>
</span><span data-line="47">        <span class="c1"># If `data` is not the whole section starting with the header, this</span>
</span><span data-line="48">        <span class="c1"># will be incorrect — ensure `data` includes the 8-byte section header.</span>
</span><span data-line="49">        <span class="bp">self</span><span class="o">.</span><span class="n">entry_count</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">)</span>
</span><span data-line="50">
</span><span data-line="51">    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="52">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_count</span>
</span><span data-line="53">
</span><span data-line="54">    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="55">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">:</span>
</span><span data-line="56">            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">]</span></div>

</span><span data-line="57">
</span><span data-line="58">
<div class="viewcode-block" id="OBJI">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.OBJI">[docs]</a>
</span><span data-line="59"><span class="k">class</span><span class="w"> </span><span class="nc">OBJI</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="60"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="61"><span class="sd">    OBJI — Object Instances section.</span>
</span><span data-line="62">
</span><span data-line="63"><span class="sd">    Stride: 0x3C bytes per entry.</span>
</span><span data-line="64">
</span><span data-line="65"><span class="sd">    Purpose</span>
</span><span data-line="66"><span class="sd">    -------</span>
</span><span data-line="67"><span class="sd">    Describes every object placed in the track: visual decorations, interactive</span>
</span><span data-line="68"><span class="sd">    objects, obstacle instances, item boxes, etc. These objects are instantiated</span>
</span><span data-line="69"><span class="sd">    by the game engine and can be linked to PATH routes.</span>
</span><span data-line="70">
</span><span data-line="71"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="72"><span class="sd">    -------------------</span>
</span><span data-line="73"><span class="sd">    0x00: Vector (VecFx32) — 3D position (X, Y, Z). Units are FX32 format.</span>
</span><span data-line="74"><span class="sd">    0x0C: Vector — 3D rotation vector (often treated as Euler-like or direction).</span>
</span><span data-line="75"><span class="sd">    0x18: Vector — 3D scale vector.</span>
</span><span data-line="76"><span class="sd">    0x24: UInt16 — Object ID (index into object database). Value selects the</span>
</span><span data-line="77"><span class="sd">                     model/behavior (see community object lists).</span>
</span><span data-line="78"><span class="sd">    0x26: UInt16 — Route ID (0xFFFF indicates &quot;no route&quot;).</span>
</span><span data-line="79"><span class="sd">    0x28..0x37: UInt32[4] — Object-specific settings (four 32-bit words). Their</span>
</span><span data-line="80"><span class="sd">                          meaning depends entirely on the object ID.</span>
</span><span data-line="81"><span class="sd">    0x38: UInt32 — Show in Time Trials flag (1 = visible, 0 = hidden).</span>
</span><span data-line="82">
</span><span data-line="83"><span class="sd">    Gameplay Context</span>
</span><span data-line="84"><span class="sd">    ----------------</span>
</span><span data-line="85"><span class="sd">    - The object ID decides both model and in some cases runtime logic (collision,</span>
</span><span data-line="86"><span class="sd">      activatable behaviors).</span>
</span><span data-line="87"><span class="sd">    - The route_id links the object to a PATH. If present, the object will be</span>
</span><span data-line="88"><span class="sd">      moved/animated by the PATH&#39;s POIT points at runtime (e.g., moving platforms,</span>
</span><span data-line="89"><span class="sd">      cameras).</span>
</span><span data-line="90"><span class="sd">    - The object settings are used by many object types to control behavior:</span>
</span><span data-line="91"><span class="sd">      rotation speed, spawn flags, timers, random seeds, or other per-object</span>
</span><span data-line="92"><span class="sd">      parameters. Different object IDs require different decoding logic.</span>
</span><span data-line="93">
</span><span data-line="94"><span class="sd">    Reverse-Engineering Notes / Tips</span>
</span><span data-line="95"><span class="sd">    --------------------------------</span>
</span><span data-line="96"><span class="sd">    - The four 32-bit settings differ radically between object types — community</span>
</span><span data-line="97"><span class="sd">      wikis often contain per-object decode rules (use object ID to branch).</span>
</span><span data-line="98"><span class="sd">    - The presence of a non-0 or non-0xFFFFFFFF route_id often means the object</span>
</span><span data-line="99"><span class="sd">      will be animated along that route; route indices are bytes in PATH entries</span>
</span><span data-line="100"><span class="sd">      but stored here as a 16-bit value (keep an eye on sign/width).</span>
</span><span data-line="101"><span class="sd">    - Show-in-time-trials: historically some editors used 0/1 inverse; verify</span>
</span><span data-line="102"><span class="sd">      against known tracks when in doubt.</span>
</span><span data-line="103">
</span><span data-line="104"><span class="sd">    Parsing Caveat</span>
</span><span data-line="105"><span class="sd">    --------------</span>
</span><span data-line="106"><span class="sd">    We read `object_id` as `read_u16` and `route_id` as `read_u16`. Consumers of</span>
</span><span data-line="107"><span class="sd">    this class should treat 0xFFFF in `route_id` as &quot;no route&quot;.</span>
</span><span data-line="108"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="109">
</span><span data-line="110">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="111">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">)</span>
</span><span data-line="112">        <span class="bp">self</span><span class="o">.</span><span class="n">rot_vec1</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="113">        <span class="bp">self</span><span class="o">.</span><span class="n">rot_vec2</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="114">        <span class="bp">self</span><span class="o">.</span><span class="n">scale_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="115">        <span class="bp">self</span><span class="o">.</span><span class="n">object_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="116">        <span class="bp">self</span><span class="o">.</span><span class="n">route_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="117">        <span class="bp">self</span><span class="o">.</span><span class="n">object_settings</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="118">            <span class="p">[</span><span class="n">read_u32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">)]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span>
</span><span data-line="119">        <span class="p">]</span>
</span><span data-line="120">        <span class="bp">self</span><span class="o">.</span><span class="n">show_in_time_trials</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="121">
</span><span data-line="122">
<div class="viewcode-block" id="PATH">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.PATH">[docs]</a>
</span><span data-line="123"><span class="k">class</span><span class="w"> </span><span class="nc">PATH</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="124"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="125"><span class="sd">    PATH — Path metadata.</span>
</span><span data-line="126">
</span><span data-line="127"><span class="sd">    Stride: 0x04 bytes per entry.</span>
</span><span data-line="128">
</span><span data-line="129"><span class="sd">    Purpose</span>
</span><span data-line="130"><span class="sd">    -------</span>
</span><span data-line="131"><span class="sd">    Describes metadata for routes used by objects and cameras. Each PATH entry</span>
</span><span data-line="132"><span class="sd">    points to a sequence of POIT entries (control points) that define the route.</span>
</span><span data-line="133">
</span><span data-line="134"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="135"><span class="sd">    -------------------</span>
</span><span data-line="136"><span class="sd">    0x00: Byte — Route ID.</span>
</span><span data-line="137"><span class="sd">    0x01: Byte — Loop flag (1 if the route loops, 0 otherwise).</span>
</span><span data-line="138"><span class="sd">    0x02: UInt16 — Number of points for the route (number of POIT entries).</span>
</span><span data-line="139">
</span><span data-line="140"><span class="sd">    Gameplay Context</span>
</span><span data-line="141"><span class="sd">    ----------------</span>
</span><span data-line="142"><span class="sd">    - Objects or cameras that reference a route will move along the POIT points</span>
</span><span data-line="143"><span class="sd">      in order; if the loop flag is set, the route repeats.</span>
</span><span data-line="144"><span class="sd">    - Route ID is commonly a small integer; the PATH list enumerates all routes</span>
</span><span data-line="145"><span class="sd">      in use on the track.</span>
</span><span data-line="146">
</span><span data-line="147"><span class="sd">    Reverse-Engineering Notes / Caveats</span>
</span><span data-line="148"><span class="sd">    ----------------------------------</span>
</span><span data-line="149"><span class="sd">    * The canonical spec states: 0x01 == 1 if the route loops, 0 otherwise.</span>
</span><span data-line="150"><span class="sd">      In the code you originally used `read_u8(d, 0x01) != 1` (which inverts</span>
</span><span data-line="151"><span class="sd">      the meaning). I have NOT altered your logic — but be aware of the</span>
</span><span data-line="152"><span class="sd">      discrepancy: callers should expect `True` when the route loops.</span>
</span><span data-line="153"><span class="sd">      Consider changing to `read_u8(... ) == 1` for clarity.</span>
</span><span data-line="154"><span class="sd">    * `point_count` enumerates POIT entries but the mapping from global POIT</span>
</span><span data-line="155"><span class="sd">      index to route is (index offset + length) — consumers should reconstruct</span>
</span><span data-line="156"><span class="sd">      the actual POIT index ranges using CPAT/EPAT/IPAT/MEPA grouping sections</span>
</span><span data-line="157"><span class="sd">      when applicable (these groupings partition points).</span>
</span><span data-line="158"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="159">
</span><span data-line="160">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="161">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">)</span>
</span><span data-line="162">        <span class="bp">self</span><span class="o">.</span><span class="n">route_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="163">        <span class="c1"># Warning: original code used inverted logic. The spec: 1 means loop.</span>
</span><span data-line="164">        <span class="c1"># We preserve original behavior here; consider flipping if you want literal.</span>
</span><span data-line="165">        <span class="bp">self</span><span class="o">.</span><span class="n">has_loop</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="166">        <span class="bp">self</span><span class="o">.</span><span class="n">point_count</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="167">
</span><span data-line="168">
<div class="viewcode-block" id="POIT">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.POIT">[docs]</a>
</span><span data-line="169"><span class="k">class</span><span class="w"> </span><span class="nc">POIT</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="170"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="171"><span class="sd">    POIT — Path points (control points).</span>
</span><span data-line="172">
</span><span data-line="173"><span class="sd">    Stride: 0x14 bytes per entry.</span>
</span><span data-line="174">
</span><span data-line="175"><span class="sd">    Purpose</span>
</span><span data-line="176"><span class="sd">    -------</span>
</span><span data-line="177"><span class="sd">    Stores the actual 3D points used by PATH routes. Points are grouped by route</span>
</span><span data-line="178"><span class="sd">    using the counts stored in PATH plus the various *PAT grouping sections.</span>
</span><span data-line="179">
</span><span data-line="180"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="181"><span class="sd">    -------------------</span>
</span><span data-line="182"><span class="sd">    0x00: Vector — 3D position (VecFx32).</span>
</span><span data-line="183"><span class="sd">    0x0C: Byte — Point index in the route (order index).</span>
</span><span data-line="184"><span class="sd">    0x0D: Byte — Unknown / padding.</span>
</span><span data-line="185"><span class="sd">    0x0E: Int16 — Point duration (signed). Not always used; may control timing</span>
</span><span data-line="186"><span class="sd">                   between points (for camera/object interpolation).</span>
</span><span data-line="187"><span class="sd">    0x10: UInt32 — Unknown (possibly reserved or flags).</span>
</span><span data-line="188">
</span><span data-line="189"><span class="sd">    Gameplay Context</span>
</span><span data-line="190"><span class="sd">    ----------------</span>
</span><span data-line="191"><span class="sd">    - Moving objects and cameras read these points sequentially to interpolate</span>
</span><span data-line="192"><span class="sd">      positions. The &quot;point_index&quot; normally indicates position in the route&#39;s</span>
</span><span data-line="193"><span class="sd">      ordering (0,1,2,...).</span>
</span><span data-line="194"><span class="sd">    - Some cameras or scripted objects use `point_duration` to wait between</span>
</span><span data-line="195"><span class="sd">      points, enabling non-linear motion.</span>
</span><span data-line="196"><span class="sd">    - POIT order in the file is important: group membership is often determined</span>
</span><span data-line="197"><span class="sd">      by successive ranges; use PAT sections to map ranges to specific routes.</span>
</span><span data-line="198">
</span><span data-line="199"><span class="sd">    Reverse-Engineering Notes</span>
</span><span data-line="200"><span class="sd">    -------------------------</span>
</span><span data-line="201"><span class="sd">    - The unknown fields often show consistent patterns per track editor —</span>
</span><span data-line="202"><span class="sd">      check community resources to decode them for special behaviors.</span>
</span><span data-line="203"><span class="sd">    - Some older track versions or beta files encode rotation differently; when</span>
</span><span data-line="204"><span class="sd">      in doubt, cross-check with KTPJ notes for version-dependent behavior.</span>
</span><span data-line="205"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="206">
</span><span data-line="207">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="208">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">)</span>
</span><span data-line="209">        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="210">        <span class="bp">self</span><span class="o">.</span><span class="n">point_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="211">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown1</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="212">        <span class="bp">self</span><span class="o">.</span><span class="n">point_duration</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_s16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="213">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown2</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="214">
</span><span data-line="215">
<div class="viewcode-block" id="STAG">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.STAG">[docs]</a>
</span><span data-line="216"><span class="k">class</span><span class="w"> </span><span class="nc">STAG</span><span class="p">:</span>
</span><span data-line="217"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="218"><span class="sd">    STAG — Stage (track) information.</span>
</span><span data-line="219">
</span><span data-line="220"><span class="sd">    Fixed-size: The STAG section is unique in NKM: it does NOT have a section</span>
</span><span data-line="221"><span class="sd">    header and is a single 0x2C-byte structure placed directly in the file</span>
</span><span data-line="222"><span class="sd">    (after POIT in the canonical header ordering).</span>
</span><span data-line="223">
</span><span data-line="224"><span class="sd">    Purpose</span>
</span><span data-line="225"><span class="sd">    -------</span>
</span><span data-line="226"><span class="sd">    Contains global track settings: track ID, default lap count, fog settings,</span>
</span><span data-line="227"><span class="sd">    colors used by KCL (collision visual palettes), and other miscellaneous bytes.</span>
</span><span data-line="228">
</span><span data-line="229"><span class="sd">    Offsets / Fields (STAG 0x00..0x2B)</span>
</span><span data-line="230"><span class="sd">    ---------------------------------</span>
</span><span data-line="231"><span class="sd">    0x00: String (4 bytes) — Section magic &quot;STAG&quot; (present in file).</span>
</span><span data-line="232"><span class="sd">    0x04: UInt16 — Track ID.</span>
</span><span data-line="233"><span class="sd">    0x06: UInt16 — Amount of laps.</span>
</span><span data-line="234"><span class="sd">    0x08: Byte — Unknown (seen set to small integers).</span>
</span><span data-line="235"><span class="sd">    0x09: Byte — Fog enabled (1 = enabled, 0 = disabled).</span>
</span><span data-line="236"><span class="sd">    0x0A: Byte — Fog table generation mode.</span>
</span><span data-line="237"><span class="sd">    0x0B: Byte — Fog slope.</span>
</span><span data-line="238"><span class="sd">    0x0C..0x13: Byte[8] — Unknown region (padding or extra flags).</span>
</span><span data-line="239"><span class="sd">    0x14: Fx32 — Fog distance (fixed-point).</span>
</span><span data-line="240"><span class="sd">    0x18: GXRgb — Fog color (not yet implemented).</span>
</span><span data-line="241"><span class="sd">    0x1A: UInt16 — Fog alpha (0..15 typical range).</span>
</span><span data-line="242"><span class="sd">    0x1C: GXRgb — KCL color 1.</span>
</span><span data-line="243"><span class="sd">    0x1E: GXRgb — KCL color 2.</span>
</span><span data-line="244"><span class="sd">    0x20: GXRgb — KCL color 3.</span>
</span><span data-line="245"><span class="sd">    0x22: GXRgb — KCL color 4.</span>
</span><span data-line="246"><span class="sd">    0x24..0x2B: Byte[8] — Another unknown block.</span>
</span><span data-line="247">
</span><span data-line="248"><span class="sd">    Gameplay Context</span>
</span><span data-line="249"><span class="sd">    ----------------</span>
</span><span data-line="250"><span class="sd">    - Amount of laps controls how many laps the race uses by default for the</span>
</span><span data-line="251"><span class="sd">      stage; some tracks use lap_count = 0 for special cases (verify per track).</span>
</span><span data-line="252"><span class="sd">    - Fog parameters influence rendering: enabling fog can hide distant objects</span>
</span><span data-line="253"><span class="sd">      and alter perceived depth; fog color &amp; distance control atmosphere.</span>
</span><span data-line="254"><span class="sd">    - KCL colors are the default palette for collision visualization (useful</span>
</span><span data-line="255"><span class="sd">      for editors and collision debugging).</span>
</span><span data-line="256">
</span><span data-line="257"><span class="sd">    Implementation Notes</span>
</span><span data-line="258"><span class="sd">    --------------------</span>
</span><span data-line="259"><span class="sd">    * This class sets placeholders for color fields (GXRgb) — you can implement</span>
</span><span data-line="260"><span class="sd">      `GXRgb` decoding (usually 2 bytes per color or platform-specific) and</span>
</span><span data-line="261"><span class="sd">      populate these fields for richer output.</span>
</span><span data-line="262"><span class="sd">    * The unknown arrays are repeated in code (unknown2 and unknown3) — that</span>
</span><span data-line="263"><span class="sd">      mirrors the spec layout but may be redundant; keep one copy or rename for</span>
</span><span data-line="264"><span class="sd">      clarity if desired.</span>
</span><span data-line="265"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="266">
</span><span data-line="267">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="268">        <span class="bp">self</span><span class="o">.</span><span class="n">track_id</span> <span class="o">=</span> <span class="n">read_u16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">)</span>
</span><span data-line="269">        <span class="bp">self</span><span class="o">.</span><span class="n">amt_of_laps</span> <span class="o">=</span> <span class="n">read_u16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">)</span>
</span><span data-line="270">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown1</span> <span class="o">=</span> <span class="n">read_u8</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">)</span>
</span><span data-line="271">        <span class="bp">self</span><span class="o">.</span><span class="n">fog_enabled</span> <span class="o">=</span> <span class="n">read_u8</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
</span><span data-line="272">        <span class="bp">self</span><span class="o">.</span><span class="n">fog_table_generation_mode</span> <span class="o">=</span> <span class="n">read_u8</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">)</span>
</span><span data-line="273">        <span class="bp">self</span><span class="o">.</span><span class="n">fog_slope</span> <span class="o">=</span> <span class="n">read_u8</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">)</span>
</span><span data-line="274">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown2</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x0C</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)]</span>
</span><span data-line="275">        <span class="bp">self</span><span class="o">.</span><span class="n">fog_distance</span> <span class="o">=</span> <span class="n">read_fx32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">)</span>
</span><span data-line="276">        <span class="bp">self</span><span class="o">.</span><span class="n">fog_color</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TODO: Implement GXRgb parsing &amp; set this.</span>
</span><span data-line="277">        <span class="bp">self</span><span class="o">.</span><span class="n">fog_alpha</span> <span class="o">=</span> <span class="n">read_u16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">)</span>
</span><span data-line="278">        <span class="bp">self</span><span class="o">.</span><span class="n">kcl_color1</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TODO: Implement GXRgb</span>
</span><span data-line="279">        <span class="bp">self</span><span class="o">.</span><span class="n">kcl_color2</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="280">        <span class="bp">self</span><span class="o">.</span><span class="n">kcl_color3</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="281">        <span class="bp">self</span><span class="o">.</span><span class="n">kcl_color4</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="282">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown3</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x0C</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)]</span></div>

</span><span data-line="283">
</span><span data-line="284">
<div class="viewcode-block" id="KTPS">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.KTPS">[docs]</a>
</span><span data-line="285"><span class="k">class</span><span class="w"> </span><span class="nc">KTPS</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="286"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="287"><span class="sd">    KTPS — Kart/Start Positions (Start points for racers).</span>
</span><span data-line="288">
</span><span data-line="289"><span class="sd">    Stride: 0x1C bytes per entry.</span>
</span><span data-line="290">
</span><span data-line="291"><span class="sd">    Purpose</span>
</span><span data-line="292"><span class="sd">    -------</span>
</span><span data-line="293"><span class="sd">    Defines start positions (spawn/starting grid) for players/racers. Typically</span>
</span><span data-line="294"><span class="sd">    used for the main race starts; can also be used in battle or mission modes.</span>
</span><span data-line="295">
</span><span data-line="296"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="297"><span class="sd">    -------------------</span>
</span><span data-line="298"><span class="sd">    0x00: Vector — 3D position (VecFx32) for the starting spawn.</span>
</span><span data-line="299"><span class="sd">    0x0C: Vector — 3D rotation vector (direction the racer initially faces).</span>
</span><span data-line="300"><span class="sd">    0x18: UInt16 — Padding (usually 0xFFFF).</span>
</span><span data-line="301"><span class="sd">    0x1A: UInt16 — Start position index (used in battle/mission mode; 0xFFFF</span>
</span><span data-line="302"><span class="sd">                       for normal race courses).</span>
</span><span data-line="303">
</span><span data-line="304"><span class="sd">    Gameplay Context</span>
</span><span data-line="305"><span class="sd">    ----------------</span>
</span><span data-line="306"><span class="sd">    - On race start, the game picks starting positions from this section.</span>
</span><span data-line="307"><span class="sd">    - `start_position_index` is relevant for battle stages or mission mode where</span>
</span><span data-line="308"><span class="sd">      start ordering differs from main racing.</span>
</span><span data-line="309"><span class="sd">    - The rotation vector might be stored differently in beta versions — the</span>
</span><span data-line="310"><span class="sd">      canonical community notes indicate the Y-rotation sometimes needs to be</span>
</span><span data-line="311"><span class="sd">      computed via Atan2 on rotation vector components for older versions.</span>
</span><span data-line="312">
</span><span data-line="313"><span class="sd">    Notes / Community Tips</span>
</span><span data-line="314"><span class="sd">    ----------------------</span>
</span><span data-line="315"><span class="sd">    - Typically the number of KTPS entries equals the number of players or more</span>
</span><span data-line="316"><span class="sd">      (some tracks list more possible starts than vehicles).</span>
</span><span data-line="317"><span class="sd">    - If you want to reposition start locations, modify positions and write the</span>
</span><span data-line="318"><span class="sd">      file back in FX32 format.</span>
</span><span data-line="319"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="320">
</span><span data-line="321">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="322">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">)</span>
</span><span data-line="323">        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="324">        <span class="bp">self</span><span class="o">.</span><span class="n">rot_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="325">        <span class="bp">self</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="326">        <span class="bp">self</span><span class="o">.</span><span class="n">start_position_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="327">
</span><span data-line="328">
<div class="viewcode-block" id="KTPJ">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.KTPJ">[docs]</a>
</span><span data-line="329"><span class="k">class</span><span class="w"> </span><span class="nc">KTPJ</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="330"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="331"><span class="sd">    KTPJ — Respawn positions (kart respawn).</span>
</span><span data-line="332">
</span><span data-line="333"><span class="sd">    Stride: 0x20 bytes per entry.</span>
</span><span data-line="334">
</span><span data-line="335"><span class="sd">    Purpose</span>
</span><span data-line="336"><span class="sd">    -------</span>
</span><span data-line="337"><span class="sd">    Positions to which a kart (player) can respawn after falling off or during</span>
</span><span data-line="338"><span class="sd">    certain scripted events. Contains references to enemy/item points (EPOI/IPOI)</span>
</span><span data-line="339"><span class="sd">    to determine nearby behavior or AI context.</span>
</span><span data-line="340">
</span><span data-line="341"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="342"><span class="sd">    -------------------</span>
</span><span data-line="343"><span class="sd">    0x00: Vector — 3D position vector.</span>
</span><span data-line="344"><span class="sd">    0x0C: Vector — 3D rotation vector.</span>
</span><span data-line="345"><span class="sd">    0x18: UInt16 — Enemy position ID (EPOI index).</span>
</span><span data-line="346"><span class="sd">    0x1A: UInt16 — Item position ID (IPOI index).</span>
</span><span data-line="347"><span class="sd">    0x1C: UInt32 — Respawn ID (not present in the oldest beta versions).</span>
</span><span data-line="348">
</span><span data-line="349"><span class="sd">    Gameplay Context</span>
</span><span data-line="350"><span class="sd">    ----------------</span>
</span><span data-line="351"><span class="sd">    - When a kart falls off the track or hits a severe collision, the engine</span>
</span><span data-line="352"><span class="sd">      picks a KTPJ respawn that matches the current lap and nearby conditions.</span>
</span><span data-line="353"><span class="sd">    - The enemy/item IDs let respawn logic pick nearby AI/item spawn points for</span>
</span><span data-line="354"><span class="sd">      smoother reintroduction.</span>
</span><span data-line="355">
</span><span data-line="356"><span class="sd">    Version Notes</span>
</span><span data-line="357"><span class="sd">    -------------</span>
</span><span data-line="358"><span class="sd">    - For version 0x1E (older beta), the final Respawn ID (0x1C) may not exist.</span>
</span><span data-line="359"><span class="sd">    - The rotation encoding changed for early beta versions; if reading older</span>
</span><span data-line="360"><span class="sd">      tracks, compute Y-rotation via atan2(Rx, Rz) to convert to degrees.</span>
</span><span data-line="361">
</span><span data-line="362"><span class="sd">    Remarks for Parser</span>
</span><span data-line="363"><span class="sd">    ------------------</span>
</span><span data-line="364"><span class="sd">    * We read `respawn_id` as a 32-bit value; if parsing older tracks that omit</span>
</span><span data-line="365"><span class="sd">      it, ensure you guard read beyond section length.</span>
</span><span data-line="366"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="367">
</span><span data-line="368">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="369">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span>
</span><span data-line="370">        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="371">        <span class="bp">self</span><span class="o">.</span><span class="n">rot_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="372">        <span class="bp">self</span><span class="o">.</span><span class="n">enemy_position_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>  <span class="c1"># EPOI reference</span>
</span><span data-line="373">        <span class="bp">self</span><span class="o">.</span><span class="n">item_position_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>  <span class="c1"># IPOI reference</span>
</span><span data-line="374">        <span class="c1"># Respawn ID may not exist in very old versions; this read assumes it does.</span>
</span><span data-line="375">        <span class="bp">self</span><span class="o">.</span><span class="n">respawn_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="376">
</span><span data-line="377">
<div class="viewcode-block" id="KTP2">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.KTP2">[docs]</a>
</span><span data-line="378"><span class="k">class</span><span class="w"> </span><span class="nc">KTP2</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="379"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="380"><span class="sd">    KTP2 — Lap checkpoints (points to pass to count lap progress).</span>
</span><span data-line="381">
</span><span data-line="382"><span class="sd">    Stride: 0x1C bytes per entry.</span>
</span><span data-line="383">
</span><span data-line="384"><span class="sd">    Purpose</span>
</span><span data-line="385"><span class="sd">    -------</span>
</span><span data-line="386"><span class="sd">    Defines the &quot;lap gate&quot; points that the engine checks to determine whether a</span>
</span><span data-line="387"><span class="sd">    player completed a lap. Usually combined with timing/ordering checks.</span>
</span><span data-line="388">
</span><span data-line="389"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="390"><span class="sd">    -------------------</span>
</span><span data-line="391"><span class="sd">    0x00: Vector — 3D position vector.</span>
</span><span data-line="392"><span class="sd">    0x0C: Vector — 3D rotation vector.</span>
</span><span data-line="393"><span class="sd">    0x18: UInt16 — Padding (0xFFFF).</span>
</span><span data-line="394"><span class="sd">    0x1A: UInt16 — Index (commonly 0xFFFF).</span>
</span><span data-line="395">
</span><span data-line="396"><span class="sd">    Gameplay Context</span>
</span><span data-line="397"><span class="sd">    ----------------</span>
</span><span data-line="398"><span class="sd">    - The race logic queries these points as canonical lap markers.</span>
</span><span data-line="399"><span class="sd">    - Often unused fields are set to 0xFFFF; do not treat them as valid indices.</span>
</span><span data-line="400">
</span><span data-line="401"><span class="sd">    Notes</span>
</span><span data-line="402"><span class="sd">    -----</span>
</span><span data-line="403"><span class="sd">    - The &quot;Index&quot; is usually unused (set to 0xFFFF); if present, it may</span>
</span><span data-line="404"><span class="sd">      participate in specialized lap logic or developer tools.</span>
</span><span data-line="405"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="406">
</span><span data-line="407">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="408">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">)</span>
</span><span data-line="409">        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="410">        <span class="bp">self</span><span class="o">.</span><span class="n">rot_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="411">        <span class="bp">self</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="412">        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="413">
</span><span data-line="414">
<div class="viewcode-block" id="KTPC">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.KTPC">[docs]</a>
</span><span data-line="415"><span class="k">class</span><span class="w"> </span><span class="nc">KTPC</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="416"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="417"><span class="sd">    KTPC — Cannon / Pipe destination points.</span>
</span><span data-line="418">
</span><span data-line="419"><span class="sd">    Stride: 0x1C bytes per entry.</span>
</span><span data-line="420">
</span><span data-line="421"><span class="sd">    Purpose</span>
</span><span data-line="422"><span class="sd">    -------</span>
</span><span data-line="423"><span class="sd">    Describes destinations for cannons/pipes used in certain stages (mostly</span>
</span><span data-line="424"><span class="sd">    in battle stages). Cannon indices are used by specialized collision types.</span>
</span><span data-line="425">
</span><span data-line="426"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="427"><span class="sd">    -------------------</span>
</span><span data-line="428"><span class="sd">    0x00: Vector — 3D position vector (destination).</span>
</span><span data-line="429"><span class="sd">    0x0C: Vector — 3D rotation vector.</span>
</span><span data-line="430"><span class="sd">    0x18: UInt16 — Unknown field (investigate for specific behaviors).</span>
</span><span data-line="431"><span class="sd">    0x1A: UInt16 — Cannon index (used by &#39;Cannon Activator&#39; collision types).</span>
</span><span data-line="432">
</span><span data-line="433"><span class="sd">    Gameplay Context</span>
</span><span data-line="434"><span class="sd">    ----------------</span>
</span><span data-line="435"><span class="sd">    - Cannon/pipe logic teleports an object/player to the KTPC destination.</span>
</span><span data-line="436"><span class="sd">    - The cannon_index can be used as a link between activator and destination.</span>
</span><span data-line="437">
</span><span data-line="438"><span class="sd">    Notes</span>
</span><span data-line="439"><span class="sd">    -----</span>
</span><span data-line="440"><span class="sd">    - In many tracks this section is small or absent; treat missing sections</span>
</span><span data-line="441"><span class="sd">      gracefully when writing tools that modify KTPC entries.</span>
</span><span data-line="442"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="443">
</span><span data-line="444">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="445">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">)</span>
</span><span data-line="446">        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="447">        <span class="bp">self</span><span class="o">.</span><span class="n">rot_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="448">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="449">        <span class="bp">self</span><span class="o">.</span><span class="n">cannon_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="450">
</span><span data-line="451">
<div class="viewcode-block" id="KTPM">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.KTPM">[docs]</a>
</span><span data-line="452"><span class="k">class</span><span class="w"> </span><span class="nc">KTPM</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="453"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="454"><span class="sd">    KTPM — Mission points.</span>
</span><span data-line="455">
</span><span data-line="456"><span class="sd">    Stride: 0x1C bytes per entry.</span>
</span><span data-line="457">
</span><span data-line="458"><span class="sd">    Purpose</span>
</span><span data-line="459"><span class="sd">    -------</span>
</span><span data-line="460"><span class="sd">    Points used by mission objectives (mission mode). They often resemble</span>
</span><span data-line="461"><span class="sd">    KTPS/KTP2 entries but have mission-specific indexing.</span>
</span><span data-line="462">
</span><span data-line="463"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="464"><span class="sd">    -------------------</span>
</span><span data-line="465"><span class="sd">    0x00: Vector — 3D position vector.</span>
</span><span data-line="466"><span class="sd">    0x0C: Vector — 3D rotation vector.</span>
</span><span data-line="467"><span class="sd">    0x18: UInt16 — Padding (0xFFFF).</span>
</span><span data-line="468"><span class="sd">    0x1A: UInt16 — Index (used to map to mission logic).</span>
</span><span data-line="469">
</span><span data-line="470"><span class="sd">    Gameplay Context</span>
</span><span data-line="471"><span class="sd">    ----------------</span>
</span><span data-line="472"><span class="sd">    - Missions may use these points to define target positions or spawns.</span>
</span><span data-line="473"><span class="sd">    - `index` can be used in mission scripts to select a specific point</span>
</span><span data-line="474"><span class="sd">      out of the KTPM array.</span>
</span><span data-line="475">
</span><span data-line="476"><span class="sd">    Notes</span>
</span><span data-line="477"><span class="sd">    -----</span>
</span><span data-line="478"><span class="sd">    - If the track is not a mission type, these often default to 0xFFFF.</span>
</span><span data-line="479"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="480">
</span><span data-line="481">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="482">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">)</span>
</span><span data-line="483">        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="484">        <span class="bp">self</span><span class="o">.</span><span class="n">rot_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="485">        <span class="bp">self</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="486">        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="487">
</span><span data-line="488">
<div class="viewcode-block" id="CPOI">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.CPOI">[docs]</a>
</span><span data-line="489"><span class="k">class</span><span class="w"> </span><span class="nc">CPOI</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="490"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="491"><span class="sd">    CPOI — Checkpoints (2D oriented).</span>
</span><span data-line="492">
</span><span data-line="493"><span class="sd">    Stride: 0x24 bytes per entry.</span>
</span><span data-line="494">
</span><span data-line="495"><span class="sd">    Purpose</span>
</span><span data-line="496"><span class="sd">    -------</span>
</span><span data-line="497"><span class="sd">    Defines checkpoint segments used for lap counting, key handling, and</span>
</span><span data-line="498"><span class="sd">    respawn logic. CPOI includes two 2D positions and precomputed trig/distance</span>
</span><span data-line="499"><span class="sd">    values used by the engine to determine crossing and checkpoint ordering.</span>
</span><span data-line="500">
</span><span data-line="501"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="502"><span class="sd">    -------------------</span>
</span><span data-line="503"><span class="sd">    0x00: Vector2D — Position 1 (VecFx32 2D).</span>
</span><span data-line="504"><span class="sd">    0x08: Vector2D — Position 2 (VecFx32 2D) — typically the other edge of checkpoint.</span>
</span><span data-line="505"><span class="sd">    0x10: Fx32 — Precomputed sinus (used for orientation math).</span>
</span><span data-line="506"><span class="sd">    0x14: Fx32 — Precomputed cosinus.</span>
</span><span data-line="507"><span class="sd">    0x18: Fx32 — Distance between position1 and position2 (checkpoint length).</span>
</span><span data-line="508"><span class="sd">    0x1C: Int16 — Section data 1 (unknown; may encode connectivity).</span>
</span><span data-line="509"><span class="sd">    0x1E: Int16 — Section data 2 (unknown).</span>
</span><span data-line="510"><span class="sd">    0x20: UInt16 — Key ID:</span>
</span><span data-line="511"><span class="sd">             0x0000 = lap counter,</span>
</span><span data-line="512"><span class="sd">             0x0001..0xFFFE = keyed checkpoint,</span>
</span><span data-line="513"><span class="sd">             0xFFFF = no key.</span>
</span><span data-line="514"><span class="sd">    0x22: Byte — Respawn ID.</span>
</span><span data-line="515"><span class="sd">    0x23: Byte — Unknown/padding.</span>
</span><span data-line="516">
</span><span data-line="517"><span class="sd">    Gameplay Context</span>
</span><span data-line="518"><span class="sd">    ----------------</span>
</span><span data-line="519"><span class="sd">    - CPOIs are the canonical gate the engine checks for lap progress.</span>
</span><span data-line="520"><span class="sd">    - The Key ID allows some checkpoints to behave as keys (for gates, or race</span>
</span><span data-line="521"><span class="sd">      logic). If Key ID == 0x0000 the point counts as the lap marker.</span>
</span><span data-line="522"><span class="sd">    - The precomputed sinus/cosinus/distance allow the engine to quickly test</span>
</span><span data-line="523"><span class="sd">      whether a player crossed the checkpoint along the correct orientation.</span>
</span><span data-line="524">
</span><span data-line="525"><span class="sd">    Reverse-Engineering Notes</span>
</span><span data-line="526"><span class="sd">    -------------------------</span>
</span><span data-line="527"><span class="sd">    - Community docs note the `section_data` fields are partially decoded for</span>
</span><span data-line="528"><span class="sd">      special track logic. If you need precise behavior, compare original</span>
</span><span data-line="529"><span class="sd">      tracks and observe in-engine behavior.</span>
</span><span data-line="530"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="531">
</span><span data-line="532">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="533">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">)</span>
</span><span data-line="534">        <span class="bp">self</span><span class="o">.</span><span class="n">position1</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_2d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="535">        <span class="bp">self</span><span class="o">.</span><span class="n">position2</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_2d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="536">        <span class="bp">self</span><span class="o">.</span><span class="n">sinus</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="537">        <span class="bp">self</span><span class="o">.</span><span class="n">cosinus</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="538">        <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="539">        <span class="bp">self</span><span class="o">.</span><span class="n">section_data1</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="540">        <span class="bp">self</span><span class="o">.</span><span class="n">section_data2</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="541">        <span class="bp">self</span><span class="o">.</span><span class="n">key_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="542">        <span class="bp">self</span><span class="o">.</span><span class="n">respawn_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="543">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="544">
</span><span data-line="545">
<div class="viewcode-block" id="CPAT">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.CPAT">[docs]</a>
</span><span data-line="546"><span class="k">class</span><span class="w"> </span><span class="nc">CPAT</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="547"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="548"><span class="sd">    CPAT — CPOI grouping (checkpoint groups).</span>
</span><span data-line="549">
</span><span data-line="550"><span class="sd">    Stride: 0x0C bytes per entry.</span>
</span><span data-line="551">
</span><span data-line="552"><span class="sd">    Purpose</span>
</span><span data-line="553"><span class="sd">    -------</span>
</span><span data-line="554"><span class="sd">    Groups CPOI entries into logical sequences (routes/sections). Each CPAT</span>
</span><span data-line="555"><span class="sd">    entry points to a contiguous block of CPOI points and describes adjacency</span>
</span><span data-line="556"><span class="sd">    (previous/next groups) and section order.</span>
</span><span data-line="557">
</span><span data-line="558"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="559"><span class="sd">    -------------------</span>
</span><span data-line="560"><span class="sd">    0x00: UInt16 — Point start index into global CPOI array.</span>
</span><span data-line="561"><span class="sd">    0x02: UInt16 — Point length (number of CPOI points).</span>
</span><span data-line="562"><span class="sd">    0x04..0x06: Byte[3] — Next group indices (up to 3). 0xFF = unused.</span>
</span><span data-line="563"><span class="sd">    0x07..0x09: Byte[3] — Previous group indices (up to 3). 0xFF = unused.</span>
</span><span data-line="564"><span class="sd">    0x0A: Int16 — Section order (signed; determines ordering among groups).</span>
</span><span data-line="565">
</span><span data-line="566"><span class="sd">    Gameplay Context</span>
</span><span data-line="567"><span class="sd">    ----------------</span>
</span><span data-line="568"><span class="sd">    - CPAT allows complex checkpoint graphs (non-linear courses) by connecting</span>
</span><span data-line="569"><span class="sd">      multiple CPOI groups.</span>
</span><span data-line="570"><span class="sd">    - Useful when a single lap uses multiple discontiguous checkpoint regions.</span>
</span><span data-line="571">
</span><span data-line="572"><span class="sd">    Implementation Notes</span>
</span><span data-line="573"><span class="sd">    --------------------</span>
</span><span data-line="574"><span class="sd">    - The `next_group` and `prev_group` arrays use 0xFF as &quot;unused&quot;; treat</span>
</span><span data-line="575"><span class="sd">      sentinel values accordingly.</span>
</span><span data-line="576"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="577">
</span><span data-line="578">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="579">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span>
</span><span data-line="580">        <span class="bp">self</span><span class="o">.</span><span class="n">point_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="581">        <span class="bp">self</span><span class="o">.</span><span class="n">point_length</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="582">        <span class="bp">self</span><span class="o">.</span><span class="n">next_group</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="583">            <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span>
</span><span data-line="584">        <span class="p">]</span>
</span><span data-line="585">        <span class="bp">self</span><span class="o">.</span><span class="n">prev_group</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="586">            <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span>
</span><span data-line="587">        <span class="p">]</span>
</span><span data-line="588">        <span class="bp">self</span><span class="o">.</span><span class="n">section_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_s16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="589">
</span><span data-line="590">
<div class="viewcode-block" id="IPOI">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.IPOI">[docs]</a>
</span><span data-line="591"><span class="k">class</span><span class="w"> </span><span class="nc">IPOI</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="592"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="593"><span class="sd">    IPOI — Item spawn points.</span>
</span><span data-line="594">
</span><span data-line="595"><span class="sd">    Stride: 0x14 bytes per entry.</span>
</span><span data-line="596">
</span><span data-line="597"><span class="sd">    Purpose</span>
</span><span data-line="598"><span class="sd">    -------</span>
</span><span data-line="599"><span class="sd">    Describes where items (like red shells, bananas) may spawn or where items</span>
</span><span data-line="600"><span class="sd">    follow a path along a route. IPOI entries are often referenced by KTPJ</span>
</span><span data-line="601"><span class="sd">    (respawn) or object logic.</span>
</span><span data-line="602">
</span><span data-line="603"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="604"><span class="sd">    -------------------</span>
</span><span data-line="605"><span class="sd">    0x00: Vector — 3D position vector.</span>
</span><span data-line="606"><span class="sd">    0x0C: Fx32 — Point scale (fixed point value, used for size or weighting).</span>
</span><span data-line="607"><span class="sd">    0x10: UInt32 — Unknown; reserved or object-specific.</span>
</span><span data-line="608">
</span><span data-line="609"><span class="sd">    Gameplay Context</span>
</span><span data-line="610"><span class="sd">    ----------------</span>
</span><span data-line="611"><span class="sd">    - Items may spawn at IPOI locations or be used for scripted item routes.</span>
</span><span data-line="612"><span class="sd">    - `point_scale` may modify spawn probability or area radius.</span>
</span><span data-line="613">
</span><span data-line="614"><span class="sd">    Notes</span>
</span><span data-line="615"><span class="sd">    -----</span>
</span><span data-line="616"><span class="sd">    - The unknown 32-bit value is often zero; it may contain bitflags in</span>
</span><span data-line="617"><span class="sd">      certain custom tracks.</span>
</span><span data-line="618"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="619">
</span><span data-line="620">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="621">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">)</span>
</span><span data-line="622">        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="623">        <span class="bp">self</span><span class="o">.</span><span class="n">point_scale</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="624">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="625">
</span><span data-line="626">
<div class="viewcode-block" id="IPAT">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.IPAT">[docs]</a>
</span><span data-line="627"><span class="k">class</span><span class="w"> </span><span class="nc">IPAT</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="628"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="629"><span class="sd">    IPAT — IPOI grouping.</span>
</span><span data-line="630">
</span><span data-line="631"><span class="sd">    Stride: 0x0C bytes per entry.</span>
</span><span data-line="632">
</span><span data-line="633"><span class="sd">    Purpose</span>
</span><span data-line="634"><span class="sd">    -------</span>
</span><span data-line="635"><span class="sd">    Group IPOI entries into contiguous point ranges and define adjacency, much</span>
</span><span data-line="636"><span class="sd">    like CPAT but for item points.</span>
</span><span data-line="637">
</span><span data-line="638"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="639"><span class="sd">    -------------------</span>
</span><span data-line="640"><span class="sd">    0x00: UInt16 — Point start index into IPOI array.</span>
</span><span data-line="641"><span class="sd">    0x02: UInt16 — Point length.</span>
</span><span data-line="642"><span class="sd">    0x04..0x06: Byte[3] — Next group indices (0xFF unused).</span>
</span><span data-line="643"><span class="sd">    0x07..0x09: Byte[3] — Previous group indices (0xFF unused).</span>
</span><span data-line="644"><span class="sd">    0x0A: Int16 — Section order.</span>
</span><span data-line="645">
</span><span data-line="646"><span class="sd">    Gameplay Context</span>
</span><span data-line="647"><span class="sd">    ----------------</span>
</span><span data-line="648"><span class="sd">    - Used by item routing and by respawn selection to find nearby item points.</span>
</span><span data-line="649"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="650">
</span><span data-line="651">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="652">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span>
</span><span data-line="653">        <span class="bp">self</span><span class="o">.</span><span class="n">point_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="654">        <span class="bp">self</span><span class="o">.</span><span class="n">point_length</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="655">        <span class="bp">self</span><span class="o">.</span><span class="n">next_group</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="656">            <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span>
</span><span data-line="657">        <span class="p">]</span>
</span><span data-line="658">        <span class="bp">self</span><span class="o">.</span><span class="n">prev_group</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="659">            <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span>
</span><span data-line="660">        <span class="p">]</span>
</span><span data-line="661">        <span class="bp">self</span><span class="o">.</span><span class="n">section_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_s16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="662">
</span><span data-line="663">
<div class="viewcode-block" id="EPOI">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.EPOI">[docs]</a>
</span><span data-line="664"><span class="k">class</span><span class="w"> </span><span class="nc">EPOI</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="665"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="666"><span class="sd">    EPOI — Enemy/CPU path points.</span>
</span><span data-line="667">
</span><span data-line="668"><span class="sd">    Stride: 0x18 bytes per entry.</span>
</span><span data-line="669">
</span><span data-line="670"><span class="sd">    Purpose</span>
</span><span data-line="671"><span class="sd">    -------</span>
</span><span data-line="672"><span class="sd">    Defines points that the CPU opponents use for their routing (AI paths).</span>
</span><span data-line="673"><span class="sd">    These influence how CPUs drive the course (lines, drifting behavior, etc).</span>
</span><span data-line="674">
</span><span data-line="675"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="676"><span class="sd">    -------------------</span>
</span><span data-line="677"><span class="sd">    0x00: Vector — 3D position vector.</span>
</span><span data-line="678"><span class="sd">    0x0C: Fx32 — Point scale (used for weight or radius).</span>
</span><span data-line="679"><span class="sd">    0x10: Int16 — Drifting parameter (signed).</span>
</span><span data-line="680"><span class="sd">    0x12: UInt16 — Unknown (padding/flags).</span>
</span><span data-line="681"><span class="sd">    0x14: UInt32 — Unknown (engine-specific metadata).</span>
</span><span data-line="682">
</span><span data-line="683"><span class="sd">    Gameplay Context</span>
</span><span data-line="684"><span class="sd">    ----------------</span>
</span><span data-line="685"><span class="sd">    - CPU behavior heavily depends on EPOI positions and the drifting</span>
</span><span data-line="686"><span class="sd">      parameter — altering these can change how tight/loose CPUs corner.</span>
</span><span data-line="687"><span class="sd">    - EPOI groups are linked via EPAT entries (below).</span>
</span><span data-line="688">
</span><span data-line="689"><span class="sd">    Notes</span>
</span><span data-line="690"><span class="sd">    -----</span>
</span><span data-line="691"><span class="sd">    - The meaning of the 0x14 32-bit word is partially unknown in community</span>
</span><span data-line="692"><span class="sd">      docs; experiments suggest it can contain flags for AI behavior.</span>
</span><span data-line="693"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="694">
</span><span data-line="695">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="696">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span>
</span><span data-line="697">        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="698">        <span class="bp">self</span><span class="o">.</span><span class="n">point_scale</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="699">        <span class="bp">self</span><span class="o">.</span><span class="n">drifting</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="700">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown1</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="701">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown2</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="702">
</span><span data-line="703">
<div class="viewcode-block" id="EPAT">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.EPAT">[docs]</a>
</span><span data-line="704"><span class="k">class</span><span class="w"> </span><span class="nc">EPAT</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="705"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="706"><span class="sd">    EPAT — EPOI grouping.</span>
</span><span data-line="707">
</span><span data-line="708"><span class="sd">    Stride: 0x0C bytes per entry.</span>
</span><span data-line="709">
</span><span data-line="710"><span class="sd">    Purpose</span>
</span><span data-line="711"><span class="sd">    -------</span>
</span><span data-line="712"><span class="sd">    Groups EPOI points into contiguous blocks and defines adjacency (next/prev</span>
</span><span data-line="713"><span class="sd">    groups) and section ordering. Used by CPU pathing code to navigate routes.</span>
</span><span data-line="714">
</span><span data-line="715"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="716"><span class="sd">    -------------------</span>
</span><span data-line="717"><span class="sd">    0x00: UInt16 — Point start into EPOI array.</span>
</span><span data-line="718"><span class="sd">    0x02: UInt16 — Point length.</span>
</span><span data-line="719"><span class="sd">    0x04..0x06: Byte[3] — Next groups (0xFF unused).</span>
</span><span data-line="720"><span class="sd">    0x07..0x09: Byte[3] — Previous groups (0xFF unused).</span>
</span><span data-line="721"><span class="sd">    0x0A: Int16 — Section order.</span>
</span><span data-line="722">
</span><span data-line="723"><span class="sd">    Gameplay Context</span>
</span><span data-line="724"><span class="sd">    ----------------</span>
</span><span data-line="725"><span class="sd">    - EPAT partitions EPOI arrays into logical AI routes; enabling multiple</span>
</span><span data-line="726"><span class="sd">      CPU strategies per segment.</span>
</span><span data-line="727"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="728">
</span><span data-line="729">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="730">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span>
</span><span data-line="731">        <span class="bp">self</span><span class="o">.</span><span class="n">point_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="732">        <span class="bp">self</span><span class="o">.</span><span class="n">point_length</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="733">        <span class="bp">self</span><span class="o">.</span><span class="n">next_group</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="734">            <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span>
</span><span data-line="735">        <span class="p">]</span>
</span><span data-line="736">        <span class="bp">self</span><span class="o">.</span><span class="n">prev_group</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="737">            <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span>
</span><span data-line="738">        <span class="p">]</span>
</span><span data-line="739">        <span class="bp">self</span><span class="o">.</span><span class="n">section_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_s16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="740">
</span><span data-line="741">
<div class="viewcode-block" id="MEPO">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.MEPO">[docs]</a>
</span><span data-line="742"><span class="k">class</span><span class="w"> </span><span class="nc">MEPO</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="743"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="744"><span class="sd">    MEPO — Mini-game enemy points.</span>
</span><span data-line="745">
</span><span data-line="746"><span class="sd">    Stride: 0x18 bytes per entry.</span>
</span><span data-line="747">
</span><span data-line="748"><span class="sd">    Purpose</span>
</span><span data-line="749"><span class="sd">    -------</span>
</span><span data-line="750"><span class="sd">    Similar to EPOI but used by specific mini-games; describes where minigame</span>
</span><span data-line="751"><span class="sd">    entities spawn/move.</span>
</span><span data-line="752">
</span><span data-line="753"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="754"><span class="sd">    -------------------</span>
</span><span data-line="755"><span class="sd">    0x00: Vector — 3D position.</span>
</span><span data-line="756"><span class="sd">    0x0C: Fx32 — Point scale.</span>
</span><span data-line="757"><span class="sd">    0x10: Int32 — Drifting (signed; larger type vs EPOI).</span>
</span><span data-line="758"><span class="sd">    0x14: UInt32 — Unknown.</span>
</span><span data-line="759">
</span><span data-line="760"><span class="sd">    Gameplay Context</span>
</span><span data-line="761"><span class="sd">    ----------------</span>
</span><span data-line="762"><span class="sd">    - MEPO entries are used only in special mini-game contexts and may allow</span>
</span><span data-line="763"><span class="sd">      more variety (hence Int32 for drifting).</span>
</span><span data-line="764"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="765">
</span><span data-line="766">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="767">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span>
</span><span data-line="768">        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="769">        <span class="bp">self</span><span class="o">.</span><span class="n">point_scale</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="770">        <span class="bp">self</span><span class="o">.</span><span class="n">drifting</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="771">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="772">
</span><span data-line="773">
<div class="viewcode-block" id="MEPA">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.MEPA">[docs]</a>
</span><span data-line="774"><span class="k">class</span><span class="w"> </span><span class="nc">MEPA</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="775"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="776"><span class="sd">    MEPA — MEPO grouping (for mini-games).</span>
</span><span data-line="777">
</span><span data-line="778"><span class="sd">    Stride: 0x14 bytes per entry.</span>
</span><span data-line="779">
</span><span data-line="780"><span class="sd">    Purpose</span>
</span><span data-line="781"><span class="sd">    -------</span>
</span><span data-line="782"><span class="sd">    Groups MEPO points into sequences. MEPA entries support up to 8 next and</span>
</span><span data-line="783"><span class="sd">    8 previous groups (Byte[8]) because mini-games may have richer topology.</span>
</span><span data-line="784">
</span><span data-line="785"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="786"><span class="sd">    -------------------</span>
</span><span data-line="787"><span class="sd">    0x00: UInt16 — Point start index into MEPO array.</span>
</span><span data-line="788"><span class="sd">    0x02: UInt16 — Point length.</span>
</span><span data-line="789"><span class="sd">    0x04..0x0B: Byte[8] — Next group indices (0xFF unused).</span>
</span><span data-line="790"><span class="sd">    0x0C..0x13: Byte[8] — Previous group indices (0xFF unused).</span>
</span><span data-line="791">
</span><span data-line="792"><span class="sd">    Gameplay Context</span>
</span><span data-line="793"><span class="sd">    ----------------</span>
</span><span data-line="794"><span class="sd">    - Use MEPA to create complex mini-game movement graphs (multiple branching).</span>
</span><span data-line="795"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="796">
</span><span data-line="797">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="798">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">)</span>
</span><span data-line="799">        <span class="bp">self</span><span class="o">.</span><span class="n">point_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="800">        <span class="bp">self</span><span class="o">.</span><span class="n">point_length</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="801">        <span class="bp">self</span><span class="o">.</span><span class="n">next_group</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="802">            <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span>
</span><span data-line="803">        <span class="p">]</span>
</span><span data-line="804">        <span class="bp">self</span><span class="o">.</span><span class="n">prev_group</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="805">            <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span>
</span><span data-line="806">        <span class="p">]</span></div>

</span><span data-line="807">
</span><span data-line="808">
<div class="viewcode-block" id="AREA">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.AREA">[docs]</a>
</span><span data-line="809"><span class="k">class</span><span class="w"> </span><span class="nc">AREA</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="810"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="811"><span class="sd">    AREA — Camera/zone areas.</span>
</span><span data-line="812">
</span><span data-line="813"><span class="sd">    Stride: 0x48 bytes per entry.</span>
</span><span data-line="814">
</span><span data-line="815"><span class="sd">    Purpose</span>
</span><span data-line="816"><span class="sd">    -------</span>
</span><span data-line="817"><span class="sd">    Defines 3D regions used by the engine for camera selection and environmental</span>
</span><span data-line="818"><span class="sd">    triggers (sounds like waterfalls). Each area contains a center position,</span>
</span><span data-line="819"><span class="sd">    axes/length vectors (defining an oriented bounding box), and metadata such</span>
</span><span data-line="820"><span class="sd">    as area type and camera ID.</span>
</span><span data-line="821">
</span><span data-line="822"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="823"><span class="sd">    -------------------</span>
</span><span data-line="824"><span class="sd">    0x00: Vector — 3D position vector (center).</span>
</span><span data-line="825"><span class="sd">    0x0C: Vector — Length vector (extent in X/Y/Z possibly).</span>
</span><span data-line="826"><span class="sd">    0x18: Vector — X-vector (orientation).</span>
</span><span data-line="827"><span class="sd">    0x24: Vector — Y-vector.</span>
</span><span data-line="828"><span class="sd">    0x30: Vector — Z-vector.</span>
</span><span data-line="829"><span class="sd">    0x3C: Int16 — Unknown.</span>
</span><span data-line="830"><span class="sd">    0x3E: Int16 — Unknown.</span>
</span><span data-line="831"><span class="sd">    0x40: Int16 — Unknown.</span>
</span><span data-line="832"><span class="sd">    0x42: Byte  — Unknown.</span>
</span><span data-line="833"><span class="sd">    0x43: Byte  — Camera ID (index into CAME).</span>
</span><span data-line="834"><span class="sd">    0x44: Byte  — Area type:</span>
</span><span data-line="835"><span class="sd">             - 0x00: Unknown</span>
</span><span data-line="836"><span class="sd">             - 0x01: Camera</span>
</span><span data-line="837"><span class="sd">             - 0x02: (unknown)</span>
</span><span data-line="838"><span class="sd">             - 0x03: (unknown)</span>
</span><span data-line="839"><span class="sd">             - 0x04: Waterfall sound area</span>
</span><span data-line="840"><span class="sd">    0x45: Int16 — Unknown.</span>
</span><span data-line="841"><span class="sd">    0x47: Byte  — Unknown.</span>
</span><span data-line="842">
</span><span data-line="843"><span class="sd">    Gameplay Context</span>
</span><span data-line="844"><span class="sd">    ----------------</span>
</span><span data-line="845"><span class="sd">    - AREA sections usually determine which camera the engine should switch to</span>
</span><span data-line="846"><span class="sd">      when the player is inside the region.</span>
</span><span data-line="847"><span class="sd">    - Camera ID links to CAME entries; Area type allows special behavior (e.g.,</span>
</span><span data-line="848"><span class="sd">      waterfall sound triggers).</span>
</span><span data-line="849"><span class="sd">    - Good for editors to preview camera transitions.</span>
</span><span data-line="850">
</span><span data-line="851"><span class="sd">    Notes</span>
</span><span data-line="852"><span class="sd">    -----</span>
</span><span data-line="853"><span class="sd">    - Several fields are still undocumented; their meaning varies by track.</span>
</span><span data-line="854"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="855">
</span><span data-line="856">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="857">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">)</span>
</span><span data-line="858">        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="859">        <span class="bp">self</span><span class="o">.</span><span class="n">length_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="860">        <span class="bp">self</span><span class="o">.</span><span class="n">x_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="861">        <span class="bp">self</span><span class="o">.</span><span class="n">y_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="862">        <span class="bp">self</span><span class="o">.</span><span class="n">z_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="863">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown1</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="864">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown2</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x3E</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="865">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown3</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="866">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown4</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="867">        <span class="bp">self</span><span class="o">.</span><span class="n">camera_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="868">        <span class="bp">self</span><span class="o">.</span><span class="n">area_type</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TODO: parse as Byte at 0x44 if desired</span>
</span><span data-line="869">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown5</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_s16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="870">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown6</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="871">
</span><span data-line="872">
<div class="viewcode-block" id="CAME">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.CAME">[docs]</a>
</span><span data-line="873"><span class="k">class</span><span class="w"> </span><span class="nc">CAME</span><span class="p">(</span><span class="n">Section</span><span class="p">):</span>
</span><span data-line="874"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="875"><span class="sd">    CAME — Camera definitions.</span>
</span><span data-line="876">
</span><span data-line="877"><span class="sd">    Stride: 0x4C bytes per entry.</span>
</span><span data-line="878">
</span><span data-line="879"><span class="sd">    Purpose</span>
</span><span data-line="880"><span class="sd">    -------</span>
</span><span data-line="881"><span class="sd">    Defines camera motions and static camera positions used in cutscenes,</span>
</span><span data-line="882"><span class="sd">    intros, and dynamic in-game camera triggers. Camera entries are often linked</span>
</span><span data-line="883"><span class="sd">    by AREA zones or object routes.</span>
</span><span data-line="884">
</span><span data-line="885"><span class="sd">    Offsets (per-entry)</span>
</span><span data-line="886"><span class="sd">    -------------------</span>
</span><span data-line="887"><span class="sd">    0x00: Vector — 3D position vector 1 (primary).</span>
</span><span data-line="888"><span class="sd">    0x0C: Vector — 3D rotation vector.</span>
</span><span data-line="889"><span class="sd">    0x18: Vector — 3D position vector 2 (secondary/look-at).</span>
</span><span data-line="890"><span class="sd">    0x24: Vector — 3D position vector 3 (tertiary/intermediate).</span>
</span><span data-line="891"><span class="sd">    0x30: Int16  — FOV begin (field-of-view start).</span>
</span><span data-line="892"><span class="sd">    0x32: Fx16  — FOV begin sine (precomputed).</span>
</span><span data-line="893"><span class="sd">    0x34: Fx16  — FOV begin cosine.</span>
</span><span data-line="894"><span class="sd">    0x36: Int16  — FOV end.</span>
</span><span data-line="895"><span class="sd">    0x38: Fx16  — FOV end sine.</span>
</span><span data-line="896"><span class="sd">    0x3A: Fx16  — FOV end cosine.</span>
</span><span data-line="897"><span class="sd">    0x3C: UInt16 — Camera zoom.</span>
</span><span data-line="898"><span class="sd">    0x3E: UInt16 — Camera type (see camera type table below).</span>
</span><span data-line="899"><span class="sd">    0x40: UInt16 — Linked route (0xFFFF if none).</span>
</span><span data-line="900"><span class="sd">    0x42: UInt16 — Route speed.</span>
</span><span data-line="901"><span class="sd">    0x44: UInt16 — Point speed.</span>
</span><span data-line="902"><span class="sd">    0x46: UInt16 — Camera duration (in 1/60s units).</span>
</span><span data-line="903"><span class="sd">    0x48: UInt16 — Next camera (0xFFFF if last).</span>
</span><span data-line="904"><span class="sd">    0x4A: Byte   — Intro pan first camera indicator:</span>
</span><span data-line="905"><span class="sd">    0x00 = none, 0x01 = top screen, 0x02 = bottom screen.</span>
</span><span data-line="906"><span class="sd">    0x4B: Byte   — Unknown (1 if camera type == 5 in some tracks).</span>
</span><span data-line="907">
</span><span data-line="908"><span class="sd">    Camera Type (common):</span>
</span><span data-line="909"><span class="sd">    0x00: After race camera</span>
</span><span data-line="910"><span class="sd">    0x01: Unknown (with route)</span>
</span><span data-line="911"><span class="sd">    0x02: Unknown</span>
</span><span data-line="912"><span class="sd">    0x03: Intro camera (top screen)</span>
</span><span data-line="913"><span class="sd">    0x04: Intro camera (bottom screen)</span>
</span><span data-line="914"><span class="sd">    0x05: Unknown</span>
</span><span data-line="915"><span class="sd">    0x06: Unknown</span>
</span><span data-line="916"><span class="sd">    0x07: Battle mode camera</span>
</span><span data-line="917"><span class="sd">    0x08: Mission finish camera</span>
</span><span data-line="918">
</span><span data-line="919"><span class="sd">    Gameplay Context</span>
</span><span data-line="920"><span class="sd">    ----------------</span>
</span><span data-line="921"><span class="sd">    - CAME entries drive cinematic camera movement during intros, cutscenes,</span>
</span><span data-line="922"><span class="sd">      and special camera modes.</span>
</span><span data-line="923"><span class="sd">    - Linked route + point speed define how the camera follows a PATH.</span>
</span><span data-line="924"><span class="sd">    - Camera duration uses 1/60th-second units — helpful for exact timing.</span>
</span><span data-line="925">
</span><span data-line="926"><span class="sd">    Notes &amp; Community Tips</span>
</span><span data-line="927"><span class="sd">    ----------------------</span>
</span><span data-line="928"><span class="sd">    - Many of these fields are precomputed (sine/cosine) for faster in-engine</span>
</span><span data-line="929"><span class="sd">      interpolation. Editors can either preserve or recompute them.</span>
</span><span data-line="930"><span class="sd">    - The &quot;next camera&quot; field allows building camera chains for sequences.</span>
</span><span data-line="931"><span class="sd">    - When building camera editors, expose both positions and FOV values to</span>
</span><span data-line="932"><span class="sd">      enable previewing transitions correctly.</span>
</span><span data-line="933"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="934">
</span><span data-line="935">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="936">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">)</span>
</span><span data-line="937">        <span class="bp">self</span><span class="o">.</span><span class="n">position1</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="938">        <span class="bp">self</span><span class="o">.</span><span class="n">rot_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="939">        <span class="bp">self</span><span class="o">.</span><span class="n">position2</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="940">        <span class="bp">self</span><span class="o">.</span><span class="n">position3</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="941">        <span class="bp">self</span><span class="o">.</span><span class="n">fov_begin</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="942">        <span class="bp">self</span><span class="o">.</span><span class="n">fov_begin_sine</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_fx16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="943">        <span class="bp">self</span><span class="o">.</span><span class="n">fov_begin_cosine</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_fx16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="944">        <span class="bp">self</span><span class="o">.</span><span class="n">fov_end</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="945">        <span class="bp">self</span><span class="o">.</span><span class="n">fov_end_sine</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_fx16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="946">        <span class="bp">self</span><span class="o">.</span><span class="n">fov_end_cosine</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_fx16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="947">        <span class="bp">self</span><span class="o">.</span><span class="n">camera_zoom</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="948">        <span class="bp">self</span><span class="o">.</span><span class="n">camera_type</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TODO: parse if you want the raw value at 0x3E</span>
</span><span data-line="949">        <span class="bp">self</span><span class="o">.</span><span class="n">linked_route</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="950">        <span class="bp">self</span><span class="o">.</span><span class="n">route_speed</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="951">        <span class="bp">self</span><span class="o">.</span><span class="n">point_speed</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="952">        <span class="bp">self</span><span class="o">.</span><span class="n">camera_duration</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="953">        <span class="bp">self</span><span class="o">.</span><span class="n">next_camera</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u16</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="954">        <span class="bp">self</span><span class="o">.</span><span class="n">intro_pan_first_camera_indicator</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</span><span data-line="955">        <span class="bp">self</span><span class="o">.</span><span class="n">unknown</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_u8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>

</span><span data-line="956">
</span><span data-line="957">
<div class="viewcode-block" id="NKM">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.NKM">[docs]</a>
</span><span data-line="958"><span class="k">class</span><span class="w"> </span><span class="nc">NKM</span><span class="p">:</span>
</span><span data-line="959"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="960"><span class="sd">    NKM — Mario Kart DS Course Map parser.</span>
</span><span data-line="961">
</span><span data-line="962"><span class="sd">    Purpose</span>
</span><span data-line="963"><span class="sd">    -------</span>
</span><span data-line="964"><span class="sd">    Top-level container that parses the NKM file header and initializes objects</span>
</span><span data-line="965"><span class="sd">    representing each section (OBJI, PATH, POIT, STAG, KTPS, ... , CAME).</span>
</span><span data-line="966">
</span><span data-line="967"><span class="sd">    Usage Example</span>
</span><span data-line="968"><span class="sd">    ----------------</span>
</span><span data-line="969"><span class="sd">    &gt;&gt;&gt; nkm = NKM.from_file(&quot;my_course.nkm&quot;)</span>
</span><span data-line="970"><span class="sd">    &gt;&gt;&gt; print(len(nkm._OBJI))         # number of object instances</span>
</span><span data-line="971"><span class="sd">    &gt;&gt;&gt; print(nkm._STAG.amt_of_laps)  # global lap count for the stage</span>
</span><span data-line="972">
</span><span data-line="973"><span class="sd">    Implementation Details</span>
</span><span data-line="974"><span class="sd">    ----------------------</span>
</span><span data-line="975"><span class="sd">    * The typical header length is 0x4C and contains offsets (UInt32) to 17</span>
</span><span data-line="976"><span class="sd">      canonical sections in standard order. Offsets are relative to the end of</span>
</span><span data-line="977"><span class="sd">      the header (H), so they are added to `_header_offset` to compute absolute</span>
</span><span data-line="978"><span class="sd">      positions inside the file.</span>
</span><span data-line="979"><span class="sd">    * This parser assumes the &quot;typical&quot; header layout. If an NKM contains</span>
</span><span data-line="980"><span class="sd">      additional special sections (like NKMI) or a different header length,</span>
</span><span data-line="981"><span class="sd">      additional handling will be required.</span>
</span><span data-line="982"><span class="sd">    * Parsing is defensive but assumes the file is well-formed; for robust</span>
</span><span data-line="983"><span class="sd">      tools consider adding bounds checks when slicing `self._data[...]`.</span>
</span><span data-line="984">
</span><span data-line="985"><span class="sd">    Known Limitations</span>
</span><span data-line="986"><span class="sd">    -----------------</span>
</span><span data-line="987"><span class="sd">    - Some fields (GXRgb, camera_type, some unknown bytes) are left as None or</span>
</span><span data-line="988"><span class="sd">      unknown placeholders. Implementing GXRgb and Fx16/Fx32 conversions will</span>
</span><span data-line="989"><span class="sd">      enable richer output.</span>
</span><span data-line="990"><span class="sd">    - The code currently uses `PATH.has_loop = read_u8(...) != 1` which inverts</span>
</span><span data-line="991"><span class="sd">      the canonical meaning (spec: 1 means loop). Consider normalizing this if</span>
</span><span data-line="992"><span class="sd">      you rely on literal interpretation elsewhere.</span>
</span><span data-line="993">
</span><span data-line="994"><span class="sd">    See Also</span>
</span><span data-line="995"><span class="sd">    --------</span>
</span><span data-line="996"><span class="sd">    The official NKM spec (community wiki) for exhaustive explanation of flags</span>
</span><span data-line="997"><span class="sd">    and object-specific settings.</span>
</span><span data-line="998"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="999">
</span><span data-line="1000">    <span class="n">_header_offset</span> <span class="o">=</span> <span class="mh">0x4C</span>
</span><span data-line="1001">
</span><span data-line="1002">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span data-line="1003">        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
</span><span data-line="1004">
</span><span data-line="1005">        <span class="bp">self</span><span class="o">.</span><span class="n">_h</span> <span class="o">=</span> <span class="mh">0x4C</span>
</span><span data-line="1006">        <span class="c1"># Header contains offsets relative to header_end; add header_offset</span>
</span><span data-line="1007">        <span class="bp">self</span><span class="o">.</span><span class="n">_OBJI_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1008">        <span class="bp">self</span><span class="o">.</span><span class="n">_PATH_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1009">        <span class="bp">self</span><span class="o">.</span><span class="n">_POIT_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1010">        <span class="bp">self</span><span class="o">.</span><span class="n">_STAG_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1011">        <span class="bp">self</span><span class="o">.</span><span class="n">_KTPS_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1012">        <span class="bp">self</span><span class="o">.</span><span class="n">_KTPJ_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1013">        <span class="bp">self</span><span class="o">.</span><span class="n">_KTP2_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1014">        <span class="bp">self</span><span class="o">.</span><span class="n">_KTPC_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1015">        <span class="bp">self</span><span class="o">.</span><span class="n">_KTPM_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1016">        <span class="bp">self</span><span class="o">.</span><span class="n">_CPOI_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1017">        <span class="bp">self</span><span class="o">.</span><span class="n">_CPAT_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1018">        <span class="bp">self</span><span class="o">.</span><span class="n">_IPOI_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1019">        <span class="bp">self</span><span class="o">.</span><span class="n">_IPAT_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1020">        <span class="bp">self</span><span class="o">.</span><span class="n">_EPOI_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1021">        <span class="bp">self</span><span class="o">.</span><span class="n">_EPAT_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1022">        <span class="bp">self</span><span class="o">.</span><span class="n">_AREA_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1023">        <span class="bp">self</span><span class="o">.</span><span class="n">_CAME_offset</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">)</span> <span class="o">+</span> <span class="n">NKM</span><span class="o">.</span><span class="n">_header_offset</span>
</span><span data-line="1024">
</span><span data-line="1025">        <span class="c1"># Instantiate section objects. Slicing uses computed offsets.</span>
</span><span data-line="1026">        <span class="bp">self</span><span class="o">.</span><span class="n">_OBJI</span> <span class="o">=</span> <span class="n">OBJI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_OBJI_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PATH_offset</span><span class="p">])</span>
</span><span data-line="1027">        <span class="bp">self</span><span class="o">.</span><span class="n">_PATH</span> <span class="o">=</span> <span class="n">PATH</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_PATH_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_POIT_offset</span><span class="p">])</span>
</span><span data-line="1028">        <span class="bp">self</span><span class="o">.</span><span class="n">_POIT</span> <span class="o">=</span> <span class="n">POIT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_POIT_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_STAG_offset</span><span class="p">])</span>
</span><span data-line="1029">        <span class="bp">self</span><span class="o">.</span><span class="n">_STAG</span> <span class="o">=</span> <span class="n">STAG</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_STAG_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_KTPS_offset</span><span class="p">])</span>
</span><span data-line="1030">        <span class="bp">self</span><span class="o">.</span><span class="n">_KTPS</span> <span class="o">=</span> <span class="n">KTPS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_KTPS_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_KTPJ_offset</span><span class="p">])</span>
</span><span data-line="1031">        <span class="bp">self</span><span class="o">.</span><span class="n">_KTPJ</span> <span class="o">=</span> <span class="n">KTPJ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_KTPJ_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_KTP2_offset</span><span class="p">])</span>
</span><span data-line="1032">        <span class="bp">self</span><span class="o">.</span><span class="n">_KTP2</span> <span class="o">=</span> <span class="n">KTP2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_KTP2_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_KTPC_offset</span><span class="p">])</span>
</span><span data-line="1033">        <span class="bp">self</span><span class="o">.</span><span class="n">_KTPC</span> <span class="o">=</span> <span class="n">KTPC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_KTPC_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_KTPM_offset</span><span class="p">])</span>
</span><span data-line="1034">        <span class="bp">self</span><span class="o">.</span><span class="n">_KTPM</span> <span class="o">=</span> <span class="n">KTPM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_KTPM_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CPOI_offset</span><span class="p">])</span>
</span><span data-line="1035">        <span class="bp">self</span><span class="o">.</span><span class="n">_CPOI</span> <span class="o">=</span> <span class="n">CPOI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_CPOI_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CPAT_offset</span><span class="p">])</span>
</span><span data-line="1036">        <span class="bp">self</span><span class="o">.</span><span class="n">_CPAT</span> <span class="o">=</span> <span class="n">CPAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_CPAT_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IPOI_offset</span><span class="p">])</span>
</span><span data-line="1037">        <span class="bp">self</span><span class="o">.</span><span class="n">_IPOI</span> <span class="o">=</span> <span class="n">IPOI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_IPOI_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IPAT_offset</span><span class="p">])</span>
</span><span data-line="1038">        <span class="bp">self</span><span class="o">.</span><span class="n">_IPAT</span> <span class="o">=</span> <span class="n">IPAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_IPAT_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EPOI_offset</span><span class="p">])</span>
</span><span data-line="1039">        <span class="bp">self</span><span class="o">.</span><span class="n">_EPOI</span> <span class="o">=</span> <span class="n">EPOI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EPOI_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EPAT_offset</span><span class="p">])</span>
</span><span data-line="1040">        <span class="bp">self</span><span class="o">.</span><span class="n">_EPAT</span> <span class="o">=</span> <span class="n">EPAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EPAT_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AREA_offset</span><span class="p">])</span>
</span><span data-line="1041">        <span class="bp">self</span><span class="o">.</span><span class="n">_AREA</span> <span class="o">=</span> <span class="n">AREA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_AREA_offset</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CAME_offset</span><span class="p">])</span>
</span><span data-line="1042">        <span class="bp">self</span><span class="o">.</span><span class="n">_CAME</span> <span class="o">=</span> <span class="n">CAME</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_CAME_offset</span> <span class="p">:])</span>
</span><span data-line="1043">
<div class="viewcode-block" id="NKM.from_file">
<a class="viewcode-back" href="../../api/mkds.html#mkds.nkm.NKM.from_file">[docs]</a>
</span><span data-line="1044">    <span class="nd">@classmethod</span>
</span><span data-line="1045">    <span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="1046"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1047"><span class="sd">        Load an NKM file from disk and parse its sections.</span>
</span><span data-line="1048">
</span><span data-line="1049"><span class="sd">        Args:</span>
</span><span data-line="1050"><span class="sd">            path (str): Path to the `.nkm` file. Defaults to DEFAULT_NKM_PATH.</span>
</span><span data-line="1051">
</span><span data-line="1052"><span class="sd">        Returns:</span>
</span><span data-line="1053"><span class="sd">            NKM: The parsed NKM object.</span>
</span><span data-line="1054"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1055">        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span data-line="1056">
</span><span data-line="1057">        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span data-line="1058">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span data-line="1059">            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NKM file not found at </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="1060">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span data-line="1061">            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</div>

</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2025, Blake Moody</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/shibuya.js?v=e730760c"></script></body>
</html>