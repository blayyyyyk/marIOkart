<!DOCTYPE html>
<html lang="en" data-accent-color="purple" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>utils.memory - MarI/O Kart documentation</title><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b1a1f93b" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=bb284d7b" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="utils.memory"/>
<meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../index.html">
      
      
      <strong>MarI/O Kart</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/articles/articles.html">Articles</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/utils.html">Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/visualization.html">Visulization Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/vector.html">utils.vector module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/memory.html">utils.memory module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/training.html">AI Pipeline</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/mkds.html">MKDS File Parsing Library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/mkds/nkm.html">mkds.nkm module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/mkds/kcl.html">mkds.kcl module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/mkds/utils.html">mkds.utils module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/mkds/nkm-t.html">utils.nkm_torch module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/mkds/kcl-t.html">utils.kcl_torch module</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">MarI/O Kart</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">utils.memory</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for utils.memory</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="2"><span class="sd">Mario Kart DS (MKDS) Emulator I/O &amp; Geometry Utilities</span>
</span><span data-line="3"><span class="sd">======================================================</span>
</span><span data-line="4">
</span><span data-line="5"><span class="sd">This module provides a high-level, vectorized interface for reading game state</span>
</span><span data-line="6"><span class="sd">from a running DeSmuME emulator and performing common geometric operations</span>
</span><span data-line="7"><span class="sd">used in visualization, control, and RL policy features for Mario Kart DS.</span>
</span><span data-line="8">
</span><span data-line="9"><span class="sd">It wraps low-level memory reads (positions, directions, camera data, objects,</span>
</span><span data-line="10"><span class="sd">checkpoints, clock) and exposes a compact API for tasks like projecting</span>
</span><span data-line="11"><span class="sd">world-space points to screen-space, computing distances to checkpoints and</span>
</span><span data-line="12"><span class="sd">obstacles, and deriving view matrices.</span>
</span><span data-line="13">
</span><span data-line="14"><span class="sd">The implementation favors:</span>
</span><span data-line="15"><span class="sd">  * **Deterministic caching** at frame and game lifetimes to minimize emulator</span>
</span><span data-line="16"><span class="sd">    I/O, and</span>
</span><span data-line="17"><span class="sd">  * **Torch tensor** computations (CPU / CUDA / MPS) for fast, batched math.</span>
</span><span data-line="18">
</span><span data-line="19"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="20"><span class="sd">Quick Start</span>
</span><span data-line="21"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="22">
</span><span data-line="23"><span class="sd">&gt;&gt;&gt; from desmume.emulator import DeSmuME</span>
</span><span data-line="24"><span class="sd">&gt;&gt;&gt; import torch</span>
</span><span data-line="25"><span class="sd">&gt;&gt;&gt; from your_module import (</span>
</span><span data-line="26"><span class="sd">...     read_position, read_direction, project_to_screen, read_forward_distance_checkpoint</span>
</span><span data-line="27"><span class="sd">... )</span>
</span><span data-line="28"><span class="sd">&gt;&gt;&gt; emu = DeSmuME()</span>
</span><span data-line="29"><span class="sd">&gt;&gt;&gt; # ... open ROM, load state, etc.</span>
</span><span data-line="30"><span class="sd">&gt;&gt;&gt; device = torch.device(&quot;cpu&quot;)  # or &quot;cuda&quot;, &quot;mps&quot;</span>
</span><span data-line="31"><span class="sd">&gt;&gt;&gt; pos = read_position(emu, device=device)               # (3,)</span>
</span><span data-line="32"><span class="sd">&gt;&gt;&gt; dir = read_direction(emu, device=device)              # (3,)</span>
</span><span data-line="33"><span class="sd">&gt;&gt;&gt; screen = project_to_screen(emu, pos.unsqueeze(0), device=device)  # (1, 4)</span>
</span><span data-line="34"><span class="sd">&gt;&gt;&gt; fwd_to_cp = read_forward_distance_checkpoint(emu, device=device)  # scalar tensor</span>
</span><span data-line="35">
</span><span data-line="36"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="37"><span class="sd">Key Concepts &amp; Conventions</span>
</span><span data-line="38"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="39">
</span><span data-line="40"><span class="sd">Coordinate Systems</span>
</span><span data-line="41"><span class="sd">------------------</span>
</span><span data-line="42"><span class="sd">* **World Space**: Right-handed, with **Y as up**. Many functions assume a</span>
</span><span data-line="43"><span class="sd">  canonical &quot;up&quot; vector of (0, 1, 0) and construct a right-handed orthonormal</span>
</span><span data-line="44"><span class="sd">  basis `[right, up, forward]`.</span>
</span><span data-line="45"><span class="sd">* **Camera Space / Clip Space / NDC / Screen Space**: `_compute_model_view`</span>
</span><span data-line="46"><span class="sd">  builds a model-view matrix from camera position/target; `_project_to_screen`</span>
</span><span data-line="47"><span class="sd">  applies perspective and viewport transforms to return pixel coordinates for a</span>
</span><span data-line="48"><span class="sd">  256×192 screen (Nintendo DS top display).</span>
</span><span data-line="49"><span class="sd">* **Screen Origin**: (0, 0) is **top-left**. X grows to the right; Y grows</span>
</span><span data-line="50"><span class="sd">  downward. This follows the standard raster convention and matches the</span>
</span><span data-line="51"><span class="sd">  `(1 - ndc_y)` transform used in projection.</span>
</span><span data-line="52">
</span><span data-line="53"><span class="sd">Units</span>
</span><span data-line="54"><span class="sd">-----</span>
</span><span data-line="55"><span class="sd">* **Positions &amp; Scalars** returned from memory are derived from MKDS fixed-point</span>
</span><span data-line="56"><span class="sd">  formats (FX32, etc.) via helpers like `read_vector_3d_fx32` and `read_fx32`,</span>
</span><span data-line="57"><span class="sd">  and are exposed as Python floats / Torch tensors.</span>
</span><span data-line="58"><span class="sd">* **Angles**:</span>
</span><span data-line="59"><span class="sd">  - Camera FOV is read from a 16-bit fixed-point angle and converted to radians</span>
</span><span data-line="60"><span class="sd">    using: ``value * (2π / 0x10000)``.</span>
</span><span data-line="61"><span class="sd">* **Time**:</span>
</span><span data-line="62"><span class="sd">  - `read_clock()` returns **centiseconds** (10 ms units).</span>
</span><span data-line="63">
</span><span data-line="64"><span class="sd">Memory Map &amp; Assets</span>
</span><span data-line="65"><span class="sd">-------------------</span>
</span><span data-line="66"><span class="sd">* **Addresses**: The module uses static addresses for key pointers (racer,</span>
</span><span data-line="67"><span class="sd">  course, objects, checkpoints, camera, clock). See constants:</span>
</span><span data-line="68"><span class="sd">  `RACER_PTR_ADDR`, `COURSE_ID_ADDR`, `OBJECTS_PTR_ADDR`, `CHECKPOINT_PTR_ADDR`,</span>
</span><span data-line="69"><span class="sd">  `CLOCK_DATA_PTR`, `CAMERA_PTR_ADDR`.</span>
</span><span data-line="70"><span class="sd">* **Course Files**:</span>
</span><span data-line="71"><span class="sd">  - `courses.json` maps course IDs to directory names.</span>
</span><span data-line="72"><span class="sd">  - KCL (`course_collision.kcl`) and NKM (`course_map.nkm`) are loaded via</span>
</span><span data-line="73"><span class="sd">    `KCLTensor.from_file(...)` and `NKMTensor.from_file(...)`.</span>
</span><span data-line="74">
</span><span data-line="75"><span class="sd">Caching Model</span>
</span><span data-line="76"><span class="sd">-------------</span>
</span><span data-line="77"><span class="sd">Two decorators reduce emulator I/O:</span>
</span><span data-line="78">
</span><span data-line="79"><span class="sd">* ``@frame_cache`` — Caches the function&#39;s **single** return value per</span>
</span><span data-line="80"><span class="sd">  emulator tick (`emu.get_ticks()`). Recomputes only when the tick changes.</span>
</span><span data-line="81">
</span><span data-line="82"><span class="sd">* ``@game_cache`` — Caches the function&#39;s **single** return value for the</span>
</span><span data-line="83"><span class="sd">  process lifetime (until interpreter exit).</span>
</span><span data-line="84">
</span><span data-line="85"><span class="sd">⚠ **Important**: Both caches **ignore argument values**. If you call a cached</span>
</span><span data-line="86"><span class="sd">function with different arguments within the same lifetime (same frame or same</span>
</span><span data-line="87"><span class="sd">run), the **first computed result is reused**. In practice, pass stable</span>
</span><span data-line="88"><span class="sd">arguments (e.g., a constant `device`) to avoid surprises.</span>
</span><span data-line="89">
</span><span data-line="90"><span class="sd">Device Handling</span>
</span><span data-line="91"><span class="sd">---------------</span>
</span><span data-line="92"><span class="sd">Many functions accept a Torch `device` and return tensors allocated there. For</span>
</span><span data-line="93"><span class="sd">best performance, use `cuda` (GPU) or `mps` (Apple Silicon) when available, and</span>
</span><span data-line="94"><span class="sd">keep devices **consistent** across the call sites, especially for `@game_cache`</span>
</span><span data-line="95"><span class="sd">results (KCL/NKM tensors are created on the device used at first call).</span>
</span><span data-line="96">
</span><span data-line="97"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="98"><span class="sd">Public API Overview</span>
</span><span data-line="99"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="100">
</span><span data-line="101"><span class="sd">Clock &amp; Course</span>
</span><span data-line="102"><span class="sd">~~~~~~~~~~~~~~</span>
</span><span data-line="103"><span class="sd">* `read_clock_ptr(emu)` — Base pointer to clock data (cached for game lifetime).</span>
</span><span data-line="104"><span class="sd">* `read_clock(emu)` — Current clock in 10 ms units (cached per frame).</span>
</span><span data-line="105"><span class="sd">* `get_current_course_id(emu)` — Current course ID (byte).</span>
</span><span data-line="106"><span class="sd">* `get_course_path(id)` — Course directory name from `courses.json`.</span>
</span><span data-line="107"><span class="sd">* `load_current_kcl(emu, device)` — Parsed KCL collision mesh (game-cached).</span>
</span><span data-line="108"><span class="sd">* `load_current_nkm(emu, device)` — Parsed NKM map data (game-cached).</span>
</span><span data-line="109">
</span><span data-line="110"><span class="sd">Player &amp; Objects</span>
</span><span data-line="111"><span class="sd">~~~~~~~~~~~~~~~~</span>
</span><span data-line="112"><span class="sd">* `read_racer_ptr(emu)` — Pointer to the player racer struct.</span>
</span><span data-line="113"><span class="sd">* `read_position(emu, device)` — Player world position `(3,)`.</span>
</span><span data-line="114"><span class="sd">* `read_direction(emu, device)` — Player forward direction `(3,)`.</span>
</span><span data-line="115"><span class="sd">* `read_objects(...)`, `read_object_*` helpers — Scans and queries object table.</span>
</span><span data-line="116"><span class="sd">  - `safe_object` decorator returns `None` for deleted objects.</span>
</span><span data-line="117">
</span><span data-line="118"><span class="sd">Camera &amp; Projection</span>
</span><span data-line="119"><span class="sd">~~~~~~~~~~~~~~~~~~~</span>
</span><span data-line="120"><span class="sd">* `read_camera_ptr(emu)` — Pointer to camera struct.</span>
</span><span data-line="121"><span class="sd">* `read_camera_fov(emu)` — FOV in radians.</span>
</span><span data-line="122"><span class="sd">* `read_camera_aspect(emu)` — Aspect ratio (W/H).</span>
</span><span data-line="123"><span class="sd">* `read_camera_position(emu, device)` — Camera world pos `(3,)` with elevation.</span>
</span><span data-line="124"><span class="sd">* `read_camera_target_position(emu, device)` — Camera look-at `(3,)`.</span>
</span><span data-line="125"><span class="sd">* `read_model_view(emu, device)` — 4×4 model-view matrix.</span>
</span><span data-line="126"><span class="sd">* `project_to_screen(emu, points, device)` — Projects `(N,3)` to `(N,4)`:</span>
</span><span data-line="127"><span class="sd">  `[x_px, y_px, clip_z, normalized_depth]`.</span>
</span><span data-line="128"><span class="sd">* `z_clip_mask(x)` — Mask for points within Z-near/far bounds (camera space).</span>
</span><span data-line="129">
</span><span data-line="130"><span class="sd">Checkpoints</span>
</span><span data-line="131"><span class="sd">~~~~~~~~~~~</span>
</span><span data-line="132"><span class="sd">* `read_checkpoint_ptr(emu)` — Pointer to checkpoint manager.</span>
</span><span data-line="133"><span class="sd">* `read_current_checkpoint(emu)`, `read_current_key_checkpoint(emu)`,</span>
</span><span data-line="134"><span class="sd">  `read_current_lap(emu)` — Indices for current progress.</span>
</span><span data-line="135"><span class="sd">* `read_ghost_checkpoint(emu)`, `read_ghost_key_checkpoint(emu)` — Ghost state.</span>
</span><span data-line="136"><span class="sd">* `read_checkpoint_positions(emu, device)` — `(C, 2, 3)` segment endpoints.</span>
</span><span data-line="137"><span class="sd">* `read_next_checkpoint(emu, checkpoint_count)` — Next index (wraps).</span>
</span><span data-line="138"><span class="sd">* `read_next_checkpoint_position(emu, device)`,</span>
</span><span data-line="139"><span class="sd">  `read_current_checkpoint_position(emu, device)` — `(2,3)` endpoints.</span>
</span><span data-line="140"><span class="sd">* `read_facing_point_checkpoint(emu, direction, device)` — Intersection of a</span>
</span><span data-line="141"><span class="sd">  ray (from player, given direction) with next checkpoint line in XZ.</span>
</span><span data-line="142"><span class="sd">* `read_forward_distance_checkpoint(emu, device)`,</span>
</span><span data-line="143"><span class="sd">  `read_left_distance_checkpoint(emu, device)`,</span>
</span><span data-line="144"><span class="sd">  `read_direction_to_checkpoint(emu, device)` — Distances/steering angle.</span>
</span><span data-line="145">
</span><span data-line="146"><span class="sd">Obstacles (Walls / Offroad)</span>
</span><span data-line="147"><span class="sd">~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
</span><span data-line="148"><span class="sd">* `read_facing_point_obstacle(emu, position, direction, device)` — Samples a</span>
</span><span data-line="149"><span class="sd">  cone of rays around the forward direction to find the **nearest** hit against</span>
</span><span data-line="150"><span class="sd">  wall/offroad triangles. Returns a point or `None`.</span>
</span><span data-line="151"><span class="sd">* `read_forward_distance_obstacle(emu, device)`,</span>
</span><span data-line="152"><span class="sd">  `read_left_distance_obstacle(emu, device)`,</span>
</span><span data-line="153"><span class="sd">  `read_right_distance_obstacle(emu, device)` — Scalar distances to nearest</span>
</span><span data-line="154"><span class="sd">  obstacles along canonical forward/left/right rays. Return `+inf` when no hit.</span>
</span><span data-line="155">
</span><span data-line="156"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="157"><span class="sd">Return Types &amp; Shapes</span>
</span><span data-line="158"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="159">
</span><span data-line="160"><span class="sd">* Positions / Directions: `torch.Tensor` with shape `(3,)`.</span>
</span><span data-line="161"><span class="sd">* Batches of points: `(N, 3)`.</span>
</span><span data-line="162"><span class="sd">* Screen Projection: `(N, 4)` → `[x_px, y_px, clip_z, normalized_depth]`.</span>
</span><span data-line="163"><span class="sd">* Checkpoints: `(C, 2, 3)` → per checkpoint two endpoints `[p1, p2]`.</span>
</span><span data-line="164"><span class="sd">* Distances / Angles: 0-D or 1-D scalar `torch.Tensor` (depending on operation).</span>
</span><span data-line="165">
</span><span data-line="166"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="167"><span class="sd">Errors &amp; Edge Cases</span>
</span><span data-line="168"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="169">
</span><span data-line="170"><span class="sd">* **Deleted / Ignored Objects**: `safe_object`-wrapped functions return `None`</span>
</span><span data-line="171"><span class="sd">  when the object is deleted; callers must handle `None`.</span>
</span><span data-line="172"><span class="sd">* **No Geometry**: When there are no wall/offroad triangles or raycasts miss,</span>
</span><span data-line="173"><span class="sd">  obstacle distance functions return `+inf` (as a tensor).</span>
</span><span data-line="174"><span class="sd">* **Empty Projections**: `_project_to_screen` returns an empty tensor when</span>
</span><span data-line="175"><span class="sd">  given no points; invalid (behind-camera) points may still project with</span>
</span><span data-line="176"><span class="sd">  negative `clip_w`.</span>
</span><span data-line="177">
</span><span data-line="178"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="179"><span class="sd">Performance Notes</span>
</span><span data-line="180"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="181">
</span><span data-line="182"><span class="sd">* Caching eliminates redundant memory reads across a frame / game run.</span>
</span><span data-line="183"><span class="sd">* Geometry routines (ray casting, distances, projection) are vectorized in</span>
</span><span data-line="184"><span class="sd">  Torch; prefer GPU/MPS devices when available.</span>
</span><span data-line="185"><span class="sd">* Keep devices consistent across calls that share cached state (e.g., KCL/NKM).</span>
</span><span data-line="186">
</span><span data-line="187"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="188"><span class="sd">Examples</span>
</span><span data-line="189"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="190">
</span><span data-line="191"><span class="sd">Project player and next checkpoint endpoints to screen:</span>
</span><span data-line="192">
</span><span data-line="193"><span class="sd">&gt;&gt;&gt; pts = torch.vstack([read_position(emu, device),    # (1,3)</span>
</span><span data-line="194"><span class="sd">...                     read_next_checkpoint_position(emu, device)]).reshape(-1, 3)</span>
</span><span data-line="195"><span class="sd">&gt;&gt;&gt; screen_pts = project_to_screen(emu, pts, device)</span>
</span><span data-line="196"><span class="sd">&gt;&gt;&gt; screen_pts[:, :2]  # pixel coordinates</span>
</span><span data-line="197">
</span><span data-line="198"><span class="sd">Compute lateral vs forward distance to next checkpoint:</span>
</span><span data-line="199">
</span><span data-line="200"><span class="sd">&gt;&gt;&gt; d_left  = read_left_distance_checkpoint(emu, device)</span>
</span><span data-line="201"><span class="sd">&gt;&gt;&gt; d_front = read_forward_distance_checkpoint(emu, device)</span>
</span><span data-line="202">
</span><span data-line="203"><span class="sd">Find nearest obstacle straight ahead:</span>
</span><span data-line="204">
</span><span data-line="205"><span class="sd">&gt;&gt;&gt; d_obs = read_forward_distance_obstacle(emu, device)</span>
</span><span data-line="206"><span class="sd">&gt;&gt;&gt; float(d_obs) if torch.isfinite(d_obs) else float(&quot;inf&quot;)</span>
</span><span data-line="207">
</span><span data-line="208"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="209"><span class="sd">Implementation Notes</span>
</span><span data-line="210"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="211">
</span><span data-line="212"><span class="sd">* `_compute_orthonormal_basis` builds a right-handed frame from a forward</span>
</span><span data-line="213"><span class="sd">  vector and an up-like reference (default `(0,1,0)`), normalizing each axis.</span>
</span><span data-line="214"><span class="sd">* `_compute_model_view` constructs a 4×4 model-view matrix in row-major with</span>
</span><span data-line="215"><span class="sd">  basis rows `[right, up, forward]` and a translated origin.</span>
</span><span data-line="216"><span class="sd">* `_project_to_screen` creates a simple perspective matrix using vertical FOV</span>
</span><span data-line="217"><span class="sd">  and aspect ratio; returns pixel coordinates using constants</span>
</span><span data-line="218"><span class="sd">  `SCREEN_WIDTH = 256` and `SCREEN_HEIGHT = 192`.</span>
</span><span data-line="219">
</span><span data-line="220"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="221"><span class="sd">Compatibility</span>
</span><span data-line="222"><span class="sd">-------------------------------------------------------------------------------</span>
</span><span data-line="223">
</span><span data-line="224"><span class="sd">* Tested with DeSmuME Python bindings and Torch. Some ops may vary by backend</span>
</span><span data-line="225"><span class="sd">  (e.g., MPS lacks a few linear algebra kernels); this module sticks to widely</span>
</span><span data-line="226"><span class="sd">  supported APIs.</span>
</span><span data-line="227">
</span><span data-line="228"><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="229"><span class="kn">from</span><span class="w"> </span><span class="nn">desmume.emulator</span><span class="w"> </span><span class="kn">import</span> <span class="n">SCREEN_WIDTH</span><span class="p">,</span> <span class="n">DeSmuME</span>
</span><span data-line="230"><span class="kn">from</span><span class="w"> </span><span class="nn">mkds.kcl</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_fx32</span>
</span><span data-line="231"><span class="kn">from</span><span class="w"> </span><span class="nn">utils.kcl_torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">KCLTensor</span>
</span><span data-line="232"><span class="kn">from</span><span class="w"> </span><span class="nn">utils.nkm_torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">NKMTensor</span>
</span><span data-line="233"><span class="kn">from</span><span class="w"> </span><span class="nn">mkds.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_vector_3d_fx32</span>
</span><span data-line="234"><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span data-line="235"><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span data-line="236"><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</span><span data-line="237"><span class="kn">from</span><span class="w"> </span><span class="nn">utils.vector</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span data-line="238">    <span class="n">pairwise_distances_cross</span><span class="p">,</span>
</span><span data-line="239">    <span class="n">intersect_ray_line_2d</span><span class="p">,</span>
</span><span data-line="240">    <span class="n">triangle_raycast_batch</span><span class="p">,</span>
</span><span data-line="241">    <span class="n">sample_cone</span><span class="p">,</span>
</span><span data-line="242">    <span class="n">triangle_altitude</span><span class="p">,</span>
</span><span data-line="243"><span class="p">)</span>
</span><span data-line="244"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Concatenate</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">ParamSpec</span>
</span><span data-line="245">
</span><span data-line="246"><span class="n">P</span> <span class="o">=</span> <span class="n">ParamSpec</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
</span><span data-line="247"><span class="n">R</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">)</span>
</span><span data-line="248">
</span><span data-line="249"><span class="n">SCREEN_WIDTH</span><span class="p">,</span> <span class="n">SCREEN_HEIGHT</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">192</span>
</span><span data-line="250"><span class="n">Z_FAR</span> <span class="o">=</span> <span class="mf">1000.0</span>
</span><span data-line="251"><span class="n">Z_NEAR</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span data-line="252"><span class="n">Z_SCALE</span> <span class="o">=</span> <span class="mf">10.0</span>
</span><span data-line="253">
</span><span data-line="254"><span class="n">RACER_PTR_ADDR</span> <span class="o">=</span> <span class="mh">0x0217ACF8</span>
</span><span data-line="255"><span class="n">COURSE_ID_ADDR</span> <span class="o">=</span> <span class="mh">0x23CDCD8</span>
</span><span data-line="256"><span class="n">OBJECTS_PTR_ADDR</span> <span class="o">=</span> <span class="mh">0x0217B588</span>
</span><span data-line="257"><span class="n">CHECKPOINT_PTR_ADDR</span> <span class="o">=</span> <span class="mh">0x021755FC</span>
</span><span data-line="258"><span class="n">CLOCK_DATA_PTR</span> <span class="o">=</span> <span class="mh">0x0217AA34</span>
</span><span data-line="259"><span class="n">CAMERA_PTR_ADDR</span> <span class="o">=</span> <span class="mh">0x0217AA4C</span>
</span><span data-line="260">
</span><span data-line="261"><span class="c1"># Object flags</span>
</span><span data-line="262"><span class="n">FLAG_DYNAMIC</span> <span class="o">=</span> <span class="mh">0x1000</span>
</span><span data-line="263"><span class="n">FLAG_MAPOBJ</span> <span class="o">=</span> <span class="mh">0x2000</span>
</span><span data-line="264"><span class="n">FLAG_ITEM</span> <span class="o">=</span> <span class="mh">0x4000</span>
</span><span data-line="265"><span class="n">FLAG_RACER</span> <span class="o">=</span> <span class="mh">0x8000</span>
</span><span data-line="266">
</span><span data-line="267">
<div class="viewcode-block" id="frame_cache">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.frame_cache">[docs]</a>
</span><span data-line="268"><span class="k">def</span><span class="w"> </span><span class="nf">frame_cache</span><span class="p">(</span>
</span><span data-line="269">    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">Concatenate</span><span class="p">[</span><span class="n">DeSmuME</span><span class="p">,</span> <span class="n">P</span><span class="p">],</span> <span class="n">R</span><span class="p">],</span>
</span><span data-line="270"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">Concatenate</span><span class="p">[</span><span class="n">DeSmuME</span><span class="p">,</span> <span class="n">P</span><span class="p">],</span> <span class="n">R</span><span class="p">]:</span>
</span><span data-line="271"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator that caches a function&#39;s return value once per emulator tick.</span>
</span><span data-line="272">
</span><span data-line="273"><span class="sd">    The wrapped function will only be re-executed when `emu.get_ticks()` changes.</span>
</span><span data-line="274"><span class="sd">    Useful for expensive reads that don&#39;t change within a single frame.</span>
</span><span data-line="275">
</span><span data-line="276"><span class="sd">    Args:</span>
</span><span data-line="277"><span class="sd">        func: A function whose first argument is a `DeSmuME` instance.</span>
</span><span data-line="278">
</span><span data-line="279"><span class="sd">    Returns:</span>
</span><span data-line="280"><span class="sd">        A wrapped function with identical signature that returns a cached result per tick.</span>
</span><span data-line="281"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="282">    <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="283">    <span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="284">
</span><span data-line="285">    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
</span><span data-line="286"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal wrapper used by `frame_cache` to perform per-tick memoization.&quot;&quot;&quot;</span>
</span><span data-line="287">        <span class="k">nonlocal</span> <span class="n">frame_count</span><span class="p">,</span> <span class="n">val</span>
</span><span data-line="288">        <span class="k">if</span> <span class="n">emu</span><span class="o">.</span><span class="n">get_ticks</span><span class="p">()</span> <span class="o">!=</span> <span class="n">frame_count</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="289">            <span class="n">frame_count</span> <span class="o">=</span> <span class="n">emu</span><span class="o">.</span><span class="n">get_ticks</span><span class="p">()</span>
</span><span data-line="290">            <span class="n">val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="291">
</span><span data-line="292">        <span class="k">return</span> <span class="n">val</span>
</span><span data-line="293">
</span><span data-line="294">    <span class="k">return</span> <span class="n">wrapper</span></div>

</span><span data-line="295">
</span><span data-line="296">
<div class="viewcode-block" id="game_cache">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.game_cache">[docs]</a>
</span><span data-line="297"><span class="k">def</span><span class="w"> </span><span class="nf">game_cache</span><span class="p">(</span>
</span><span data-line="298">    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">Concatenate</span><span class="p">[</span><span class="n">DeSmuME</span><span class="p">,</span> <span class="n">P</span><span class="p">],</span> <span class="n">R</span><span class="p">],</span>
</span><span data-line="299"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">Concatenate</span><span class="p">[</span><span class="n">DeSmuME</span><span class="p">,</span> <span class="n">P</span><span class="p">],</span> <span class="n">R</span><span class="p">]:</span>
</span><span data-line="300"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator that caches a function&#39;s return value for the process lifetime.</span>
</span><span data-line="301">
</span><span data-line="302"><span class="sd">    The wrapped function executes once and its result is reused thereafter.</span>
</span><span data-line="303"><span class="sd">    Appropriate for data that remains constant across a run (e.g., course files).</span>
</span><span data-line="304">
</span><span data-line="305"><span class="sd">    Args:</span>
</span><span data-line="306"><span class="sd">        func: A function whose first argument is a `DeSmuME` instance.</span>
</span><span data-line="307">
</span><span data-line="308"><span class="sd">    Returns:</span>
</span><span data-line="309"><span class="sd">        A wrapped function with identical signature that returns a cached result.</span>
</span><span data-line="310"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="311">    <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="312">
</span><span data-line="313">    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
</span><span data-line="314"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal wrapper used by `game_cache` to memoize across the entire run.&quot;&quot;&quot;</span>
</span><span data-line="315">        <span class="k">nonlocal</span> <span class="n">val</span>
</span><span data-line="316">        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="317">            <span class="n">val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="318">
</span><span data-line="319">        <span class="k">return</span> <span class="n">val</span>
</span><span data-line="320">
</span><span data-line="321">    <span class="k">return</span> <span class="n">wrapper</span></div>

</span><span data-line="322">
</span><span data-line="323">
<div class="viewcode-block" id="z_clip_mask">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.z_clip_mask">[docs]</a>
</span><span data-line="324"><span class="k">def</span><span class="w"> </span><span class="nf">z_clip_mask</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span data-line="325"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute a boolean mask for points within the view frustum Z range.</span>
</span><span data-line="326">
</span><span data-line="327"><span class="sd">    Args:</span>
</span><span data-line="328"><span class="sd">        x: Tensor of shape (N, 3+) where x[:, 2] is the camera-space Z.</span>
</span><span data-line="329">
</span><span data-line="330"><span class="sd">    Returns:</span>
</span><span data-line="331"><span class="sd">        A boolean tensor of shape (N,) where True indicates Z is between -Z_FAR and -Z_NEAR.</span>
</span><span data-line="332"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="333">    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">Z_NEAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">Z_FAR</span><span class="p">)</span></div>

</span><span data-line="334">
</span><span data-line="335">
<div class="viewcode-block" id="read_clock_ptr">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_clock_ptr">[docs]</a>
</span><span data-line="336"><span class="nd">@game_cache</span>
</span><span data-line="337"><span class="k">def</span><span class="w"> </span><span class="nf">read_clock_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="338"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the base pointer to the game&#39;s clock data structure.</span>
</span><span data-line="339">
</span><span data-line="340"><span class="sd">    Args:</span>
</span><span data-line="341"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="342">
</span><span data-line="343"><span class="sd">    Returns:</span>
</span><span data-line="344"><span class="sd">        Integer address of the clock data struct.</span>
</span><span data-line="345"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="346">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">CLOCK_DATA_PTR</span><span class="p">)</span></div>

</span><span data-line="347">
</span><span data-line="348">
<div class="viewcode-block" id="read_clock">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_clock">[docs]</a>
</span><span data-line="349"><span class="nd">@frame_cache</span>
</span><span data-line="350"><span class="k">def</span><span class="w"> </span><span class="nf">read_clock</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="351"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the current game clock value.</span>
</span><span data-line="352">
</span><span data-line="353"><span class="sd">    The value is read from the clock data structure and multiplied by 10,</span>
</span><span data-line="354"><span class="sd">    resulting in units of 10 ms (centiseconds).</span>
</span><span data-line="355">
</span><span data-line="356"><span class="sd">    Args:</span>
</span><span data-line="357"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="358">
</span><span data-line="359"><span class="sd">    Returns:</span>
</span><span data-line="360"><span class="sd">        Integer time in 10 ms units.</span>
</span><span data-line="361"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="362">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_clock_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="363">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span></div>

</span><span data-line="364">
</span><span data-line="365">
<div class="viewcode-block" id="get_current_course_id">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.get_current_course_id">[docs]</a>
</span><span data-line="366"><span class="k">def</span><span class="w"> </span><span class="nf">get_current_course_id</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="367"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the current course ID from memory.</span>
</span><span data-line="368">
</span><span data-line="369"><span class="sd">    Args:</span>
</span><span data-line="370"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="371">
</span><span data-line="372"><span class="sd">    Returns:</span>
</span><span data-line="373"><span class="sd">        Integer course ID (byte).</span>
</span><span data-line="374"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="375">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">COURSE_ID_ADDR</span><span class="p">)</span></div>

</span><span data-line="376">
</span><span data-line="377">
<div class="viewcode-block" id="get_course_path">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.get_course_path">[docs]</a>
</span><span data-line="378"><span class="k">def</span><span class="w"> </span><span class="nf">get_course_path</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="379"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="380"><span class="sd">    Resolve a course ID to the local filesystem path for its assets.</span>
</span><span data-line="381">
</span><span data-line="382"><span class="sd">    Args:</span>
</span><span data-line="383"><span class="sd">        id: Course ID.</span>
</span><span data-line="384">
</span><span data-line="385"><span class="sd">    Returns:</span>
</span><span data-line="386"><span class="sd">        String path relative to ./courses/ for the given course.</span>
</span><span data-line="387">
</span><span data-line="388"><span class="sd">    Raises:</span>
</span><span data-line="389"><span class="sd">        AssertionError: If the course ID is not present in the lookup table.</span>
</span><span data-line="390"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="391">    <span class="n">course_id_lookup</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="392">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;utils/courses.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span data-line="393">        <span class="n">course_id_lookup</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span data-line="394">
</span><span data-line="395">    <span class="k">assert</span> <span class="n">course_id_lookup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="396">    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">course_id_lookup</span>
</span><span data-line="397">    <span class="k">return</span> <span class="n">course_id_lookup</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)]</span></div>

</span><span data-line="398">
</span><span data-line="399">
<div class="viewcode-block" id="load_current_kcl">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.load_current_kcl">[docs]</a>
</span><span data-line="400"><span class="nd">@game_cache</span>
</span><span data-line="401"><span class="k">def</span><span class="w"> </span><span class="nf">load_current_kcl</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="402"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Load and parse the KCL collision file for the current course.</span>
</span><span data-line="403">
</span><span data-line="404"><span class="sd">    Cached for the lifetime of the process.</span>
</span><span data-line="405">
</span><span data-line="406"><span class="sd">    Args:</span>
</span><span data-line="407"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="408"><span class="sd">        device: Torch device (e.g., &#39;cpu&#39;, &#39;cuda&#39;, &#39;mps&#39;) to store tensors on.</span>
</span><span data-line="409">
</span><span data-line="410"><span class="sd">    Returns:</span>
</span><span data-line="411"><span class="sd">        `KCLTensor` with triangle and prism data on the specified device.</span>
</span><span data-line="412"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="413">    <span class="k">assert</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="414">    <span class="nb">id</span> <span class="o">=</span> <span class="n">get_current_course_id</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="415">    <span class="n">path</span> <span class="o">=</span> <span class="n">get_course_path</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span data-line="416">    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./courses/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/course_collision.kcl&quot;</span>
</span><span data-line="417">    <span class="n">kcl</span> <span class="o">=</span> <span class="n">KCLTensor</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="418">    <span class="k">return</span> <span class="n">kcl</span></div>

</span><span data-line="419">
</span><span data-line="420">
<div class="viewcode-block" id="load_current_nkm">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.load_current_nkm">[docs]</a>
</span><span data-line="421"><span class="nd">@game_cache</span>
</span><span data-line="422"><span class="k">def</span><span class="w"> </span><span class="nf">load_current_nkm</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="423"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Load and parse the NKM map file for the current course.</span>
</span><span data-line="424">
</span><span data-line="425"><span class="sd">    Cached for the lifetime of the process.</span>
</span><span data-line="426">
</span><span data-line="427"><span class="sd">    Args:</span>
</span><span data-line="428"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="429"><span class="sd">        device: Torch device to store tensors on.</span>
</span><span data-line="430">
</span><span data-line="431"><span class="sd">    Returns:</span>
</span><span data-line="432"><span class="sd">        `NKMTensor` with NKM section tensors (e.g., checkpoints) on the specified device.</span>
</span><span data-line="433"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="434">    <span class="k">assert</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="435">    <span class="nb">id</span> <span class="o">=</span> <span class="n">get_current_course_id</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="436">    <span class="n">path</span> <span class="o">=</span> <span class="n">get_course_path</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span data-line="437">    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./courses/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/course_map.nkm&quot;</span>
</span><span data-line="438">    <span class="n">nkm</span> <span class="o">=</span> <span class="n">NKMTensor</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="439">    <span class="k">return</span> <span class="n">nkm</span></div>

</span><span data-line="440">
</span><span data-line="441">
<div class="viewcode-block" id="read_racer_ptr">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_racer_ptr">[docs]</a>
</span><span data-line="442"><span class="k">def</span><span class="w"> </span><span class="nf">read_racer_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">RACER_PTR_ADDR</span><span class="p">):</span>
</span><span data-line="443"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the pointer to the player&#39;s racer object.</span>
</span><span data-line="444">
</span><span data-line="445"><span class="sd">    Args:</span>
</span><span data-line="446"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="447"><span class="sd">        addr: Memory address where the racer pointer is stored.</span>
</span><span data-line="448">
</span><span data-line="449"><span class="sd">    Returns:</span>
</span><span data-line="450"><span class="sd">        Integer address of the racer structure.</span>
</span><span data-line="451"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="452">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span></div>

</span><span data-line="453">
</span><span data-line="454">
<div class="viewcode-block" id="read_position">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_position">[docs]</a>
</span><span data-line="455"><span class="nd">@frame_cache</span>
</span><span data-line="456"><span class="k">def</span><span class="w"> </span><span class="nf">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="457"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the player&#39;s world-space position.</span>
</span><span data-line="458">
</span><span data-line="459"><span class="sd">    Args:</span>
</span><span data-line="460"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="461"><span class="sd">        device: Torch device for the returned tensor.</span>
</span><span data-line="462">
</span><span data-line="463"><span class="sd">    Returns:</span>
</span><span data-line="464"><span class="sd">        torch.Tensor of shape (3,) representing (x, y, z) in world units.</span>
</span><span data-line="465"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="466">    <span class="n">data</span> <span class="o">=</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span>
</span><span data-line="467">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_racer_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="468">    <span class="n">pos</span> <span class="o">=</span> <span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">)</span>
</span><span data-line="469">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>

</span><span data-line="470">
</span><span data-line="471">
<div class="viewcode-block" id="read_direction">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_direction">[docs]</a>
</span><span data-line="472"><span class="nd">@frame_cache</span>
</span><span data-line="473"><span class="k">def</span><span class="w"> </span><span class="nf">read_direction</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="474"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the player&#39;s forward direction vector (world-space).</span>
</span><span data-line="475">
</span><span data-line="476"><span class="sd">    Args:</span>
</span><span data-line="477"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="478"><span class="sd">        device: Torch device for the returned tensor.</span>
</span><span data-line="479">
</span><span data-line="480"><span class="sd">    Returns:</span>
</span><span data-line="481"><span class="sd">        torch.Tensor of shape (3,) representing the forward direction.</span>
</span><span data-line="482"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="483">    <span class="n">data</span> <span class="o">=</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span>
</span><span data-line="484">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_racer_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="485">    <span class="n">pos</span> <span class="o">=</span> <span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">)</span>
</span><span data-line="486">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>

</span><span data-line="487">
</span><span data-line="488">
<div class="viewcode-block" id="read_objects_array_max_count">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_objects_array_max_count">[docs]</a>
</span><span data-line="489"><span class="k">def</span><span class="w"> </span><span class="nf">read_objects_array_max_count</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">OBJECTS_PTR_ADDR</span><span class="p">):</span>
</span><span data-line="490"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the maximum number of objects in the global object array.</span>
</span><span data-line="491">
</span><span data-line="492"><span class="sd">    Args:</span>
</span><span data-line="493"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="494"><span class="sd">        addr: Base address of the object array metadata.</span>
</span><span data-line="495">
</span><span data-line="496"><span class="sd">    Returns:</span>
</span><span data-line="497"><span class="sd">        Signed integer max count.</span>
</span><span data-line="498"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="499">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">)</span></div>

</span><span data-line="500">
</span><span data-line="501">
<div class="viewcode-block" id="read_objects_array_ptr">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_objects_array_ptr">[docs]</a>
</span><span data-line="502"><span class="k">def</span><span class="w"> </span><span class="nf">read_objects_array_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">OBJECTS_PTR_ADDR</span><span class="p">):</span>
</span><span data-line="503"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the pointer to the global object pointer array.</span>
</span><span data-line="504">
</span><span data-line="505"><span class="sd">    Args:</span>
</span><span data-line="506"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="507"><span class="sd">        addr: Base address of the object array metadata.</span>
</span><span data-line="508">
</span><span data-line="509"><span class="sd">    Returns:</span>
</span><span data-line="510"><span class="sd">        Signed integer address of the object pointer array.</span>
</span><span data-line="511"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="512">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span></div>

</span><span data-line="513">
</span><span data-line="514">
<div class="viewcode-block" id="read_object_offset">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_object_offset">[docs]</a>
</span><span data-line="515"><span class="k">def</span><span class="w"> </span><span class="nf">read_object_offset</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="516"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the memory offset of an object entry within the array.</span>
</span><span data-line="517">
</span><span data-line="518"><span class="sd">    Args:</span>
</span><span data-line="519"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="520"><span class="sd">        id: Object index.</span>
</span><span data-line="521">
</span><span data-line="522"><span class="sd">    Returns:</span>
</span><span data-line="523"><span class="sd">        Integer byte offset to the object&#39;s metadata entry.</span>
</span><span data-line="524"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="525">    <span class="k">return</span> <span class="n">read_objects_array_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span> <span class="o">+</span> <span class="nb">id</span> <span class="o">*</span> <span class="mh">0x1C</span></div>

</span><span data-line="526">
</span><span data-line="527">
<div class="viewcode-block" id="read_object_ptr">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_object_ptr">[docs]</a>
</span><span data-line="528"><span class="k">def</span><span class="w"> </span><span class="nf">read_object_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="529"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the object instance pointer for a given object ID.</span>
</span><span data-line="530">
</span><span data-line="531"><span class="sd">    Args:</span>
</span><span data-line="532"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="533"><span class="sd">        id: Object index.</span>
</span><span data-line="534">
</span><span data-line="535"><span class="sd">    Returns:</span>
</span><span data-line="536"><span class="sd">        Integer address of the object struct (0 if null).</span>
</span><span data-line="537"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="538">    <span class="n">offset</span> <span class="o">=</span> <span class="n">read_object_offset</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="539">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">)</span></div>

</span><span data-line="540">
</span><span data-line="541">
<div class="viewcode-block" id="read_object_flags">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_object_flags">[docs]</a>
</span><span data-line="542"><span class="k">def</span><span class="w"> </span><span class="nf">read_object_flags</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="543"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the object&#39;s flags (type/category bits, state, etc.).</span>
</span><span data-line="544">
</span><span data-line="545"><span class="sd">    Args:</span>
</span><span data-line="546"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="547"><span class="sd">        id: Object index.</span>
</span><span data-line="548">
</span><span data-line="549"><span class="sd">    Returns:</span>
</span><span data-line="550"><span class="sd">        Unsigned short flags value.</span>
</span><span data-line="551"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="552">    <span class="n">offset</span> <span class="o">=</span> <span class="n">read_object_offset</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="553">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_short</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">)</span></div>

</span><span data-line="554">
</span><span data-line="555">
<div class="viewcode-block" id="read_object_position_ptr">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_object_position_ptr">[docs]</a>
</span><span data-line="556"><span class="k">def</span><span class="w"> </span><span class="nf">read_object_position_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="557"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the pointer to an object&#39;s position vector in memory.</span>
</span><span data-line="558">
</span><span data-line="559"><span class="sd">    Args:</span>
</span><span data-line="560"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="561"><span class="sd">        id: Object index.</span>
</span><span data-line="562">
</span><span data-line="563"><span class="sd">    Returns:</span>
</span><span data-line="564"><span class="sd">        Integer address for the object&#39;s position struct (0 if deleted).</span>
</span><span data-line="565"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="566">    <span class="n">offset</span> <span class="o">=</span> <span class="n">read_object_offset</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="567">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x0C</span><span class="p">)</span></div>

</span><span data-line="568">
</span><span data-line="569">
<div class="viewcode-block" id="read_object_is_ignored">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_object_is_ignored">[docs]</a>
</span><span data-line="570"><span class="k">def</span><span class="w"> </span><span class="nf">read_object_is_ignored</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="571"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine if an object should be ignored (null or ignored-flag set).</span>
</span><span data-line="572">
</span><span data-line="573"><span class="sd">    Args:</span>
</span><span data-line="574"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="575"><span class="sd">        id: Object index.</span>
</span><span data-line="576">
</span><span data-line="577"><span class="sd">    Returns:</span>
</span><span data-line="578"><span class="sd">        True if object ptr is 0 or ignored bit is set; False otherwise.</span>
</span><span data-line="579"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="580">    <span class="n">obj_ptr</span> <span class="o">=</span> <span class="n">read_object_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="581">    <span class="n">flags</span> <span class="o">=</span> <span class="n">read_object_flags</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="582">    <span class="k">return</span> <span class="n">obj_ptr</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x200</span></div>

</span><span data-line="583">
</span><span data-line="584">
<div class="viewcode-block" id="read_object_is_deleted">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_object_is_deleted">[docs]</a>
</span><span data-line="585"><span class="k">def</span><span class="w"> </span><span class="nf">read_object_is_deleted</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="586"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the object has been deleted (position pointer is null).</span>
</span><span data-line="587">
</span><span data-line="588"><span class="sd">    Args:</span>
</span><span data-line="589"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="590"><span class="sd">        id: Object index.</span>
</span><span data-line="591">
</span><span data-line="592"><span class="sd">    Returns:</span>
</span><span data-line="593"><span class="sd">        True if deleted; False otherwise.</span>
</span><span data-line="594"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="595">    <span class="n">pos_ptr</span> <span class="o">=</span> <span class="n">read_object_position_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="596">    <span class="k">return</span> <span class="n">pos_ptr</span> <span class="o">==</span> <span class="mi">0</span></div>

</span><span data-line="597">
</span><span data-line="598">
<div class="viewcode-block" id="safe_object">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.safe_object">[docs]</a>
</span><span data-line="599"><span class="k">def</span><span class="w"> </span><span class="nf">safe_object</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span data-line="600"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator that skips object reads when the object appears deleted.</span>
</span><span data-line="601">
</span><span data-line="602"><span class="sd">    The wrapped function receives `(emu, id, *args, **kwargs)`. If the object</span>
</span><span data-line="603"><span class="sd">    is deleted (null position pointer), the wrapper returns `None`.</span>
</span><span data-line="604"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="605">
</span><span data-line="606">    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="607"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal wrapper used by `safe_object` to guard deleted objects.&quot;&quot;&quot;</span>
</span><span data-line="608">        <span class="k">if</span> <span class="n">read_object_is_deleted</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
</span><span data-line="609">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="610">
</span><span data-line="611">        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="612">
</span><span data-line="613">    <span class="k">return</span> <span class="n">wrapper</span></div>

</span><span data-line="614">
</span><span data-line="615">
<div class="viewcode-block" id="read_object_position">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_object_position">[docs]</a>
</span><span data-line="616"><span class="nd">@frame_cache</span>
</span><span data-line="617"><span class="nd">@safe_object</span>
</span><span data-line="618"><span class="k">def</span><span class="w"> </span><span class="nf">read_object_position</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="619"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read an object&#39;s world-space position.</span>
</span><span data-line="620">
</span><span data-line="621"><span class="sd">    Args:</span>
</span><span data-line="622"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="623"><span class="sd">        id: Object index.</span>
</span><span data-line="624"><span class="sd">        device: Torch device for the returned tensor.</span>
</span><span data-line="625">
</span><span data-line="626"><span class="sd">    Returns:</span>
</span><span data-line="627"><span class="sd">        torch.Tensor of shape (3,) in world coordinates, or None if deleted.</span>
</span><span data-line="628"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="629">    <span class="n">pos_ptr</span> <span class="o">=</span> <span class="n">read_object_position_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="630">    <span class="n">pos</span> <span class="o">=</span> <span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="p">,</span> <span class="n">pos_ptr</span><span class="p">)</span>
</span><span data-line="631">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>

</span><span data-line="632">
</span><span data-line="633">
<div class="viewcode-block" id="read_map_object_type_id">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_map_object_type_id">[docs]</a>
</span><span data-line="634"><span class="nd">@frame_cache</span>
</span><span data-line="635"><span class="nd">@safe_object</span>
</span><span data-line="636"><span class="k">def</span><span class="w"> </span><span class="nf">read_map_object_type_id</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="637"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a map object&#39;s type ID (e.g., coin, tree, etc.).</span>
</span><span data-line="638">
</span><span data-line="639"><span class="sd">    Args:</span>
</span><span data-line="640"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="641"><span class="sd">        id: Object index.</span>
</span><span data-line="642">
</span><span data-line="643"><span class="sd">    Returns:</span>
</span><span data-line="644"><span class="sd">        Signed short type ID, or None if object is deleted.</span>
</span><span data-line="645"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="646">    <span class="n">obj_ptr</span> <span class="o">=</span> <span class="n">read_object_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="647">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_short</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">)</span></div>

</span><span data-line="648">
</span><span data-line="649">
<div class="viewcode-block" id="read_map_object_is_coin_collected">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_map_object_is_coin_collected">[docs]</a>
</span><span data-line="650"><span class="nd">@frame_cache</span>
</span><span data-line="651"><span class="nd">@safe_object</span>
</span><span data-line="652"><span class="k">def</span><span class="w"> </span><span class="nf">read_map_object_is_coin_collected</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="653"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a coin-type map object has been collected.</span>
</span><span data-line="654">
</span><span data-line="655"><span class="sd">    Args:</span>
</span><span data-line="656"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="657"><span class="sd">        id: Object index.</span>
</span><span data-line="658">
</span><span data-line="659"><span class="sd">    Returns:</span>
</span><span data-line="660"><span class="sd">        True if collected; False otherwise; or None if object is deleted.</span>
</span><span data-line="661"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="662">    <span class="n">obj_ptr</span> <span class="o">=</span> <span class="n">read_object_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="663">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_short</span><span class="p">(</span><span class="n">obj_ptr</span> <span class="o">+</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span> <span class="o">!=</span> <span class="mi">0</span></div>

</span><span data-line="664">
</span><span data-line="665">
<div class="viewcode-block" id="read_racer_object_is_ghost">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_racer_object_is_ghost">[docs]</a>
</span><span data-line="666"><span class="nd">@frame_cache</span>
</span><span data-line="667"><span class="nd">@safe_object</span>
</span><span data-line="668"><span class="k">def</span><span class="w"> </span><span class="nf">read_racer_object_is_ghost</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="669"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a racer object is currently in ghost state.</span>
</span><span data-line="670">
</span><span data-line="671"><span class="sd">    Args:</span>
</span><span data-line="672"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="673"><span class="sd">        id: Object index.</span>
</span><span data-line="674">
</span><span data-line="675"><span class="sd">    Returns:</span>
</span><span data-line="676"><span class="sd">        True if ghosted; False otherwise; or None if object is deleted.</span>
</span><span data-line="677"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="678">    <span class="n">obj_ptr</span> <span class="o">=</span> <span class="n">read_object_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="679">    <span class="n">ghost_flag</span> <span class="o">=</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">obj_ptr</span> <span class="o">+</span> <span class="mh">0x7C</span><span class="p">)</span>
</span><span data-line="680">    <span class="k">return</span> <span class="n">ghost_flag</span> <span class="o">&amp;</span> <span class="mh">0x04</span> <span class="o">!=</span> <span class="mi">0</span></div>

</span><span data-line="681">
</span><span data-line="682">
<div class="viewcode-block" id="read_objects">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_objects">[docs]</a>
</span><span data-line="683"><span class="nd">@frame_cache</span>
</span><span data-line="684"><span class="k">def</span><span class="w"> </span><span class="nf">read_objects</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="685"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Scan the global object table and group object indices by category.</span>
</span><span data-line="686">
</span><span data-line="687"><span class="sd">    Categories:</span>
</span><span data-line="688"><span class="sd">      - &#39;map_objects&#39;</span>
</span><span data-line="689"><span class="sd">      - &#39;racer_objects&#39;</span>
</span><span data-line="690"><span class="sd">      - &#39;item_objects&#39;</span>
</span><span data-line="691"><span class="sd">      - &#39;dynamic_objects&#39;</span>
</span><span data-line="692">
</span><span data-line="693"><span class="sd">    Returns:</span>
</span><span data-line="694"><span class="sd">        Dict[str, list[int]] mapping category name to list of indices.</span>
</span><span data-line="695"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="696">    <span class="n">obj_ids</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="697">        <span class="s2">&quot;map_objects&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span data-line="698">        <span class="s2">&quot;racer_objects&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span data-line="699">        <span class="s2">&quot;item_objects&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span data-line="700">        <span class="s2">&quot;dynamic_objects&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span data-line="701">    <span class="p">}</span>
</span><span data-line="702">    <span class="n">max_count</span> <span class="o">=</span> <span class="n">read_objects_array_max_count</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="703">    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="704">    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="705">    <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">255</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">!=</span> <span class="n">max_count</span><span class="p">:</span>
</span><span data-line="706">        <span class="k">if</span> <span class="n">read_object_is_deleted</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span data-line="707">            <span class="k">continue</span>
</span><span data-line="708">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="709">            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="710">
</span><span data-line="711">        <span class="k">if</span> <span class="n">read_object_is_ignored</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span data-line="712">            <span class="k">continue</span>
</span><span data-line="713">
</span><span data-line="714">        <span class="n">flags</span> <span class="o">=</span> <span class="n">read_object_flags</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span data-line="715">        <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_MAPOBJ</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="716">            <span class="n">obj_ids</span><span class="p">[</span><span class="s2">&quot;map_objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span data-line="717">        <span class="k">elif</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_RACER</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="718">            <span class="n">obj_ids</span><span class="p">[</span><span class="s2">&quot;racer_objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span data-line="719">        <span class="k">elif</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_ITEM</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="720">            <span class="n">obj_ids</span><span class="p">[</span><span class="s2">&quot;item_objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span data-line="721">        <span class="k">elif</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_DYNAMIC</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="722">            <span class="n">obj_ids</span><span class="p">[</span><span class="s2">&quot;dynamic_objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span data-line="723">
</span><span data-line="724">        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="725">
</span><span data-line="726">    <span class="k">return</span> <span class="n">obj_ids</span></div>

</span><span data-line="727">
</span><span data-line="728">
<div class="viewcode-block" id="read_camera_ptr">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_camera_ptr">[docs]</a>
</span><span data-line="729"><span class="nd">@frame_cache</span>
</span><span data-line="730"><span class="k">def</span><span class="w"> </span><span class="nf">read_camera_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CAMERA_PTR_ADDR</span><span class="p">):</span>
</span><span data-line="731"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the pointer to the active camera structure.</span>
</span><span data-line="732">
</span><span data-line="733"><span class="sd">    Args:</span>
</span><span data-line="734"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="735"><span class="sd">        addr: Address where the camera pointer is stored.</span>
</span><span data-line="736">
</span><span data-line="737"><span class="sd">    Returns:</span>
</span><span data-line="738"><span class="sd">        Integer address of the camera struct.</span>
</span><span data-line="739"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="740">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span></div>

</span><span data-line="741">
</span><span data-line="742">
<div class="viewcode-block" id="read_camera_fov">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_camera_fov">[docs]</a>
</span><span data-line="743"><span class="nd">@frame_cache</span>
</span><span data-line="744"><span class="k">def</span><span class="w"> </span><span class="nf">read_camera_fov</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="745"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the current camera field-of-view (radians).</span>
</span><span data-line="746">
</span><span data-line="747"><span class="sd">    The FOV value is stored as a 16-bit fixed-point angle; it is converted to radians.</span>
</span><span data-line="748">
</span><span data-line="749"><span class="sd">    Args:</span>
</span><span data-line="750"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="751">
</span><span data-line="752"><span class="sd">    Returns:</span>
</span><span data-line="753"><span class="sd">        Floating-point FOV in radians.</span>
</span><span data-line="754"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="755">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_camera_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="756">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_short</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mh">0x10000</span><span class="p">)</span></div>

</span><span data-line="757">
</span><span data-line="758">
<div class="viewcode-block" id="read_camera_aspect">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_camera_aspect">[docs]</a>
</span><span data-line="759"><span class="nd">@frame_cache</span>
</span><span data-line="760"><span class="k">def</span><span class="w"> </span><span class="nf">read_camera_aspect</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="761"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the camera aspect ratio from memory.</span>
</span><span data-line="762">
</span><span data-line="763"><span class="sd">    Args:</span>
</span><span data-line="764"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="765">
</span><span data-line="766"><span class="sd">    Returns:</span>
</span><span data-line="767"><span class="sd">        Float aspect ratio (width/height).</span>
</span><span data-line="768"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="769">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_camera_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="770">    <span class="k">return</span> <span class="n">read_fx32</span><span class="p">(</span><span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x6C</span><span class="p">)</span></div>

</span><span data-line="771">
</span><span data-line="772">
<div class="viewcode-block" id="read_camera_position">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_camera_position">[docs]</a>
</span><span data-line="773"><span class="nd">@frame_cache</span>
</span><span data-line="774"><span class="k">def</span><span class="w"> </span><span class="nf">read_camera_position</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="775"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the camera world position, including elevation offset.</span>
</span><span data-line="776">
</span><span data-line="777"><span class="sd">    Args:</span>
</span><span data-line="778"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="779"><span class="sd">        device: Torch device for the returned tensor.</span>
</span><span data-line="780">
</span><span data-line="781"><span class="sd">    Returns:</span>
</span><span data-line="782"><span class="sd">        torch.Tensor shape (3,) representing camera (x, y, z).</span>
</span><span data-line="783"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="784">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_camera_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="785">    <span class="n">pos</span> <span class="o">=</span> <span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x24</span><span class="p">)</span>
</span><span data-line="786">    <span class="n">elevation</span> <span class="o">=</span> <span class="n">read_fx32</span><span class="p">(</span><span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x178</span><span class="p">)</span>
</span><span data-line="787">    <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">elevation</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span data-line="788">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>

</span><span data-line="789">
</span><span data-line="790">
<div class="viewcode-block" id="read_camera_target_position">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_camera_target_position">[docs]</a>
</span><span data-line="791"><span class="k">def</span><span class="w"> </span><span class="nf">read_camera_target_position</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="792"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the camera&#39;s target/look-at position in world space.</span>
</span><span data-line="793">
</span><span data-line="794"><span class="sd">    Args:</span>
</span><span data-line="795"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="796"><span class="sd">        device: Torch device for the returned tensor.</span>
</span><span data-line="797">
</span><span data-line="798"><span class="sd">    Returns:</span>
</span><span data-line="799"><span class="sd">        torch.Tensor shape (3,) target (x, y, z).</span>
</span><span data-line="800"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="801">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_camera_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="802">    <span class="n">pos</span> <span class="o">=</span> <span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">)</span>
</span><span data-line="803">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>

</span><span data-line="804">
</span><span data-line="805">
</span><span data-line="806"><span class="k">def</span><span class="w"> </span><span class="nf">_compute_orthonormal_basis</span><span class="p">(</span>
</span><span data-line="807">    <span class="n">forward_vector_3d</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
</span><span data-line="808">    <span class="n">reference_vector_3d</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="809">    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="810"><span class="p">):</span>
</span><span data-line="811"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute a right-handed orthonormal basis given a forward vector.</span>
</span><span data-line="812">
</span><span data-line="813"><span class="sd">    Args:</span>
</span><span data-line="814"><span class="sd">        forward_vector_3d: Tensor shape (3,) forward direction.</span>
</span><span data-line="815"><span class="sd">        reference_vector_3d: Optional up-like reference; defaults to (0,1,0).</span>
</span><span data-line="816"><span class="sd">        device: Unused (kept for signature parity).</span>
</span><span data-line="817">
</span><span data-line="818"><span class="sd">    Returns:</span>
</span><span data-line="819"><span class="sd">        torch.Tensor shape (3,3) with rows [right, up, forward].</span>
</span><span data-line="820"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="821">    <span class="k">if</span> <span class="n">reference_vector_3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="822">        <span class="n">reference_vector_3d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
</span><span data-line="823">            <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
</span><span data-line="824">            <span class="n">dtype</span><span class="o">=</span><span class="n">forward_vector_3d</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span data-line="825">            <span class="n">device</span><span class="o">=</span><span class="n">forward_vector_3d</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span data-line="826">        <span class="p">)</span>
</span><span data-line="827">
</span><span data-line="828">    <span class="n">right_vector_3d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">forward_vector_3d</span><span class="p">,</span> <span class="n">reference_vector_3d</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="829">    <span class="n">right_vector_3d</span> <span class="o">/=</span> <span class="n">right_vector_3d</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
</span><span data-line="830">
</span><span data-line="831">    <span class="n">up_vector_3d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">right_vector_3d</span><span class="p">,</span> <span class="n">forward_vector_3d</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="832">    <span class="n">up_vector_3d</span> <span class="o">/=</span> <span class="n">up_vector_3d</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
</span><span data-line="833">
</span><span data-line="834">    <span class="n">basis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
</span><span data-line="835">        <span class="p">[</span>
</span><span data-line="836">            <span class="n">right_vector_3d</span><span class="p">,</span>
</span><span data-line="837">            <span class="n">up_vector_3d</span><span class="p">,</span>
</span><span data-line="838">            <span class="n">forward_vector_3d</span><span class="p">,</span>
</span><span data-line="839">        <span class="p">],</span>
</span><span data-line="840">        <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span data-line="841">    <span class="p">)</span>
</span><span data-line="842">
</span><span data-line="843">    <span class="k">return</span> <span class="n">basis</span>
</span><span data-line="844">
</span><span data-line="845">
</span><span data-line="846"><span class="k">def</span><span class="w"> </span><span class="nf">_compute_model_view</span><span class="p">(</span>
</span><span data-line="847">    <span class="n">camera_pos</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">camera_target_pos</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">device</span>
</span><span data-line="848"><span class="p">):</span>
</span><span data-line="849"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a 4x4 model-view matrix from camera position and target.</span>
</span><span data-line="850">
</span><span data-line="851"><span class="sd">    Args:</span>
</span><span data-line="852"><span class="sd">        camera_pos: Tensor shape (3,) camera world position.</span>
</span><span data-line="853"><span class="sd">        camera_target_pos: Tensor shape (3,) target look-at position.</span>
</span><span data-line="854"><span class="sd">        device: Torch device for the returned matrix.</span>
</span><span data-line="855">
</span><span data-line="856"><span class="sd">    Returns:</span>
</span><span data-line="857"><span class="sd">        torch.Tensor shape (4,4) model-view matrix.</span>
</span><span data-line="858"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="859">    <span class="n">forward</span> <span class="o">=</span> <span class="n">camera_target_pos</span> <span class="o">-</span> <span class="n">camera_pos</span>
</span><span data-line="860">    <span class="n">forward</span> <span class="o">/=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="861">
</span><span data-line="862">    <span class="n">rot</span> <span class="o">=</span> <span class="n">_compute_orthonormal_basis</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="863">
</span><span data-line="864">    <span class="n">pos_proj</span> <span class="o">=</span> <span class="n">rot</span> <span class="o">@</span> <span class="n">camera_pos</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="865">
</span><span data-line="866">    <span class="n">model_view</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">rot</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="867">    <span class="n">model_view</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot</span>
</span><span data-line="868">    <span class="n">model_view</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos_proj</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="869">
</span><span data-line="870">    <span class="k">return</span> <span class="n">model_view</span>
</span><span data-line="871">
</span><span data-line="872">
<div class="viewcode-block" id="read_model_view">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_model_view">[docs]</a>
</span><span data-line="873"><span class="nd">@frame_cache</span>
</span><span data-line="874"><span class="k">def</span><span class="w"> </span><span class="nf">read_model_view</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="875"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute and cache the camera model-view matrix for the current frame.</span>
</span><span data-line="876">
</span><span data-line="877"><span class="sd">    Args:</span>
</span><span data-line="878"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="879"><span class="sd">        device: Torch device for returned matrix.</span>
</span><span data-line="880">
</span><span data-line="881"><span class="sd">    Returns:</span>
</span><span data-line="882"><span class="sd">        torch.Tensor shape (4,4) model-view matrix.</span>
</span><span data-line="883"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="884">    <span class="n">camera_pos</span> <span class="o">=</span> <span class="n">read_camera_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="885">    <span class="n">camera_target_pos</span> <span class="o">=</span> <span class="n">read_camera_target_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="886">    <span class="k">return</span> <span class="n">_compute_model_view</span><span class="p">(</span><span class="n">camera_pos</span><span class="p">,</span> <span class="n">camera_target_pos</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>

</span><span data-line="887">
</span><span data-line="888">
</span><span data-line="889"><span class="k">def</span><span class="w"> </span><span class="nf">_project_to_screen</span><span class="p">(</span><span class="n">world_points</span><span class="p">,</span> <span class="n">model_view</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">aspect</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="890"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Project world-space points to screen coordinates using perspective projection.</span>
</span><span data-line="891">
</span><span data-line="892"><span class="sd">    Args:</span>
</span><span data-line="893"><span class="sd">        world_points: Tensor shape (N,3) of world-space points.</span>
</span><span data-line="894"><span class="sd">        model_view: Tensor shape (4,4) model-view matrix.</span>
</span><span data-line="895"><span class="sd">        fov: Field-of-view in radians (vertical half-angle usage within projection).</span>
</span><span data-line="896"><span class="sd">        aspect: Aspect ratio (width/height).</span>
</span><span data-line="897"><span class="sd">        device: Torch device for intermediate/return tensors.</span>
</span><span data-line="898">
</span><span data-line="899"><span class="sd">    Returns:</span>
</span><span data-line="900"><span class="sd">        Tensor shape (N,4): [x_px, y_px, clip_z, normalized_depth],</span>
</span><span data-line="901"><span class="sd">        where x/y are in pixel coordinates for a SCREEN_WIDTH x SCREEN_HEIGHT viewport.</span>
</span><span data-line="902"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="903">    <span class="n">N</span> <span class="o">=</span> <span class="n">world_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="904">
</span><span data-line="905">    <span class="c1"># Homogenize points</span>
</span><span data-line="906">    <span class="n">ones</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="907">    <span class="n">world_points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">world_points</span><span class="p">,</span> <span class="n">ones</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="908">    <span class="n">cam_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_view</span> <span class="o">@</span> <span class="n">world_points</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span data-line="909">
</span><span data-line="910">    <span class="c1"># Perspective projection</span>
</span><span data-line="911">    <span class="n">f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">fov</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span data-line="912">
</span><span data-line="913">    <span class="k">if</span> <span class="n">cam_space</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="914">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="915">
</span><span data-line="916">    <span class="n">fov_h</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">fov</span><span class="p">)</span>
</span><span data-line="917">    <span class="n">fov_w</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">fov</span><span class="p">)</span> <span class="o">*</span> <span class="n">aspect</span>
</span><span data-line="918">
</span><span data-line="919">    <span class="n">projection_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="920">    <span class="n">projection_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">fov_w</span>
</span><span data-line="921">    <span class="n">projection_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">fov_h</span>
</span><span data-line="922">    <span class="n">projection_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z_FAR</span> <span class="o">+</span> <span class="n">Z_NEAR</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Z_NEAR</span> <span class="o">-</span> <span class="n">Z_FAR</span><span class="p">)</span>
</span><span data-line="923">    <span class="n">projection_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Z_FAR</span> <span class="o">*</span> <span class="n">Z_NEAR</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Z_NEAR</span> <span class="o">-</span> <span class="n">Z_FAR</span><span class="p">)</span>
</span><span data-line="924">    <span class="n">projection_matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span data-line="925">
</span><span data-line="926">    <span class="n">clip_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">projection_matrix</span> <span class="o">@</span> <span class="n">cam_space</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span data-line="927">
</span><span data-line="928">    <span class="n">ndc</span> <span class="o">=</span> <span class="n">clip_space</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">clip_space</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</span><span data-line="929">
</span><span data-line="930">    <span class="n">screen_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">ndc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SCREEN_WIDTH</span>
</span><span data-line="931">    <span class="n">screen_y</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ndc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SCREEN_HEIGHT</span>
</span><span data-line="932">    <span class="n">screen_depth</span> <span class="o">=</span> <span class="n">clip_space</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
</span><span data-line="933">    <span class="n">screen_depth_norm</span> <span class="o">=</span> <span class="o">-</span><span class="n">Z_FAR</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span><span class="n">Z_FAR</span> <span class="o">+</span> <span class="n">Z_SCALE</span> <span class="o">*</span> <span class="n">clip_space</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
</span><span data-line="934">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">screen_x</span><span class="p">,</span> <span class="n">screen_y</span><span class="p">,</span> <span class="n">screen_depth</span><span class="p">,</span> <span class="n">screen_depth_norm</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="935">
</span><span data-line="936">
<div class="viewcode-block" id="project_to_screen">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.project_to_screen">[docs]</a>
</span><span data-line="937"><span class="k">def</span><span class="w"> </span><span class="nf">project_to_screen</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="938"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Convenience wrapper to project points using the current camera state.</span>
</span><span data-line="939">
</span><span data-line="940"><span class="sd">    Args:</span>
</span><span data-line="941"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="942"><span class="sd">        points: Tensor shape (N,3) of world-space points.</span>
</span><span data-line="943"><span class="sd">        device: Torch device.</span>
</span><span data-line="944">
</span><span data-line="945"><span class="sd">    Returns:</span>
</span><span data-line="946"><span class="sd">        Tensor shape (N,4) in screen space (see `_project_to_screen`).</span>
</span><span data-line="947"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="948">    <span class="n">model_view</span> <span class="o">=</span> <span class="n">read_model_view</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="949">    <span class="n">fov</span> <span class="o">=</span> <span class="n">read_camera_fov</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="950">    <span class="n">aspect</span> <span class="o">=</span> <span class="n">read_camera_aspect</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="951">    <span class="k">return</span> <span class="n">_project_to_screen</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">model_view</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">aspect</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>

</span><span data-line="952">
</span><span data-line="953">
</span><span data-line="954"><span class="c1"># CHECKPOINT INFO #</span>
</span><span data-line="955">
</span><span data-line="956">
<div class="viewcode-block" id="read_checkpoint_ptr">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_checkpoint_ptr">[docs]</a>
</span><span data-line="957"><span class="nd">@game_cache</span>
</span><span data-line="958"><span class="k">def</span><span class="w"> </span><span class="nf">read_checkpoint_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CHECKPOINT_PTR_ADDR</span><span class="p">):</span>
</span><span data-line="959"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the pointer to the checkpoint manager/state.</span>
</span><span data-line="960">
</span><span data-line="961"><span class="sd">    Args:</span>
</span><span data-line="962"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="963"><span class="sd">        addr: Address where the checkpoint pointer is stored.</span>
</span><span data-line="964">
</span><span data-line="965"><span class="sd">    Returns:</span>
</span><span data-line="966"><span class="sd">        Integer address for checkpoint data.</span>
</span><span data-line="967"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="968">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span></div>

</span><span data-line="969">
</span><span data-line="970">
<div class="viewcode-block" id="read_current_checkpoint">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_current_checkpoint">[docs]</a>
</span><span data-line="971"><span class="nd">@frame_cache</span>
</span><span data-line="972"><span class="k">def</span><span class="w"> </span><span class="nf">read_current_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="973"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the index of the current checkpoint.</span>
</span><span data-line="974">
</span><span data-line="975"><span class="sd">    Args:</span>
</span><span data-line="976"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="977">
</span><span data-line="978"><span class="sd">    Returns:</span>
</span><span data-line="979"><span class="sd">        Unsigned byte checkpoint index.</span>
</span><span data-line="980"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="981">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_checkpoint_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="982">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x46</span><span class="p">)</span></div>

</span><span data-line="983">
</span><span data-line="984">
<div class="viewcode-block" id="read_current_key_checkpoint">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_current_key_checkpoint">[docs]</a>
</span><span data-line="985"><span class="nd">@frame_cache</span>
</span><span data-line="986"><span class="k">def</span><span class="w"> </span><span class="nf">read_current_key_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="987"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the current key checkpoint index (special/lap-related).</span>
</span><span data-line="988">
</span><span data-line="989"><span class="sd">    Args:</span>
</span><span data-line="990"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="991">
</span><span data-line="992"><span class="sd">    Returns:</span>
</span><span data-line="993"><span class="sd">        Signed byte key checkpoint index.</span>
</span><span data-line="994"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="995">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_checkpoint_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="996">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">)</span></div>

</span><span data-line="997">
</span><span data-line="998">
<div class="viewcode-block" id="read_ghost_checkpoint">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_ghost_checkpoint">[docs]</a>
</span><span data-line="999"><span class="nd">@frame_cache</span>
</span><span data-line="1000"><span class="k">def</span><span class="w"> </span><span class="nf">read_ghost_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="1001"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the recorded ghost&#39;s current checkpoint index.</span>
</span><span data-line="1002">
</span><span data-line="1003"><span class="sd">    Args:</span>
</span><span data-line="1004"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1005">
</span><span data-line="1006"><span class="sd">    Returns:</span>
</span><span data-line="1007"><span class="sd">        Signed byte ghost checkpoint index.</span>
</span><span data-line="1008"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1009">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_checkpoint_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="1010">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0xD2</span><span class="p">)</span></div>

</span><span data-line="1011">
</span><span data-line="1012">
<div class="viewcode-block" id="read_ghost_key_checkpoint">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_ghost_key_checkpoint">[docs]</a>
</span><span data-line="1013"><span class="nd">@frame_cache</span>
</span><span data-line="1014"><span class="k">def</span><span class="w"> </span><span class="nf">read_ghost_key_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="1015"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the recorded ghost&#39;s current key checkpoint index.</span>
</span><span data-line="1016">
</span><span data-line="1017"><span class="sd">    Args:</span>
</span><span data-line="1018"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1019">
</span><span data-line="1020"><span class="sd">    Returns:</span>
</span><span data-line="1021"><span class="sd">        Signed byte ghost key checkpoint index.</span>
</span><span data-line="1022"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1023">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_checkpoint_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="1024">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0xD4</span><span class="p">)</span></div>

</span><span data-line="1025">
</span><span data-line="1026">
<div class="viewcode-block" id="read_current_lap">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_current_lap">[docs]</a>
</span><span data-line="1027"><span class="nd">@frame_cache</span>
</span><span data-line="1028"><span class="k">def</span><span class="w"> </span><span class="nf">read_current_lap</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="1029"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the current lap number.</span>
</span><span data-line="1030">
</span><span data-line="1031"><span class="sd">    Args:</span>
</span><span data-line="1032"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1033">
</span><span data-line="1034"><span class="sd">    Returns:</span>
</span><span data-line="1035"><span class="sd">        Signed byte lap index (0-based).</span>
</span><span data-line="1036"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1037">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_checkpoint_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="1038">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">)</span></div>

</span><span data-line="1039">
</span><span data-line="1040">
<div class="viewcode-block" id="read_next_checkpoint">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_next_checkpoint">[docs]</a>
</span><span data-line="1041"><span class="nd">@frame_cache</span>
</span><span data-line="1042"><span class="k">def</span><span class="w"> </span><span class="nf">read_next_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">checkpoint_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="1043"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the next checkpoint index (wrapping to 0 at the end).</span>
</span><span data-line="1044">
</span><span data-line="1045"><span class="sd">    Args:</span>
</span><span data-line="1046"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1047"><span class="sd">        checkpoint_count: Total number of checkpoints.</span>
</span><span data-line="1048">
</span><span data-line="1049"><span class="sd">    Returns:</span>
</span><span data-line="1050"><span class="sd">        Integer index of the next checkpoint.</span>
</span><span data-line="1051"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1052">    <span class="n">current_checkpoint</span> <span class="o">=</span> <span class="n">read_current_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="1053">    <span class="n">next_checkpoint</span> <span class="o">=</span> <span class="n">current_checkpoint</span> <span class="o">+</span> <span class="mi">1</span>
</span><span data-line="1054">    <span class="k">if</span> <span class="n">next_checkpoint</span> <span class="o">!=</span> <span class="n">checkpoint_count</span><span class="p">:</span>
</span><span data-line="1055">        <span class="k">return</span> <span class="n">next_checkpoint</span>
</span><span data-line="1056">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="1057">        <span class="k">return</span> <span class="mi">0</span></div>

</span><span data-line="1058">
</span><span data-line="1059">
</span><span data-line="1060"><span class="k">def</span><span class="w"> </span><span class="nf">_convert_2d_checkpoints</span><span class="p">(</span><span class="n">P</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span data-line="1061"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Lift 2D checkpoint endpoints into 3D by sampling the missing dimension.</span>
</span><span data-line="1062">
</span><span data-line="1063"><span class="sd">    Given 2D endpoints (e.g., XZ) and a set of floor points, fills in the</span>
</span><span data-line="1064"><span class="sd">    missing axis by nearest-neighbor on that axis.</span>
</span><span data-line="1065">
</span><span data-line="1066"><span class="sd">    Args:</span>
</span><span data-line="1067"><span class="sd">        P: Tensor shape (N,2) endpoints (with one missing dimension).</span>
</span><span data-line="1068"><span class="sd">        source: Tensor shape (M,3) of reference points (e.g., floor vertices).</span>
</span><span data-line="1069"><span class="sd">        dim: Dimension index (0/1/2) to fill in.</span>
</span><span data-line="1070">
</span><span data-line="1071"><span class="sd">    Returns:</span>
</span><span data-line="1072"><span class="sd">        Tensor shape (N,3) with the missing axis populated.</span>
</span><span data-line="1073"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1074">    <span class="n">dim_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dim</span>
</span><span data-line="1075">
</span><span data-line="1076">    <span class="n">D</span> <span class="o">=</span> <span class="n">pairwise_distances_cross</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">source</span><span class="p">[:,</span> <span class="n">dim_mask</span><span class="p">])</span>
</span><span data-line="1077">    <span class="n">min_idx</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="1078">
</span><span data-line="1079">    <span class="n">result</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">P</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1080">    <span class="n">result</span><span class="p">[:,</span> <span class="n">dim_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>
</span><span data-line="1081">    <span class="n">result</span><span class="p">[:,</span> <span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="n">min_idx</span><span class="p">,</span> <span class="n">dim</span><span class="p">]</span>
</span><span data-line="1082">
</span><span data-line="1083">    <span class="k">return</span> <span class="n">result</span>
</span><span data-line="1084">
</span><span data-line="1085">
<div class="viewcode-block" id="read_checkpoint_positions">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_checkpoint_positions">[docs]</a>
</span><span data-line="1086"><span class="nd">@game_cache</span>
</span><span data-line="1087"><span class="k">def</span><span class="w"> </span><span class="nf">read_checkpoint_positions</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="1088"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a tensor of checkpoint segment endpoints in 3D.</span>
</span><span data-line="1089">
</span><span data-line="1090"><span class="sd">    Reads NKM and KCL, extracts floor geometry, and converts checkpoint pairs</span>
</span><span data-line="1091"><span class="sd">    from 2D to 3D using nearest floor elevation.</span>
</span><span data-line="1092">
</span><span data-line="1093"><span class="sd">    Args:</span>
</span><span data-line="1094"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1095"><span class="sd">        device: Torch device.</span>
</span><span data-line="1096">
</span><span data-line="1097"><span class="sd">    Returns:</span>
</span><span data-line="1098"><span class="sd">        Tensor shape (C, 2, 3) where C is number of checkpoints,</span>
</span><span data-line="1099"><span class="sd">        containing [p1, p2] endpoints per checkpoint.</span>
</span><span data-line="1100"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1101">    <span class="n">nkm</span> <span class="o">=</span> <span class="n">load_current_nkm</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1102">    <span class="n">kcl</span> <span class="o">=</span> <span class="n">load_current_kcl</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1103">    <span class="n">floor_mask</span> <span class="o">=</span> <span class="n">kcl</span><span class="o">.</span><span class="n">prisms</span><span class="o">.</span><span class="n">is_floor</span> <span class="o">==</span> <span class="mi">1</span>
</span><span data-line="1104">    <span class="n">floor_points</span> <span class="o">=</span> <span class="n">kcl</span><span class="o">.</span><span class="n">triangles</span><span class="p">[</span><span class="n">floor_mask</span><span class="p">]</span>
</span><span data-line="1105">    <span class="n">floor_points</span> <span class="o">=</span> <span class="n">floor_points</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">floor_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span data-line="1106">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
</span><span data-line="1107">        <span class="p">[</span>
</span><span data-line="1108">            <span class="n">_convert_2d_checkpoints</span><span class="p">(</span><span class="n">nkm</span><span class="o">.</span><span class="n">_CPOI</span><span class="o">.</span><span class="n">position1</span><span class="p">,</span> <span class="n">floor_points</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span><span data-line="1109">            <span class="n">_convert_2d_checkpoints</span><span class="p">(</span><span class="n">nkm</span><span class="o">.</span><span class="n">_CPOI</span><span class="o">.</span><span class="n">position2</span><span class="p">,</span> <span class="n">floor_points</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span><span data-line="1110">        <span class="p">],</span>
</span><span data-line="1111">        <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span data-line="1112">    <span class="p">)</span></div>

</span><span data-line="1113">
</span><span data-line="1114">
<div class="viewcode-block" id="read_next_checkpoint_position">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_next_checkpoint_position">[docs]</a>
</span><span data-line="1115"><span class="nd">@frame_cache</span>
</span><span data-line="1116"><span class="k">def</span><span class="w"> </span><span class="nf">read_next_checkpoint_position</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="1117"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the 3D endpoints of the next checkpoint segment.</span>
</span><span data-line="1118">
</span><span data-line="1119"><span class="sd">    Args:</span>
</span><span data-line="1120"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1121"><span class="sd">        device: Torch device.</span>
</span><span data-line="1122">
</span><span data-line="1123"><span class="sd">    Returns:</span>
</span><span data-line="1124"><span class="sd">        Tensor shape (2,3) representing the next checkpoint&#39;s [p1, p2].</span>
</span><span data-line="1125"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1126">    <span class="n">nkm</span> <span class="o">=</span> <span class="n">load_current_nkm</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1127">    <span class="n">checkpoints</span> <span class="o">=</span> <span class="n">read_checkpoint_positions</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span data-line="1128">    <span class="n">checkpoint_count</span> <span class="o">=</span> <span class="n">nkm</span><span class="o">.</span><span class="n">_CPOI</span><span class="o">.</span><span class="n">entry_count</span>
</span><span data-line="1129">    <span class="n">next_checkpoint</span> <span class="o">=</span> <span class="n">read_next_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">checkpoint_count</span><span class="p">)</span>
</span><span data-line="1130">    <span class="k">return</span> <span class="n">checkpoints</span><span class="p">[</span><span class="n">next_checkpoint</span><span class="p">]</span></div>

</span><span data-line="1131">
</span><span data-line="1132">
<div class="viewcode-block" id="read_current_checkpoint_position">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_current_checkpoint_position">[docs]</a>
</span><span data-line="1133"><span class="nd">@frame_cache</span>
</span><span data-line="1134"><span class="k">def</span><span class="w"> </span><span class="nf">read_current_checkpoint_position</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="1135"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the 3D endpoints of the current checkpoint segment.</span>
</span><span data-line="1136">
</span><span data-line="1137"><span class="sd">    Args:</span>
</span><span data-line="1138"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1139"><span class="sd">        device: Torch device.</span>
</span><span data-line="1140">
</span><span data-line="1141"><span class="sd">    Returns:</span>
</span><span data-line="1142"><span class="sd">        Tensor shape (2,3) representing current checkpoint&#39;s [p1, p2].</span>
</span><span data-line="1143"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1144">    <span class="n">checkpoints</span> <span class="o">=</span> <span class="n">read_checkpoint_positions</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1145">    <span class="n">current_checkpoint</span> <span class="o">=</span> <span class="n">read_current_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="1146">    <span class="k">return</span> <span class="n">checkpoints</span><span class="p">[</span><span class="n">current_checkpoint</span><span class="p">]</span></div>

</span><span data-line="1147">
</span><span data-line="1148">
<div class="viewcode-block" id="read_facing_point_checkpoint">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_facing_point_checkpoint">[docs]</a>
</span><span data-line="1149"><span class="nd">@frame_cache</span>
</span><span data-line="1150"><span class="k">def</span><span class="w"> </span><span class="nf">read_facing_point_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="1151"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Raycast from the player along a direction to the next checkpoint line (XZ).</span>
</span><span data-line="1152">
</span><span data-line="1153"><span class="sd">    Args:</span>
</span><span data-line="1154"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1155"><span class="sd">        direction: Tensor shape (3,) direction vector.</span>
</span><span data-line="1156"><span class="sd">        device: Torch device.</span>
</span><span data-line="1157">
</span><span data-line="1158"><span class="sd">    Returns:</span>
</span><span data-line="1159"><span class="sd">        Tensor shape (3,) point of intersection in world coordinates.</span>
</span><span data-line="1160"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1161">    <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1162">    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">read_next_checkpoint_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span data-line="1163">    <span class="n">mask_xz</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1164">    <span class="n">pos_xz</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="n">mask_xz</span><span class="p">]</span>
</span><span data-line="1165">    <span class="n">dir_xz</span> <span class="o">=</span> <span class="n">direction</span><span class="p">[</span><span class="n">mask_xz</span><span class="p">]</span>
</span><span data-line="1166">    <span class="n">pxz_1</span><span class="p">,</span> <span class="n">pxz_2</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[:,</span> <span class="n">mask_xz</span><span class="p">]</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="1167">    <span class="n">pxz_1</span> <span class="o">=</span> <span class="n">pxz_1</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="1168">    <span class="n">pxz_2</span> <span class="o">=</span> <span class="n">pxz_2</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="1169">    <span class="n">intersect</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">intersect_ray_line_2d</span><span class="p">(</span><span class="n">pos_xz</span><span class="p">,</span> <span class="n">dir_xz</span><span class="p">,</span> <span class="n">pxz_1</span><span class="p">,</span> <span class="n">pxz_2</span><span class="p">)</span>
</span><span data-line="1170">    <span class="n">intersect</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">intersect</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">intersect</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1171">    <span class="k">return</span> <span class="n">intersect</span></div>

</span><span data-line="1172">
</span><span data-line="1173">
<div class="viewcode-block" id="read_forward_distance_checkpoint">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_forward_distance_checkpoint">[docs]</a>
</span><span data-line="1174"><span class="nd">@frame_cache</span>
</span><span data-line="1175"><span class="k">def</span><span class="w"> </span><span class="nf">read_forward_distance_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="1176"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute forward distance from player to the next checkpoint line.</span>
</span><span data-line="1177">
</span><span data-line="1178"><span class="sd">    Args:</span>
</span><span data-line="1179"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1180"><span class="sd">        device: Torch device.</span>
</span><span data-line="1181">
</span><span data-line="1182"><span class="sd">    Returns:</span>
</span><span data-line="1183"><span class="sd">        Scalar torch.Tensor distance.</span>
</span><span data-line="1184"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1185">    <span class="n">direction</span> <span class="o">=</span> <span class="n">read_direction</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1186">    <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1187">    <span class="n">ray_point</span> <span class="o">=</span> <span class="n">read_facing_point_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1188">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ray_point</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span></div>

</span><span data-line="1189">
</span><span data-line="1190">
<div class="viewcode-block" id="read_left_distance_checkpoint">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_left_distance_checkpoint">[docs]</a>
</span><span data-line="1191"><span class="nd">@frame_cache</span>
</span><span data-line="1192"><span class="k">def</span><span class="w"> </span><span class="nf">read_left_distance_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="1193"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute leftward distance from player to the next checkpoint line.</span>
</span><span data-line="1194">
</span><span data-line="1195"><span class="sd">    Args:</span>
</span><span data-line="1196"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1197"><span class="sd">        device: Torch device.</span>
</span><span data-line="1198">
</span><span data-line="1199"><span class="sd">    Returns:</span>
</span><span data-line="1200"><span class="sd">        Scalar torch.Tensor distance.</span>
</span><span data-line="1201"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1202">    <span class="n">direction</span> <span class="o">=</span> <span class="n">read_direction</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1203">    <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1204">    <span class="n">up_basis</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="1205">    <span class="n">left_basis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">up_basis</span><span class="p">)</span>
</span><span data-line="1206">    <span class="n">ray_point</span> <span class="o">=</span> <span class="n">read_facing_point_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">left_basis</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1207">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ray_point</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span></div>

</span><span data-line="1208">
</span><span data-line="1209">
<div class="viewcode-block" id="read_direction_to_checkpoint">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_direction_to_checkpoint">[docs]</a>
</span><span data-line="1210"><span class="nd">@frame_cache</span>
</span><span data-line="1211"><span class="k">def</span><span class="w"> </span><span class="nf">read_direction_to_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="1212"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute a steering angle toward the next checkpoint from forward/left distances.</span>
</span><span data-line="1213">
</span><span data-line="1214"><span class="sd">    Angle is computed as atan(forward / left).</span>
</span><span data-line="1215">
</span><span data-line="1216"><span class="sd">    Args:</span>
</span><span data-line="1217"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1218"><span class="sd">        device: Torch device.</span>
</span><span data-line="1219">
</span><span data-line="1220"><span class="sd">    Returns:</span>
</span><span data-line="1221"><span class="sd">        Scalar torch.Tensor angle in radians.</span>
</span><span data-line="1222"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1223">    <span class="n">f</span> <span class="o">=</span> <span class="n">read_forward_distance_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1224">    <span class="n">l</span> <span class="o">=</span> <span class="n">read_left_distance_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1225">    <span class="n">angle</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">f</span> <span class="o">/</span> <span class="n">l</span><span class="p">)</span>
</span><span data-line="1226">    <span class="k">return</span> <span class="n">angle</span></div>

</span><span data-line="1227">
</span><span data-line="1228">
</span><span data-line="1229"><span class="c1"># OBSTACLE INFO #</span>
</span><span data-line="1230">
</span><span data-line="1231">
<div class="viewcode-block" id="read_facing_point_obstacle">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_facing_point_obstacle">[docs]</a>
</span><span data-line="1232"><span class="nd">@frame_cache</span>
</span><span data-line="1233"><span class="k">def</span><span class="w"> </span><span class="nf">read_facing_point_obstacle</span><span class="p">(</span>
</span><span data-line="1234">    <span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span>
</span><span data-line="1235">    <span class="n">position</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1236">    <span class="n">direction</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1237">    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="1238"><span class="p">):</span>
</span><span data-line="1239"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Raycast toward walls/offroad and return the nearest hit point.</span>
</span><span data-line="1240">
</span><span data-line="1241"><span class="sd">    Samples a cone of directions around the provided (or player) direction, and</span>
</span><span data-line="1242"><span class="sd">    finds the nearest intersection against wall and offroad triangles.</span>
</span><span data-line="1243">
</span><span data-line="1244"><span class="sd">    Args:</span>
</span><span data-line="1245"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1246"><span class="sd">        position: Optional world position (3,). Defaults to player&#39;s position.</span>
</span><span data-line="1247"><span class="sd">        direction: Optional direction (3,). Defaults to player&#39;s forward vector.</span>
</span><span data-line="1248"><span class="sd">        device: Torch device.</span>
</span><span data-line="1249">
</span><span data-line="1250"><span class="sd">    Returns:</span>
</span><span data-line="1251"><span class="sd">        torch.Tensor shape (3,) hit point, or None if no intersections.</span>
</span><span data-line="1252"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1253">    <span class="k">assert</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1254">    <span class="n">kcl</span> <span class="o">=</span> <span class="n">load_current_kcl</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1255">    <span class="n">triangles</span> <span class="o">=</span> <span class="n">kcl</span><span class="o">.</span><span class="n">triangles</span>
</span><span data-line="1256">    <span class="n">wall_mask</span> <span class="o">=</span> <span class="n">kcl</span><span class="o">.</span><span class="n">prisms</span><span class="o">.</span><span class="n">is_wall</span> <span class="o">==</span> <span class="mi">1</span>
</span><span data-line="1257">    <span class="n">offroad_mask</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1258">        <span class="p">(</span><span class="n">kcl</span><span class="o">.</span><span class="n">prisms</span><span class="o">.</span><span class="n">collision_type</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
</span><span data-line="1259">        <span class="o">|</span> <span class="p">(</span><span class="n">kcl</span><span class="o">.</span><span class="n">prisms</span><span class="o">.</span><span class="n">collision_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
</span><span data-line="1260">        <span class="o">|</span> <span class="p">(</span><span class="n">kcl</span><span class="o">.</span><span class="n">prisms</span><span class="o">.</span><span class="n">collision_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
</span><span data-line="1261">    <span class="p">)</span>
</span><span data-line="1262">    <span class="n">triangles</span> <span class="o">=</span> <span class="n">triangles</span><span class="p">[</span><span class="n">wall_mask</span> <span class="o">|</span> <span class="n">offroad_mask</span><span class="p">]</span>
</span><span data-line="1263">    <span class="n">B</span> <span class="o">=</span> <span class="n">triangles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="1264">
</span><span data-line="1265">    <span class="k">if</span> <span class="n">B</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1266">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="1267">
</span><span data-line="1268">    <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span> <span class="o">=</span> <span class="n">triangles</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="1269">    <span class="n">v1</span> <span class="o">=</span> <span class="n">v1</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="1270">    <span class="n">v2</span> <span class="o">=</span> <span class="n">v2</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="1271">    <span class="n">v3</span> <span class="o">=</span> <span class="n">v3</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="1272">
</span><span data-line="1273">    <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1274">        <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1275">
</span><span data-line="1276">    <span class="k">if</span> <span class="n">direction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1277">        <span class="n">direction</span> <span class="o">=</span> <span class="n">read_direction</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1278">
</span><span data-line="1279">    <span class="n">ray_dir</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="1280">    <span class="n">angle</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1281">    <span class="n">ray_samples</span> <span class="o">=</span> <span class="n">sample_cone</span><span class="p">(</span><span class="n">ray_dir</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</span><span data-line="1282">    <span class="n">ray_dir</span> <span class="o">=</span> <span class="n">ray_dir</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span data-line="1283">    <span class="n">ray_samples</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">ray_dir</span><span class="p">,</span> <span class="n">ray_samples</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="1284">
</span><span data-line="1285">    <span class="n">ray_origin</span> <span class="o">=</span> <span class="n">position</span>
</span><span data-line="1286">    <span class="n">ray_origin</span> <span class="o">=</span> <span class="n">ray_origin</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="1287">    <span class="n">ray_origin</span> <span class="o">=</span> <span class="n">ray_origin</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span data-line="1288">    <span class="n">ray_origin_samples</span> <span class="o">=</span> <span class="n">ray_origin</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ray_samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</span><span data-line="1289">
</span><span data-line="1290">    <span class="n">points</span> <span class="o">=</span> <span class="n">triangle_raycast_batch</span><span class="p">(</span><span class="n">ray_origin_samples</span><span class="p">,</span> <span class="n">ray_samples</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">)</span>
</span><span data-line="1291">    <span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span>
</span><span data-line="1292">    <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">M</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</span><span data-line="1293">    <span class="k">if</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1294">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="1295">
</span><span data-line="1296">    <span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">ray_origin</span><span class="p">)</span>
</span><span data-line="1297">    <span class="n">min_id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
</span><span data-line="1298">    <span class="n">current_point_min</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">min_id</span><span class="p">]</span>
</span><span data-line="1299">    <span class="k">return</span> <span class="n">current_point_min</span></div>

</span><span data-line="1300">
</span><span data-line="1301">
<div class="viewcode-block" id="read_forward_distance_obstacle">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_forward_distance_obstacle">[docs]</a>
</span><span data-line="1302"><span class="nd">@frame_cache</span>
</span><span data-line="1303"><span class="k">def</span><span class="w"> </span><span class="nf">read_forward_distance_obstacle</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span data-line="1304"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute forward distance to the nearest wall/offroad obstacle.</span>
</span><span data-line="1305">
</span><span data-line="1306"><span class="sd">    Args:</span>
</span><span data-line="1307"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1308"><span class="sd">        device: Torch device.</span>
</span><span data-line="1309">
</span><span data-line="1310"><span class="sd">    Returns:</span>
</span><span data-line="1311"><span class="sd">        Scalar torch.Tensor distance; +inf if no hit.</span>
</span><span data-line="1312"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1313">    <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1314">    <span class="n">ray_point</span> <span class="o">=</span> <span class="n">read_facing_point_obstacle</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1315">    <span class="k">if</span> <span class="n">ray_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1316">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1317">
</span><span data-line="1318">    <span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">position</span> <span class="o">-</span> <span class="n">ray_point</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span data-line="1319">    <span class="k">return</span> <span class="n">dist</span></div>

</span><span data-line="1320">
</span><span data-line="1321">
<div class="viewcode-block" id="read_left_distance_obstacle">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_left_distance_obstacle">[docs]</a>
</span><span data-line="1322"><span class="nd">@frame_cache</span>
</span><span data-line="1323"><span class="k">def</span><span class="w"> </span><span class="nf">read_left_distance_obstacle</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span data-line="1324"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute leftward distance to the nearest wall/offroad obstacle.</span>
</span><span data-line="1325">
</span><span data-line="1326"><span class="sd">    Args:</span>
</span><span data-line="1327"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1328"><span class="sd">        device: Torch device.</span>
</span><span data-line="1329">
</span><span data-line="1330"><span class="sd">    Returns:</span>
</span><span data-line="1331"><span class="sd">        Scalar torch.Tensor distance; +inf if no hit.</span>
</span><span data-line="1332"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1333">    <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1334">    <span class="n">direction</span> <span class="o">=</span> <span class="n">read_direction</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1335">    <span class="n">up_basis</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="1336">    <span class="n">left_basis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">up_basis</span><span class="p">)</span>
</span><span data-line="1337">    <span class="n">ray_point</span> <span class="o">=</span> <span class="n">read_facing_point_obstacle</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">left_basis</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1338">    <span class="k">if</span> <span class="n">ray_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1339">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1340">
</span><span data-line="1341">    <span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">position</span> <span class="o">-</span> <span class="n">ray_point</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span data-line="1342">    <span class="k">return</span> <span class="n">dist</span></div>

</span><span data-line="1343">
</span><span data-line="1344">
<div class="viewcode-block" id="read_right_distance_obstacle">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_right_distance_obstacle">[docs]</a>
</span><span data-line="1345"><span class="nd">@frame_cache</span>
</span><span data-line="1346"><span class="k">def</span><span class="w"> </span><span class="nf">read_right_distance_obstacle</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span data-line="1347"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute rightward distance to the nearest wall/offroad obstacle.</span>
</span><span data-line="1348">
</span><span data-line="1349"><span class="sd">    Args:</span>
</span><span data-line="1350"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1351"><span class="sd">        device: Torch device.</span>
</span><span data-line="1352">
</span><span data-line="1353"><span class="sd">    Returns:</span>
</span><span data-line="1354"><span class="sd">        Scalar torch.Tensor distance; +inf if no hit.</span>
</span><span data-line="1355"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1356">    <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1357">    <span class="n">direction</span> <span class="o">=</span> <span class="n">read_direction</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1358">    <span class="n">up_basis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="1359">    <span class="n">right_basis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">up_basis</span><span class="p">)</span>
</span><span data-line="1360">    <span class="n">ray_point</span> <span class="o">=</span> <span class="n">read_facing_point_obstacle</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">right_basis</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1361">    <span class="k">if</span> <span class="n">ray_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1362">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1363">
</span><span data-line="1364">    <span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">position</span> <span class="o">-</span> <span class="n">ray_point</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span data-line="1365">    <span class="k">return</span> <span class="n">dist</span></div>

</span><span data-line="1366">
</span><span data-line="1367">
<div class="viewcode-block" id="read_checkpoint_distance_altitude">
<a class="viewcode-back" href="../../api/memory.html#utils.memory.read_checkpoint_distance_altitude">[docs]</a>
</span><span data-line="1368"><span class="nd">@frame_cache</span>
</span><span data-line="1369"><span class="k">def</span><span class="w"> </span><span class="nf">read_checkpoint_distance_altitude</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span data-line="1370"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the altitude (height) of the triangle formed by player and checkpoint endpoints.</span>
</span><span data-line="1371">
</span><span data-line="1372"><span class="sd">    Uses the two checkpoint endpoints and the player&#39;s position to form sides a and b,</span>
</span><span data-line="1373"><span class="sd">    then returns the triangle altitude via `triangle_altitude(a, b)`.</span>
</span><span data-line="1374">
</span><span data-line="1375"><span class="sd">    Args:</span>
</span><span data-line="1376"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1377"><span class="sd">        device: Torch device.</span>
</span><span data-line="1378">
</span><span data-line="1379"><span class="sd">    Returns:</span>
</span><span data-line="1380"><span class="sd">        Scalar torch.Tensor altitude value.</span>
</span><span data-line="1381"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1382">    <span class="n">next_checkpoint</span> <span class="o">=</span> <span class="n">read_next_checkpoint_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1383">    <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">next_checkpoint</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="1384">
</span><span data-line="1385">    <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1386">    <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span>
</span><span data-line="1387">    <span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span>
</span><span data-line="1388">    <span class="k">return</span> <span class="n">triangle_altitude</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></div>

</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2025, Blake Moody</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/shibuya.js?v=e730760c"></script></body>
</html>