<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>utils.memory - MarI/O Kart 0.0.1 documentation</title><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b1a1f93b" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=bb284d7b" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="utils.memory"/>
<meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../index.html">
      
      
      <strong>MarI/O Kart</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../OVERLAYS.html">MKDS Overlay System — Extensible Overlays for Mario Kart DS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../READING_FILES.html"><code class="docutils literal notranslate"><span class="pre">mkds</span></code> — Mario Kart DS NKM &amp; KCL Readers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../READING_MEMORY.html">MKDS Emulator I/O &amp; Geometry Utilities</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">MarI/O Kart</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">utils.memory</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for utils.memory</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="kn">from</span><span class="w"> </span><span class="nn">desmume.emulator</span><span class="w"> </span><span class="kn">import</span> <span class="n">SCREEN_WIDTH</span><span class="p">,</span> <span class="n">DeSmuME</span>
</span><span data-line="2"><span class="kn">from</span><span class="w"> </span><span class="nn">mkds.kcl</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_fx32</span>
</span><span data-line="3"><span class="kn">from</span><span class="w"> </span><span class="nn">.kcl_torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">KCLTensor</span>
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">.nkm_torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">NKMTensor</span>
</span><span data-line="5"><span class="kn">from</span><span class="w"> </span><span class="nn">mkds.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_vector_3d_fx32</span>
</span><span data-line="6"><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span data-line="7"><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span data-line="8"><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</span><span data-line="9"><span class="kn">from</span><span class="w"> </span><span class="nn">.vector</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span data-line="10">    <span class="n">pairwise_distances_cross</span><span class="p">,</span>
</span><span data-line="11">    <span class="n">intersect_ray_line_2d</span><span class="p">,</span>
</span><span data-line="12">    <span class="n">triangle_raycast_batch</span><span class="p">,</span>
</span><span data-line="13">    <span class="n">sample_cone</span><span class="p">,</span>
</span><span data-line="14">    <span class="n">triangle_altitude</span><span class="p">,</span>
</span><span data-line="15"><span class="p">)</span>
</span><span data-line="16"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Concatenate</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">ParamSpec</span>
</span><span data-line="17">
</span><span data-line="18"><span class="n">P</span> <span class="o">=</span> <span class="n">ParamSpec</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
</span><span data-line="19"><span class="n">R</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">)</span>
</span><span data-line="20">
</span><span data-line="21"><span class="n">SCREEN_WIDTH</span><span class="p">,</span> <span class="n">SCREEN_HEIGHT</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">192</span>
</span><span data-line="22"><span class="n">Z_FAR</span> <span class="o">=</span> <span class="mf">1000.0</span>
</span><span data-line="23"><span class="n">Z_NEAR</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span data-line="24"><span class="n">Z_SCALE</span> <span class="o">=</span> <span class="mf">10.0</span>
</span><span data-line="25">
</span><span data-line="26"><span class="n">RACER_PTR_ADDR</span> <span class="o">=</span> <span class="mh">0x0217ACF8</span>
</span><span data-line="27"><span class="n">COURSE_ID_ADDR</span> <span class="o">=</span> <span class="mh">0x23CDCD8</span>
</span><span data-line="28"><span class="n">OBJECTS_PTR_ADDR</span> <span class="o">=</span> <span class="mh">0x0217B588</span>
</span><span data-line="29"><span class="n">CHECKPOINT_PTR_ADDR</span> <span class="o">=</span> <span class="mh">0x021755FC</span>
</span><span data-line="30"><span class="n">CLOCK_DATA_PTR</span> <span class="o">=</span> <span class="mh">0x0217AA34</span>
</span><span data-line="31"><span class="n">CAMERA_PTR_ADDR</span> <span class="o">=</span> <span class="mh">0x0217AA4C</span>
</span><span data-line="32">
</span><span data-line="33"><span class="c1"># Object flags</span>
</span><span data-line="34"><span class="n">FLAG_DYNAMIC</span> <span class="o">=</span> <span class="mh">0x1000</span>
</span><span data-line="35"><span class="n">FLAG_MAPOBJ</span> <span class="o">=</span> <span class="mh">0x2000</span>
</span><span data-line="36"><span class="n">FLAG_ITEM</span> <span class="o">=</span> <span class="mh">0x4000</span>
</span><span data-line="37"><span class="n">FLAG_RACER</span> <span class="o">=</span> <span class="mh">0x8000</span>
</span><span data-line="38">
</span><span data-line="39">
<div class="viewcode-block" id="frame_cache">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.frame_cache">[docs]</a>
</span><span data-line="40"><span class="k">def</span><span class="w"> </span><span class="nf">frame_cache</span><span class="p">(</span>
</span><span data-line="41">    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">Concatenate</span><span class="p">[</span><span class="n">DeSmuME</span><span class="p">,</span> <span class="n">P</span><span class="p">],</span> <span class="n">R</span><span class="p">],</span>
</span><span data-line="42"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">Concatenate</span><span class="p">[</span><span class="n">DeSmuME</span><span class="p">,</span> <span class="n">P</span><span class="p">],</span> <span class="n">R</span><span class="p">]:</span>
</span><span data-line="43"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator that caches a function&#39;s return value once per emulator tick.</span>
</span><span data-line="44">
</span><span data-line="45"><span class="sd">    The wrapped function will only be re-executed when `emu.get_ticks()` changes.</span>
</span><span data-line="46"><span class="sd">    Useful for expensive reads that don&#39;t change within a single frame.</span>
</span><span data-line="47">
</span><span data-line="48"><span class="sd">    Args:</span>
</span><span data-line="49"><span class="sd">        func: A function whose first argument is a `DeSmuME` instance.</span>
</span><span data-line="50">
</span><span data-line="51"><span class="sd">    Returns:</span>
</span><span data-line="52"><span class="sd">        A wrapped function with identical signature that returns a cached result per tick.</span>
</span><span data-line="53"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="54">    <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="55">    <span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="56">
</span><span data-line="57">    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
</span><span data-line="58"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal wrapper used by `frame_cache` to perform per-tick memoization.&quot;&quot;&quot;</span>
</span><span data-line="59">        <span class="k">nonlocal</span> <span class="n">frame_count</span><span class="p">,</span> <span class="n">val</span>
</span><span data-line="60">        <span class="k">if</span> <span class="n">emu</span><span class="o">.</span><span class="n">get_ticks</span><span class="p">()</span> <span class="o">!=</span> <span class="n">frame_count</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="61">            <span class="n">frame_count</span> <span class="o">=</span> <span class="n">emu</span><span class="o">.</span><span class="n">get_ticks</span><span class="p">()</span>
</span><span data-line="62">            <span class="n">val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="63">
</span><span data-line="64">        <span class="k">return</span> <span class="n">val</span>
</span><span data-line="65">
</span><span data-line="66">    <span class="k">return</span> <span class="n">wrapper</span></div>

</span><span data-line="67">
</span><span data-line="68">
<div class="viewcode-block" id="game_cache">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.game_cache">[docs]</a>
</span><span data-line="69"><span class="k">def</span><span class="w"> </span><span class="nf">game_cache</span><span class="p">(</span>
</span><span data-line="70">    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">Concatenate</span><span class="p">[</span><span class="n">DeSmuME</span><span class="p">,</span> <span class="n">P</span><span class="p">],</span> <span class="n">R</span><span class="p">],</span>
</span><span data-line="71"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="n">Concatenate</span><span class="p">[</span><span class="n">DeSmuME</span><span class="p">,</span> <span class="n">P</span><span class="p">],</span> <span class="n">R</span><span class="p">]:</span>
</span><span data-line="72"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator that caches a function&#39;s return value for the process lifetime.</span>
</span><span data-line="73">
</span><span data-line="74"><span class="sd">    The wrapped function executes once and its result is reused thereafter.</span>
</span><span data-line="75"><span class="sd">    Appropriate for data that remains constant across a run (e.g., course files).</span>
</span><span data-line="76">
</span><span data-line="77"><span class="sd">    Args:</span>
</span><span data-line="78"><span class="sd">        func: A function whose first argument is a `DeSmuME` instance.</span>
</span><span data-line="79">
</span><span data-line="80"><span class="sd">    Returns:</span>
</span><span data-line="81"><span class="sd">        A wrapped function with identical signature that returns a cached result.</span>
</span><span data-line="82"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="83">    <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="84">
</span><span data-line="85">    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
</span><span data-line="86"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal wrapper used by `game_cache` to memoize across the entire run.&quot;&quot;&quot;</span>
</span><span data-line="87">        <span class="k">nonlocal</span> <span class="n">val</span>
</span><span data-line="88">        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="89">            <span class="n">val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="90">
</span><span data-line="91">        <span class="k">return</span> <span class="n">val</span>
</span><span data-line="92">
</span><span data-line="93">    <span class="k">return</span> <span class="n">wrapper</span></div>

</span><span data-line="94">
</span><span data-line="95">
<div class="viewcode-block" id="z_clip_mask">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.z_clip_mask">[docs]</a>
</span><span data-line="96"><span class="k">def</span><span class="w"> </span><span class="nf">z_clip_mask</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span data-line="97"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute a boolean mask for points within the view frustum Z range.</span>
</span><span data-line="98">
</span><span data-line="99"><span class="sd">    Args:</span>
</span><span data-line="100"><span class="sd">        x: Tensor of shape (N, 3+) where x[:, 2] is the camera-space Z.</span>
</span><span data-line="101">
</span><span data-line="102"><span class="sd">    Returns:</span>
</span><span data-line="103"><span class="sd">        A boolean tensor of shape (N,) where True indicates Z is between -Z_FAR and -Z_NEAR.</span>
</span><span data-line="104"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="105">    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">Z_NEAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">Z_FAR</span><span class="p">)</span></div>

</span><span data-line="106">
</span><span data-line="107">
<div class="viewcode-block" id="read_clock_ptr">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_clock_ptr">[docs]</a>
</span><span data-line="108"><span class="nd">@game_cache</span>
</span><span data-line="109"><span class="k">def</span><span class="w"> </span><span class="nf">read_clock_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="110"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the base pointer to the game&#39;s clock data structure.</span>
</span><span data-line="111">
</span><span data-line="112"><span class="sd">    Args:</span>
</span><span data-line="113"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="114">
</span><span data-line="115"><span class="sd">    Returns:</span>
</span><span data-line="116"><span class="sd">        Integer address of the clock data struct.</span>
</span><span data-line="117"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="118">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">CLOCK_DATA_PTR</span><span class="p">)</span></div>

</span><span data-line="119">
</span><span data-line="120">
<div class="viewcode-block" id="read_clock">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_clock">[docs]</a>
</span><span data-line="121"><span class="nd">@frame_cache</span>
</span><span data-line="122"><span class="k">def</span><span class="w"> </span><span class="nf">read_clock</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="123"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the current game clock value.</span>
</span><span data-line="124">
</span><span data-line="125"><span class="sd">    The value is read from the clock data structure and multiplied by 10,</span>
</span><span data-line="126"><span class="sd">    resulting in units of 10 ms (centiseconds).</span>
</span><span data-line="127">
</span><span data-line="128"><span class="sd">    Args:</span>
</span><span data-line="129"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="130">
</span><span data-line="131"><span class="sd">    Returns:</span>
</span><span data-line="132"><span class="sd">        Integer time in 10 ms units.</span>
</span><span data-line="133"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="134">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_clock_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="135">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span></div>

</span><span data-line="136">
</span><span data-line="137">
<div class="viewcode-block" id="get_current_course_id">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.get_current_course_id">[docs]</a>
</span><span data-line="138"><span class="k">def</span><span class="w"> </span><span class="nf">get_current_course_id</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="139"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the current course ID from memory.</span>
</span><span data-line="140">
</span><span data-line="141"><span class="sd">    Args:</span>
</span><span data-line="142"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="143">
</span><span data-line="144"><span class="sd">    Returns:</span>
</span><span data-line="145"><span class="sd">        Integer course ID (byte).</span>
</span><span data-line="146"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="147">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">COURSE_ID_ADDR</span><span class="p">)</span></div>

</span><span data-line="148">
</span><span data-line="149">
<div class="viewcode-block" id="get_course_path">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.get_course_path">[docs]</a>
</span><span data-line="150"><span class="k">def</span><span class="w"> </span><span class="nf">get_course_path</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="151"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="152"><span class="sd">    Resolve a course ID to the local filesystem path for its assets.</span>
</span><span data-line="153">
</span><span data-line="154"><span class="sd">    Args:</span>
</span><span data-line="155"><span class="sd">        id: Course ID.</span>
</span><span data-line="156">
</span><span data-line="157"><span class="sd">    Returns:</span>
</span><span data-line="158"><span class="sd">        String path relative to ./courses/ for the given course.</span>
</span><span data-line="159">
</span><span data-line="160"><span class="sd">    Raises:</span>
</span><span data-line="161"><span class="sd">        AssertionError: If the course ID is not present in the lookup table.</span>
</span><span data-line="162"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="163">    <span class="n">course_id_lookup</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="164">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;utils/courses.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span data-line="165">        <span class="n">course_id_lookup</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span data-line="166">
</span><span data-line="167">    <span class="k">assert</span> <span class="n">course_id_lookup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="168">    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">course_id_lookup</span>
</span><span data-line="169">    <span class="k">return</span> <span class="n">course_id_lookup</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)]</span></div>

</span><span data-line="170">
</span><span data-line="171">
<div class="viewcode-block" id="load_current_kcl">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.load_current_kcl">[docs]</a>
</span><span data-line="172"><span class="nd">@game_cache</span>
</span><span data-line="173"><span class="k">def</span><span class="w"> </span><span class="nf">load_current_kcl</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="174"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Load and parse the KCL collision file for the current course.</span>
</span><span data-line="175">
</span><span data-line="176"><span class="sd">    Cached for the lifetime of the process.</span>
</span><span data-line="177">
</span><span data-line="178"><span class="sd">    Args:</span>
</span><span data-line="179"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="180"><span class="sd">        device: Torch device (e.g., &#39;cpu&#39;, &#39;cuda&#39;, &#39;mps&#39;) to store tensors on.</span>
</span><span data-line="181">
</span><span data-line="182"><span class="sd">    Returns:</span>
</span><span data-line="183"><span class="sd">        `KCLTensor` with triangle and prism data on the specified device.</span>
</span><span data-line="184"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="185">    <span class="k">assert</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="186">    <span class="nb">id</span> <span class="o">=</span> <span class="n">get_current_course_id</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="187">    <span class="n">path</span> <span class="o">=</span> <span class="n">get_course_path</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span data-line="188">    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./courses/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/course_collision.kcl&quot;</span>
</span><span data-line="189">    <span class="n">kcl</span> <span class="o">=</span> <span class="n">KCLTensor</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="190">    <span class="k">return</span> <span class="n">kcl</span></div>

</span><span data-line="191">
</span><span data-line="192">
<div class="viewcode-block" id="load_current_nkm">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.load_current_nkm">[docs]</a>
</span><span data-line="193"><span class="nd">@game_cache</span>
</span><span data-line="194"><span class="k">def</span><span class="w"> </span><span class="nf">load_current_nkm</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="195"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Load and parse the NKM map file for the current course.</span>
</span><span data-line="196">
</span><span data-line="197"><span class="sd">    Cached for the lifetime of the process.</span>
</span><span data-line="198">
</span><span data-line="199"><span class="sd">    Args:</span>
</span><span data-line="200"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="201"><span class="sd">        device: Torch device to store tensors on.</span>
</span><span data-line="202">
</span><span data-line="203"><span class="sd">    Returns:</span>
</span><span data-line="204"><span class="sd">        `NKMTensor` with NKM section tensors (e.g., checkpoints) on the specified device.</span>
</span><span data-line="205"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="206">    <span class="k">assert</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="207">    <span class="nb">id</span> <span class="o">=</span> <span class="n">get_current_course_id</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="208">    <span class="n">path</span> <span class="o">=</span> <span class="n">get_course_path</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span data-line="209">    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./courses/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/course_map.nkm&quot;</span>
</span><span data-line="210">    <span class="n">nkm</span> <span class="o">=</span> <span class="n">NKMTensor</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="211">    <span class="k">return</span> <span class="n">nkm</span></div>

</span><span data-line="212">
</span><span data-line="213">
<div class="viewcode-block" id="read_racer_ptr">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_racer_ptr">[docs]</a>
</span><span data-line="214"><span class="k">def</span><span class="w"> </span><span class="nf">read_racer_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">RACER_PTR_ADDR</span><span class="p">):</span>
</span><span data-line="215"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the pointer to the player&#39;s racer object.</span>
</span><span data-line="216">
</span><span data-line="217"><span class="sd">    Args:</span>
</span><span data-line="218"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="219"><span class="sd">        addr: Memory address where the racer pointer is stored.</span>
</span><span data-line="220">
</span><span data-line="221"><span class="sd">    Returns:</span>
</span><span data-line="222"><span class="sd">        Integer address of the racer structure.</span>
</span><span data-line="223"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="224">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span></div>

</span><span data-line="225">
</span><span data-line="226">
<div class="viewcode-block" id="read_position">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_position">[docs]</a>
</span><span data-line="227"><span class="nd">@frame_cache</span>
</span><span data-line="228"><span class="k">def</span><span class="w"> </span><span class="nf">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="229"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the player&#39;s world-space position.</span>
</span><span data-line="230">
</span><span data-line="231"><span class="sd">    Args:</span>
</span><span data-line="232"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="233"><span class="sd">        device: Torch device for the returned tensor.</span>
</span><span data-line="234">
</span><span data-line="235"><span class="sd">    Returns:</span>
</span><span data-line="236"><span class="sd">        torch.Tensor of shape (3,) representing (x, y, z) in world units.</span>
</span><span data-line="237"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="238">    <span class="n">data</span> <span class="o">=</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span>
</span><span data-line="239">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_racer_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="240">    <span class="n">pos</span> <span class="o">=</span> <span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">)</span>
</span><span data-line="241">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>

</span><span data-line="242">
</span><span data-line="243">
<div class="viewcode-block" id="read_direction">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_direction">[docs]</a>
</span><span data-line="244"><span class="nd">@frame_cache</span>
</span><span data-line="245"><span class="k">def</span><span class="w"> </span><span class="nf">read_direction</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="246"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the player&#39;s forward direction vector (world-space).</span>
</span><span data-line="247">
</span><span data-line="248"><span class="sd">    Args:</span>
</span><span data-line="249"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="250"><span class="sd">        device: Torch device for the returned tensor.</span>
</span><span data-line="251">
</span><span data-line="252"><span class="sd">    Returns:</span>
</span><span data-line="253"><span class="sd">        torch.Tensor of shape (3,) representing the forward direction.</span>
</span><span data-line="254"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="255">    <span class="n">data</span> <span class="o">=</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span>
</span><span data-line="256">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_racer_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="257">    <span class="n">pos</span> <span class="o">=</span> <span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">)</span>
</span><span data-line="258">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>

</span><span data-line="259">
</span><span data-line="260">
<div class="viewcode-block" id="read_objects_array_max_count">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_objects_array_max_count">[docs]</a>
</span><span data-line="261"><span class="k">def</span><span class="w"> </span><span class="nf">read_objects_array_max_count</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">OBJECTS_PTR_ADDR</span><span class="p">):</span>
</span><span data-line="262"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the maximum number of objects in the global object array.</span>
</span><span data-line="263">
</span><span data-line="264"><span class="sd">    Args:</span>
</span><span data-line="265"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="266"><span class="sd">        addr: Base address of the object array metadata.</span>
</span><span data-line="267">
</span><span data-line="268"><span class="sd">    Returns:</span>
</span><span data-line="269"><span class="sd">        Signed integer max count.</span>
</span><span data-line="270"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="271">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">)</span></div>

</span><span data-line="272">
</span><span data-line="273">
<div class="viewcode-block" id="read_objects_array_ptr">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_objects_array_ptr">[docs]</a>
</span><span data-line="274"><span class="k">def</span><span class="w"> </span><span class="nf">read_objects_array_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">OBJECTS_PTR_ADDR</span><span class="p">):</span>
</span><span data-line="275"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the pointer to the global object pointer array.</span>
</span><span data-line="276">
</span><span data-line="277"><span class="sd">    Args:</span>
</span><span data-line="278"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="279"><span class="sd">        addr: Base address of the object array metadata.</span>
</span><span data-line="280">
</span><span data-line="281"><span class="sd">    Returns:</span>
</span><span data-line="282"><span class="sd">        Signed integer address of the object pointer array.</span>
</span><span data-line="283"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="284">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span></div>

</span><span data-line="285">
</span><span data-line="286">
<div class="viewcode-block" id="read_object_offset">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_object_offset">[docs]</a>
</span><span data-line="287"><span class="k">def</span><span class="w"> </span><span class="nf">read_object_offset</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="288"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the memory offset of an object entry within the array.</span>
</span><span data-line="289">
</span><span data-line="290"><span class="sd">    Args:</span>
</span><span data-line="291"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="292"><span class="sd">        id: Object index.</span>
</span><span data-line="293">
</span><span data-line="294"><span class="sd">    Returns:</span>
</span><span data-line="295"><span class="sd">        Integer byte offset to the object&#39;s metadata entry.</span>
</span><span data-line="296"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="297">    <span class="k">return</span> <span class="n">read_objects_array_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span> <span class="o">+</span> <span class="nb">id</span> <span class="o">*</span> <span class="mh">0x1C</span></div>

</span><span data-line="298">
</span><span data-line="299">
<div class="viewcode-block" id="read_object_ptr">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_object_ptr">[docs]</a>
</span><span data-line="300"><span class="k">def</span><span class="w"> </span><span class="nf">read_object_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="301"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the object instance pointer for a given object ID.</span>
</span><span data-line="302">
</span><span data-line="303"><span class="sd">    Args:</span>
</span><span data-line="304"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="305"><span class="sd">        id: Object index.</span>
</span><span data-line="306">
</span><span data-line="307"><span class="sd">    Returns:</span>
</span><span data-line="308"><span class="sd">        Integer address of the object struct (0 if null).</span>
</span><span data-line="309"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="310">    <span class="n">offset</span> <span class="o">=</span> <span class="n">read_object_offset</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="311">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">)</span></div>

</span><span data-line="312">
</span><span data-line="313">
<div class="viewcode-block" id="read_object_flags">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_object_flags">[docs]</a>
</span><span data-line="314"><span class="k">def</span><span class="w"> </span><span class="nf">read_object_flags</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="315"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the object&#39;s flags (type/category bits, state, etc.).</span>
</span><span data-line="316">
</span><span data-line="317"><span class="sd">    Args:</span>
</span><span data-line="318"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="319"><span class="sd">        id: Object index.</span>
</span><span data-line="320">
</span><span data-line="321"><span class="sd">    Returns:</span>
</span><span data-line="322"><span class="sd">        Unsigned short flags value.</span>
</span><span data-line="323"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="324">    <span class="n">offset</span> <span class="o">=</span> <span class="n">read_object_offset</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="325">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_short</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">)</span></div>

</span><span data-line="326">
</span><span data-line="327">
<div class="viewcode-block" id="read_object_position_ptr">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_object_position_ptr">[docs]</a>
</span><span data-line="328"><span class="k">def</span><span class="w"> </span><span class="nf">read_object_position_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="329"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the pointer to an object&#39;s position vector in memory.</span>
</span><span data-line="330">
</span><span data-line="331"><span class="sd">    Args:</span>
</span><span data-line="332"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="333"><span class="sd">        id: Object index.</span>
</span><span data-line="334">
</span><span data-line="335"><span class="sd">    Returns:</span>
</span><span data-line="336"><span class="sd">        Integer address for the object&#39;s position struct (0 if deleted).</span>
</span><span data-line="337"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="338">    <span class="n">offset</span> <span class="o">=</span> <span class="n">read_object_offset</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="339">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mh">0x0C</span><span class="p">)</span></div>

</span><span data-line="340">
</span><span data-line="341">
<div class="viewcode-block" id="read_object_is_ignored">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_object_is_ignored">[docs]</a>
</span><span data-line="342"><span class="k">def</span><span class="w"> </span><span class="nf">read_object_is_ignored</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="343"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine if an object should be ignored (null or ignored-flag set).</span>
</span><span data-line="344">
</span><span data-line="345"><span class="sd">    Args:</span>
</span><span data-line="346"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="347"><span class="sd">        id: Object index.</span>
</span><span data-line="348">
</span><span data-line="349"><span class="sd">    Returns:</span>
</span><span data-line="350"><span class="sd">        True if object ptr is 0 or ignored bit is set; False otherwise.</span>
</span><span data-line="351"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="352">    <span class="n">obj_ptr</span> <span class="o">=</span> <span class="n">read_object_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="353">    <span class="n">flags</span> <span class="o">=</span> <span class="n">read_object_flags</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="354">    <span class="k">return</span> <span class="n">obj_ptr</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x200</span></div>

</span><span data-line="355">
</span><span data-line="356">
<div class="viewcode-block" id="read_object_is_deleted">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_object_is_deleted">[docs]</a>
</span><span data-line="357"><span class="k">def</span><span class="w"> </span><span class="nf">read_object_is_deleted</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="358"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the object has been deleted (position pointer is null).</span>
</span><span data-line="359">
</span><span data-line="360"><span class="sd">    Args:</span>
</span><span data-line="361"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="362"><span class="sd">        id: Object index.</span>
</span><span data-line="363">
</span><span data-line="364"><span class="sd">    Returns:</span>
</span><span data-line="365"><span class="sd">        True if deleted; False otherwise.</span>
</span><span data-line="366"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="367">    <span class="n">pos_ptr</span> <span class="o">=</span> <span class="n">read_object_position_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="368">    <span class="k">return</span> <span class="n">pos_ptr</span> <span class="o">==</span> <span class="mi">0</span></div>

</span><span data-line="369">
</span><span data-line="370">
<div class="viewcode-block" id="safe_object">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.safe_object">[docs]</a>
</span><span data-line="371"><span class="k">def</span><span class="w"> </span><span class="nf">safe_object</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span data-line="372"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator that skips object reads when the object appears deleted.</span>
</span><span data-line="373">
</span><span data-line="374"><span class="sd">    The wrapped function receives `(emu, id, *args, **kwargs)`. If the object</span>
</span><span data-line="375"><span class="sd">    is deleted (null position pointer), the wrapper returns `None`.</span>
</span><span data-line="376"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="377">
</span><span data-line="378">    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="379"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal wrapper used by `safe_object` to guard deleted objects.&quot;&quot;&quot;</span>
</span><span data-line="380">        <span class="k">if</span> <span class="n">read_object_is_deleted</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
</span><span data-line="381">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="382">
</span><span data-line="383">        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="384">
</span><span data-line="385">    <span class="k">return</span> <span class="n">wrapper</span></div>

</span><span data-line="386">
</span><span data-line="387">
<div class="viewcode-block" id="read_object_position">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_object_position">[docs]</a>
</span><span data-line="388"><span class="nd">@frame_cache</span>
</span><span data-line="389"><span class="nd">@safe_object</span>
</span><span data-line="390"><span class="k">def</span><span class="w"> </span><span class="nf">read_object_position</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="391"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read an object&#39;s world-space position.</span>
</span><span data-line="392">
</span><span data-line="393"><span class="sd">    Args:</span>
</span><span data-line="394"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="395"><span class="sd">        id: Object index.</span>
</span><span data-line="396"><span class="sd">        device: Torch device for the returned tensor.</span>
</span><span data-line="397">
</span><span data-line="398"><span class="sd">    Returns:</span>
</span><span data-line="399"><span class="sd">        torch.Tensor of shape (3,) in world coordinates, or None if deleted.</span>
</span><span data-line="400"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="401">    <span class="n">pos_ptr</span> <span class="o">=</span> <span class="n">read_object_position_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="402">    <span class="n">pos</span> <span class="o">=</span> <span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="p">,</span> <span class="n">pos_ptr</span><span class="p">)</span>
</span><span data-line="403">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>

</span><span data-line="404">
</span><span data-line="405">
<div class="viewcode-block" id="read_map_object_type_id">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_map_object_type_id">[docs]</a>
</span><span data-line="406"><span class="nd">@frame_cache</span>
</span><span data-line="407"><span class="nd">@safe_object</span>
</span><span data-line="408"><span class="k">def</span><span class="w"> </span><span class="nf">read_map_object_type_id</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="409"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a map object&#39;s type ID (e.g., coin, tree, etc.).</span>
</span><span data-line="410">
</span><span data-line="411"><span class="sd">    Args:</span>
</span><span data-line="412"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="413"><span class="sd">        id: Object index.</span>
</span><span data-line="414">
</span><span data-line="415"><span class="sd">    Returns:</span>
</span><span data-line="416"><span class="sd">        Signed short type ID, or None if object is deleted.</span>
</span><span data-line="417"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="418">    <span class="n">obj_ptr</span> <span class="o">=</span> <span class="n">read_object_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="419">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_short</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">)</span></div>

</span><span data-line="420">
</span><span data-line="421">
<div class="viewcode-block" id="read_map_object_is_coin_collected">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_map_object_is_coin_collected">[docs]</a>
</span><span data-line="422"><span class="nd">@frame_cache</span>
</span><span data-line="423"><span class="nd">@safe_object</span>
</span><span data-line="424"><span class="k">def</span><span class="w"> </span><span class="nf">read_map_object_is_coin_collected</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="425"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a coin-type map object has been collected.</span>
</span><span data-line="426">
</span><span data-line="427"><span class="sd">    Args:</span>
</span><span data-line="428"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="429"><span class="sd">        id: Object index.</span>
</span><span data-line="430">
</span><span data-line="431"><span class="sd">    Returns:</span>
</span><span data-line="432"><span class="sd">        True if collected; False otherwise; or None if object is deleted.</span>
</span><span data-line="433"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="434">    <span class="n">obj_ptr</span> <span class="o">=</span> <span class="n">read_object_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="435">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_short</span><span class="p">(</span><span class="n">obj_ptr</span> <span class="o">+</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span> <span class="o">!=</span> <span class="mi">0</span></div>

</span><span data-line="436">
</span><span data-line="437">
<div class="viewcode-block" id="read_racer_object_is_ghost">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_racer_object_is_ghost">[docs]</a>
</span><span data-line="438"><span class="nd">@frame_cache</span>
</span><span data-line="439"><span class="nd">@safe_object</span>
</span><span data-line="440"><span class="k">def</span><span class="w"> </span><span class="nf">read_racer_object_is_ghost</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="441"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a racer object is currently in ghost state.</span>
</span><span data-line="442">
</span><span data-line="443"><span class="sd">    Args:</span>
</span><span data-line="444"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="445"><span class="sd">        id: Object index.</span>
</span><span data-line="446">
</span><span data-line="447"><span class="sd">    Returns:</span>
</span><span data-line="448"><span class="sd">        True if ghosted; False otherwise; or None if object is deleted.</span>
</span><span data-line="449"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="450">    <span class="n">obj_ptr</span> <span class="o">=</span> <span class="n">read_object_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span data-line="451">    <span class="n">ghost_flag</span> <span class="o">=</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">obj_ptr</span> <span class="o">+</span> <span class="mh">0x7C</span><span class="p">)</span>
</span><span data-line="452">    <span class="k">return</span> <span class="n">ghost_flag</span> <span class="o">&amp;</span> <span class="mh">0x04</span> <span class="o">!=</span> <span class="mi">0</span></div>

</span><span data-line="453">
</span><span data-line="454">
<div class="viewcode-block" id="read_objects">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_objects">[docs]</a>
</span><span data-line="455"><span class="nd">@frame_cache</span>
</span><span data-line="456"><span class="k">def</span><span class="w"> </span><span class="nf">read_objects</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="457"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Scan the global object table and group object indices by category.</span>
</span><span data-line="458">
</span><span data-line="459"><span class="sd">    Categories:</span>
</span><span data-line="460"><span class="sd">      - &#39;map_objects&#39;</span>
</span><span data-line="461"><span class="sd">      - &#39;racer_objects&#39;</span>
</span><span data-line="462"><span class="sd">      - &#39;item_objects&#39;</span>
</span><span data-line="463"><span class="sd">      - &#39;dynamic_objects&#39;</span>
</span><span data-line="464">
</span><span data-line="465"><span class="sd">    Returns:</span>
</span><span data-line="466"><span class="sd">        Dict[str, list[int]] mapping category name to list of indices.</span>
</span><span data-line="467"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="468">    <span class="n">obj_ids</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="469">        <span class="s2">&quot;map_objects&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span data-line="470">        <span class="s2">&quot;racer_objects&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span data-line="471">        <span class="s2">&quot;item_objects&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span data-line="472">        <span class="s2">&quot;dynamic_objects&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span data-line="473">    <span class="p">}</span>
</span><span data-line="474">    <span class="n">max_count</span> <span class="o">=</span> <span class="n">read_objects_array_max_count</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="475">    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="476">    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="477">    <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">255</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">!=</span> <span class="n">max_count</span><span class="p">:</span>
</span><span data-line="478">        <span class="k">if</span> <span class="n">read_object_is_deleted</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span data-line="479">            <span class="k">continue</span>
</span><span data-line="480">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="481">            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="482">
</span><span data-line="483">        <span class="k">if</span> <span class="n">read_object_is_ignored</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span data-line="484">            <span class="k">continue</span>
</span><span data-line="485">
</span><span data-line="486">        <span class="n">flags</span> <span class="o">=</span> <span class="n">read_object_flags</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span data-line="487">        <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_MAPOBJ</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="488">            <span class="n">obj_ids</span><span class="p">[</span><span class="s2">&quot;map_objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span data-line="489">        <span class="k">elif</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_RACER</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="490">            <span class="n">obj_ids</span><span class="p">[</span><span class="s2">&quot;racer_objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span data-line="491">        <span class="k">elif</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_ITEM</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="492">            <span class="n">obj_ids</span><span class="p">[</span><span class="s2">&quot;item_objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span data-line="493">        <span class="k">elif</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_DYNAMIC</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="494">            <span class="n">obj_ids</span><span class="p">[</span><span class="s2">&quot;dynamic_objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span data-line="495">
</span><span data-line="496">        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="497">
</span><span data-line="498">    <span class="k">return</span> <span class="n">obj_ids</span></div>

</span><span data-line="499">
</span><span data-line="500">
<div class="viewcode-block" id="read_camera_ptr">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_camera_ptr">[docs]</a>
</span><span data-line="501"><span class="nd">@frame_cache</span>
</span><span data-line="502"><span class="k">def</span><span class="w"> </span><span class="nf">read_camera_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CAMERA_PTR_ADDR</span><span class="p">):</span>
</span><span data-line="503"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the pointer to the active camera structure.</span>
</span><span data-line="504">
</span><span data-line="505"><span class="sd">    Args:</span>
</span><span data-line="506"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="507"><span class="sd">        addr: Address where the camera pointer is stored.</span>
</span><span data-line="508">
</span><span data-line="509"><span class="sd">    Returns:</span>
</span><span data-line="510"><span class="sd">        Integer address of the camera struct.</span>
</span><span data-line="511"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="512">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span></div>

</span><span data-line="513">
</span><span data-line="514">
<div class="viewcode-block" id="read_camera_fov">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_camera_fov">[docs]</a>
</span><span data-line="515"><span class="nd">@frame_cache</span>
</span><span data-line="516"><span class="k">def</span><span class="w"> </span><span class="nf">read_camera_fov</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="517"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the current camera field-of-view (radians).</span>
</span><span data-line="518">
</span><span data-line="519"><span class="sd">    The FOV value is stored as a 16-bit fixed-point angle; it is converted to radians.</span>
</span><span data-line="520">
</span><span data-line="521"><span class="sd">    Args:</span>
</span><span data-line="522"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="523">
</span><span data-line="524"><span class="sd">    Returns:</span>
</span><span data-line="525"><span class="sd">        Floating-point FOV in radians.</span>
</span><span data-line="526"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="527">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_camera_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="528">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_short</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mh">0x10000</span><span class="p">)</span></div>

</span><span data-line="529">
</span><span data-line="530">
<div class="viewcode-block" id="read_camera_aspect">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_camera_aspect">[docs]</a>
</span><span data-line="531"><span class="nd">@frame_cache</span>
</span><span data-line="532"><span class="k">def</span><span class="w"> </span><span class="nf">read_camera_aspect</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="533"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the camera aspect ratio from memory.</span>
</span><span data-line="534">
</span><span data-line="535"><span class="sd">    Args:</span>
</span><span data-line="536"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="537">
</span><span data-line="538"><span class="sd">    Returns:</span>
</span><span data-line="539"><span class="sd">        Float aspect ratio (width/height).</span>
</span><span data-line="540"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="541">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_camera_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="542">    <span class="k">return</span> <span class="n">read_fx32</span><span class="p">(</span><span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x6C</span><span class="p">)</span></div>

</span><span data-line="543">
</span><span data-line="544">
<div class="viewcode-block" id="read_camera_position">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_camera_position">[docs]</a>
</span><span data-line="545"><span class="nd">@frame_cache</span>
</span><span data-line="546"><span class="k">def</span><span class="w"> </span><span class="nf">read_camera_position</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="547"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the camera world position, including elevation offset.</span>
</span><span data-line="548">
</span><span data-line="549"><span class="sd">    Args:</span>
</span><span data-line="550"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="551"><span class="sd">        device: Torch device for the returned tensor.</span>
</span><span data-line="552">
</span><span data-line="553"><span class="sd">    Returns:</span>
</span><span data-line="554"><span class="sd">        torch.Tensor shape (3,) representing camera (x, y, z).</span>
</span><span data-line="555"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="556">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_camera_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="557">    <span class="n">pos</span> <span class="o">=</span> <span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x24</span><span class="p">)</span>
</span><span data-line="558">    <span class="n">elevation</span> <span class="o">=</span> <span class="n">read_fx32</span><span class="p">(</span><span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x178</span><span class="p">)</span>
</span><span data-line="559">    <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">elevation</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span data-line="560">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>

</span><span data-line="561">
</span><span data-line="562">
<div class="viewcode-block" id="read_camera_target_position">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_camera_target_position">[docs]</a>
</span><span data-line="563"><span class="k">def</span><span class="w"> </span><span class="nf">read_camera_target_position</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="564"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the camera&#39;s target/look-at position in world space.</span>
</span><span data-line="565">
</span><span data-line="566"><span class="sd">    Args:</span>
</span><span data-line="567"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="568"><span class="sd">        device: Torch device for the returned tensor.</span>
</span><span data-line="569">
</span><span data-line="570"><span class="sd">    Returns:</span>
</span><span data-line="571"><span class="sd">        torch.Tensor shape (3,) target (x, y, z).</span>
</span><span data-line="572"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="573">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_camera_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="574">    <span class="n">pos</span> <span class="o">=</span> <span class="n">read_vector_3d_fx32</span><span class="p">(</span><span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">)</span>
</span><span data-line="575">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>

</span><span data-line="576">
</span><span data-line="577">
</span><span data-line="578"><span class="k">def</span><span class="w"> </span><span class="nf">_compute_orthonormal_basis</span><span class="p">(</span>
</span><span data-line="579">    <span class="n">forward_vector_3d</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
</span><span data-line="580">    <span class="n">reference_vector_3d</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="581">    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="582"><span class="p">):</span>
</span><span data-line="583"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute a right-handed orthonormal basis given a forward vector.</span>
</span><span data-line="584">
</span><span data-line="585"><span class="sd">    Args:</span>
</span><span data-line="586"><span class="sd">        forward_vector_3d: Tensor shape (3,) forward direction.</span>
</span><span data-line="587"><span class="sd">        reference_vector_3d: Optional up-like reference; defaults to (0,1,0).</span>
</span><span data-line="588"><span class="sd">        device: Unused (kept for signature parity).</span>
</span><span data-line="589">
</span><span data-line="590"><span class="sd">    Returns:</span>
</span><span data-line="591"><span class="sd">        torch.Tensor shape (3,3) with rows [right, up, forward].</span>
</span><span data-line="592"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="593">    <span class="k">if</span> <span class="n">reference_vector_3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="594">        <span class="n">reference_vector_3d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
</span><span data-line="595">            <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
</span><span data-line="596">            <span class="n">dtype</span><span class="o">=</span><span class="n">forward_vector_3d</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span data-line="597">            <span class="n">device</span><span class="o">=</span><span class="n">forward_vector_3d</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span data-line="598">        <span class="p">)</span>
</span><span data-line="599">
</span><span data-line="600">    <span class="n">right_vector_3d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">forward_vector_3d</span><span class="p">,</span> <span class="n">reference_vector_3d</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="601">    <span class="n">right_vector_3d</span> <span class="o">/=</span> <span class="n">right_vector_3d</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
</span><span data-line="602">
</span><span data-line="603">    <span class="n">up_vector_3d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">right_vector_3d</span><span class="p">,</span> <span class="n">forward_vector_3d</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="604">    <span class="n">up_vector_3d</span> <span class="o">/=</span> <span class="n">up_vector_3d</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
</span><span data-line="605">
</span><span data-line="606">    <span class="n">basis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
</span><span data-line="607">        <span class="p">[</span>
</span><span data-line="608">            <span class="n">right_vector_3d</span><span class="p">,</span>
</span><span data-line="609">            <span class="n">up_vector_3d</span><span class="p">,</span>
</span><span data-line="610">            <span class="n">forward_vector_3d</span><span class="p">,</span>
</span><span data-line="611">        <span class="p">],</span>
</span><span data-line="612">        <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span data-line="613">    <span class="p">)</span>
</span><span data-line="614">
</span><span data-line="615">    <span class="k">return</span> <span class="n">basis</span>
</span><span data-line="616">
</span><span data-line="617">
</span><span data-line="618"><span class="k">def</span><span class="w"> </span><span class="nf">_compute_model_view</span><span class="p">(</span>
</span><span data-line="619">    <span class="n">camera_pos</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">camera_target_pos</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">device</span>
</span><span data-line="620"><span class="p">):</span>
</span><span data-line="621"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a 4x4 model-view matrix from camera position and target.</span>
</span><span data-line="622">
</span><span data-line="623"><span class="sd">    Args:</span>
</span><span data-line="624"><span class="sd">        camera_pos: Tensor shape (3,) camera world position.</span>
</span><span data-line="625"><span class="sd">        camera_target_pos: Tensor shape (3,) target look-at position.</span>
</span><span data-line="626"><span class="sd">        device: Torch device for the returned matrix.</span>
</span><span data-line="627">
</span><span data-line="628"><span class="sd">    Returns:</span>
</span><span data-line="629"><span class="sd">        torch.Tensor shape (4,4) model-view matrix.</span>
</span><span data-line="630"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="631">    <span class="n">forward</span> <span class="o">=</span> <span class="n">camera_target_pos</span> <span class="o">-</span> <span class="n">camera_pos</span>
</span><span data-line="632">    <span class="n">forward</span> <span class="o">/=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="633">
</span><span data-line="634">    <span class="n">rot</span> <span class="o">=</span> <span class="n">_compute_orthonormal_basis</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="635">
</span><span data-line="636">    <span class="n">pos_proj</span> <span class="o">=</span> <span class="n">rot</span> <span class="o">@</span> <span class="n">camera_pos</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="637">
</span><span data-line="638">    <span class="n">model_view</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">rot</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="639">    <span class="n">model_view</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot</span>
</span><span data-line="640">    <span class="n">model_view</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos_proj</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="641">
</span><span data-line="642">    <span class="k">return</span> <span class="n">model_view</span>
</span><span data-line="643">
</span><span data-line="644">
<div class="viewcode-block" id="read_model_view">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_model_view">[docs]</a>
</span><span data-line="645"><span class="nd">@frame_cache</span>
</span><span data-line="646"><span class="k">def</span><span class="w"> </span><span class="nf">read_model_view</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="647"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute and cache the camera model-view matrix for the current frame.</span>
</span><span data-line="648">
</span><span data-line="649"><span class="sd">    Args:</span>
</span><span data-line="650"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="651"><span class="sd">        device: Torch device for returned matrix.</span>
</span><span data-line="652">
</span><span data-line="653"><span class="sd">    Returns:</span>
</span><span data-line="654"><span class="sd">        torch.Tensor shape (4,4) model-view matrix.</span>
</span><span data-line="655"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="656">    <span class="n">camera_pos</span> <span class="o">=</span> <span class="n">read_camera_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="657">    <span class="n">camera_target_pos</span> <span class="o">=</span> <span class="n">read_camera_target_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="658">    <span class="k">return</span> <span class="n">_compute_model_view</span><span class="p">(</span><span class="n">camera_pos</span><span class="p">,</span> <span class="n">camera_target_pos</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>

</span><span data-line="659">
</span><span data-line="660">
</span><span data-line="661"><span class="k">def</span><span class="w"> </span><span class="nf">_project_to_screen</span><span class="p">(</span><span class="n">world_points</span><span class="p">,</span> <span class="n">model_view</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">aspect</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="662"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Project world-space points to screen coordinates using perspective projection.</span>
</span><span data-line="663">
</span><span data-line="664"><span class="sd">    Args:</span>
</span><span data-line="665"><span class="sd">        world_points: Tensor shape (N,3) of world-space points.</span>
</span><span data-line="666"><span class="sd">        model_view: Tensor shape (4,4) model-view matrix.</span>
</span><span data-line="667"><span class="sd">        fov: Field-of-view in radians (vertical half-angle usage within projection).</span>
</span><span data-line="668"><span class="sd">        aspect: Aspect ratio (width/height).</span>
</span><span data-line="669"><span class="sd">        device: Torch device for intermediate/return tensors.</span>
</span><span data-line="670">
</span><span data-line="671"><span class="sd">    Returns:</span>
</span><span data-line="672"><span class="sd">        Tensor shape (N,4): [x_px, y_px, clip_z, normalized_depth],</span>
</span><span data-line="673"><span class="sd">        where x/y are in pixel coordinates for a SCREEN_WIDTH x SCREEN_HEIGHT viewport.</span>
</span><span data-line="674"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="675">    <span class="n">N</span> <span class="o">=</span> <span class="n">world_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="676">
</span><span data-line="677">    <span class="c1"># Homogenize points</span>
</span><span data-line="678">    <span class="n">ones</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="679">    <span class="n">world_points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">world_points</span><span class="p">,</span> <span class="n">ones</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="680">    <span class="n">cam_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_view</span> <span class="o">@</span> <span class="n">world_points</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span data-line="681">
</span><span data-line="682">    <span class="c1"># Perspective projection</span>
</span><span data-line="683">    <span class="n">f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">fov</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span data-line="684">
</span><span data-line="685">    <span class="k">if</span> <span class="n">cam_space</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="686">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="687">
</span><span data-line="688">    <span class="n">fov_h</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">fov</span><span class="p">)</span>
</span><span data-line="689">    <span class="n">fov_w</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">fov</span><span class="p">)</span> <span class="o">*</span> <span class="n">aspect</span>
</span><span data-line="690">
</span><span data-line="691">    <span class="n">projection_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="692">    <span class="n">projection_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">fov_w</span>
</span><span data-line="693">    <span class="n">projection_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">fov_h</span>
</span><span data-line="694">    <span class="n">projection_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z_FAR</span> <span class="o">+</span> <span class="n">Z_NEAR</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Z_NEAR</span> <span class="o">-</span> <span class="n">Z_FAR</span><span class="p">)</span>
</span><span data-line="695">    <span class="n">projection_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Z_FAR</span> <span class="o">*</span> <span class="n">Z_NEAR</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Z_NEAR</span> <span class="o">-</span> <span class="n">Z_FAR</span><span class="p">)</span>
</span><span data-line="696">    <span class="n">projection_matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span data-line="697">
</span><span data-line="698">    <span class="n">clip_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">projection_matrix</span> <span class="o">@</span> <span class="n">cam_space</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span data-line="699">
</span><span data-line="700">    <span class="n">ndc</span> <span class="o">=</span> <span class="n">clip_space</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">clip_space</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</span><span data-line="701">
</span><span data-line="702">    <span class="n">screen_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">ndc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SCREEN_WIDTH</span>
</span><span data-line="703">    <span class="n">screen_y</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ndc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SCREEN_HEIGHT</span>
</span><span data-line="704">    <span class="n">screen_depth</span> <span class="o">=</span> <span class="n">clip_space</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
</span><span data-line="705">    <span class="n">screen_depth_norm</span> <span class="o">=</span> <span class="o">-</span><span class="n">Z_FAR</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span><span class="n">Z_FAR</span> <span class="o">+</span> <span class="n">Z_SCALE</span> <span class="o">*</span> <span class="n">clip_space</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
</span><span data-line="706">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">screen_x</span><span class="p">,</span> <span class="n">screen_y</span><span class="p">,</span> <span class="n">screen_depth</span><span class="p">,</span> <span class="n">screen_depth_norm</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="707">
</span><span data-line="708">
<div class="viewcode-block" id="project_to_screen">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.project_to_screen">[docs]</a>
</span><span data-line="709"><span class="k">def</span><span class="w"> </span><span class="nf">project_to_screen</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="710"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Convenience wrapper to project points using the current camera state.</span>
</span><span data-line="711">
</span><span data-line="712"><span class="sd">    Args:</span>
</span><span data-line="713"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="714"><span class="sd">        points: Tensor shape (N,3) of world-space points.</span>
</span><span data-line="715"><span class="sd">        device: Torch device.</span>
</span><span data-line="716">
</span><span data-line="717"><span class="sd">    Returns:</span>
</span><span data-line="718"><span class="sd">        Tensor shape (N,4) in screen space (see `_project_to_screen`).</span>
</span><span data-line="719"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="720">    <span class="n">model_view</span> <span class="o">=</span> <span class="n">read_model_view</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="721">    <span class="n">fov</span> <span class="o">=</span> <span class="n">read_camera_fov</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="722">    <span class="n">aspect</span> <span class="o">=</span> <span class="n">read_camera_aspect</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="723">    <span class="k">return</span> <span class="n">_project_to_screen</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">model_view</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">aspect</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span></div>

</span><span data-line="724">
</span><span data-line="725">
</span><span data-line="726"><span class="c1"># CHECKPOINT INFO #</span>
</span><span data-line="727">
</span><span data-line="728">
<div class="viewcode-block" id="read_checkpoint_ptr">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_checkpoint_ptr">[docs]</a>
</span><span data-line="729"><span class="nd">@game_cache</span>
</span><span data-line="730"><span class="k">def</span><span class="w"> </span><span class="nf">read_checkpoint_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CHECKPOINT_PTR_ADDR</span><span class="p">):</span>
</span><span data-line="731"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the pointer to the checkpoint manager/state.</span>
</span><span data-line="732">
</span><span data-line="733"><span class="sd">    Args:</span>
</span><span data-line="734"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="735"><span class="sd">        addr: Address where the checkpoint pointer is stored.</span>
</span><span data-line="736">
</span><span data-line="737"><span class="sd">    Returns:</span>
</span><span data-line="738"><span class="sd">        Integer address for checkpoint data.</span>
</span><span data-line="739"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="740">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_long</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span></div>

</span><span data-line="741">
</span><span data-line="742">
<div class="viewcode-block" id="read_current_checkpoint">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_current_checkpoint">[docs]</a>
</span><span data-line="743"><span class="nd">@frame_cache</span>
</span><span data-line="744"><span class="k">def</span><span class="w"> </span><span class="nf">read_current_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="745"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the index of the current checkpoint.</span>
</span><span data-line="746">
</span><span data-line="747"><span class="sd">    Args:</span>
</span><span data-line="748"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="749">
</span><span data-line="750"><span class="sd">    Returns:</span>
</span><span data-line="751"><span class="sd">        Unsigned byte checkpoint index.</span>
</span><span data-line="752"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="753">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_checkpoint_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="754">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">unsigned</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x46</span><span class="p">)</span></div>

</span><span data-line="755">
</span><span data-line="756">
<div class="viewcode-block" id="read_current_key_checkpoint">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_current_key_checkpoint">[docs]</a>
</span><span data-line="757"><span class="nd">@frame_cache</span>
</span><span data-line="758"><span class="k">def</span><span class="w"> </span><span class="nf">read_current_key_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="759"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the current key checkpoint index (special/lap-related).</span>
</span><span data-line="760">
</span><span data-line="761"><span class="sd">    Args:</span>
</span><span data-line="762"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="763">
</span><span data-line="764"><span class="sd">    Returns:</span>
</span><span data-line="765"><span class="sd">        Signed byte key checkpoint index.</span>
</span><span data-line="766"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="767">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_checkpoint_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="768">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">)</span></div>

</span><span data-line="769">
</span><span data-line="770">
<div class="viewcode-block" id="read_ghost_checkpoint">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_ghost_checkpoint">[docs]</a>
</span><span data-line="771"><span class="nd">@frame_cache</span>
</span><span data-line="772"><span class="k">def</span><span class="w"> </span><span class="nf">read_ghost_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="773"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the recorded ghost&#39;s current checkpoint index.</span>
</span><span data-line="774">
</span><span data-line="775"><span class="sd">    Args:</span>
</span><span data-line="776"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="777">
</span><span data-line="778"><span class="sd">    Returns:</span>
</span><span data-line="779"><span class="sd">        Signed byte ghost checkpoint index.</span>
</span><span data-line="780"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="781">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_checkpoint_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="782">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0xD2</span><span class="p">)</span></div>

</span><span data-line="783">
</span><span data-line="784">
<div class="viewcode-block" id="read_ghost_key_checkpoint">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_ghost_key_checkpoint">[docs]</a>
</span><span data-line="785"><span class="nd">@frame_cache</span>
</span><span data-line="786"><span class="k">def</span><span class="w"> </span><span class="nf">read_ghost_key_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="787"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the recorded ghost&#39;s current key checkpoint index.</span>
</span><span data-line="788">
</span><span data-line="789"><span class="sd">    Args:</span>
</span><span data-line="790"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="791">
</span><span data-line="792"><span class="sd">    Returns:</span>
</span><span data-line="793"><span class="sd">        Signed byte ghost key checkpoint index.</span>
</span><span data-line="794"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="795">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_checkpoint_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="796">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0xD4</span><span class="p">)</span></div>

</span><span data-line="797">
</span><span data-line="798">
<div class="viewcode-block" id="read_current_lap">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_current_lap">[docs]</a>
</span><span data-line="799"><span class="nd">@frame_cache</span>
</span><span data-line="800"><span class="k">def</span><span class="w"> </span><span class="nf">read_current_lap</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">):</span>
</span><span data-line="801"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the current lap number.</span>
</span><span data-line="802">
</span><span data-line="803"><span class="sd">    Args:</span>
</span><span data-line="804"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="805">
</span><span data-line="806"><span class="sd">    Returns:</span>
</span><span data-line="807"><span class="sd">        Signed byte lap index (0-based).</span>
</span><span data-line="808"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="809">    <span class="n">addr</span> <span class="o">=</span> <span class="n">read_checkpoint_ptr</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="810">    <span class="k">return</span> <span class="n">emu</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">signed</span><span class="o">.</span><span class="n">read_byte</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">)</span></div>

</span><span data-line="811">
</span><span data-line="812">
<div class="viewcode-block" id="read_next_checkpoint">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_next_checkpoint">[docs]</a>
</span><span data-line="813"><span class="nd">@frame_cache</span>
</span><span data-line="814"><span class="k">def</span><span class="w"> </span><span class="nf">read_next_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">checkpoint_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span data-line="815"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the next checkpoint index (wrapping to 0 at the end).</span>
</span><span data-line="816">
</span><span data-line="817"><span class="sd">    Args:</span>
</span><span data-line="818"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="819"><span class="sd">        checkpoint_count: Total number of checkpoints.</span>
</span><span data-line="820">
</span><span data-line="821"><span class="sd">    Returns:</span>
</span><span data-line="822"><span class="sd">        Integer index of the next checkpoint.</span>
</span><span data-line="823"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="824">    <span class="n">current_checkpoint</span> <span class="o">=</span> <span class="n">read_current_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="825">    <span class="n">next_checkpoint</span> <span class="o">=</span> <span class="n">current_checkpoint</span> <span class="o">+</span> <span class="mi">1</span>
</span><span data-line="826">    <span class="k">if</span> <span class="n">next_checkpoint</span> <span class="o">!=</span> <span class="n">checkpoint_count</span><span class="p">:</span>
</span><span data-line="827">        <span class="k">return</span> <span class="n">next_checkpoint</span>
</span><span data-line="828">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="829">        <span class="k">return</span> <span class="mi">0</span></div>

</span><span data-line="830">
</span><span data-line="831">
</span><span data-line="832"><span class="k">def</span><span class="w"> </span><span class="nf">_convert_2d_checkpoints</span><span class="p">(</span><span class="n">P</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span data-line="833"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Lift 2D checkpoint endpoints into 3D by sampling the missing dimension.</span>
</span><span data-line="834">
</span><span data-line="835"><span class="sd">    Given 2D endpoints (e.g., XZ) and a set of floor points, fills in the</span>
</span><span data-line="836"><span class="sd">    missing axis by nearest-neighbor on that axis.</span>
</span><span data-line="837">
</span><span data-line="838"><span class="sd">    Args:</span>
</span><span data-line="839"><span class="sd">        P: Tensor shape (N,2) endpoints (with one missing dimension).</span>
</span><span data-line="840"><span class="sd">        source: Tensor shape (M,3) of reference points (e.g., floor vertices).</span>
</span><span data-line="841"><span class="sd">        dim: Dimension index (0/1/2) to fill in.</span>
</span><span data-line="842">
</span><span data-line="843"><span class="sd">    Returns:</span>
</span><span data-line="844"><span class="sd">        Tensor shape (N,3) with the missing axis populated.</span>
</span><span data-line="845"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="846">    <span class="n">dim_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dim</span>
</span><span data-line="847">
</span><span data-line="848">    <span class="n">D</span> <span class="o">=</span> <span class="n">pairwise_distances_cross</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">source</span><span class="p">[:,</span> <span class="n">dim_mask</span><span class="p">])</span>
</span><span data-line="849">    <span class="n">min_idx</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="850">
</span><span data-line="851">    <span class="n">result</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">P</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="852">    <span class="n">result</span><span class="p">[:,</span> <span class="n">dim_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>
</span><span data-line="853">    <span class="n">result</span><span class="p">[:,</span> <span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="n">min_idx</span><span class="p">,</span> <span class="n">dim</span><span class="p">]</span>
</span><span data-line="854">
</span><span data-line="855">    <span class="k">return</span> <span class="n">result</span>
</span><span data-line="856">
</span><span data-line="857">
<div class="viewcode-block" id="read_checkpoint_positions">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_checkpoint_positions">[docs]</a>
</span><span data-line="858"><span class="nd">@game_cache</span>
</span><span data-line="859"><span class="k">def</span><span class="w"> </span><span class="nf">read_checkpoint_positions</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="860"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a tensor of checkpoint segment endpoints in 3D.</span>
</span><span data-line="861">
</span><span data-line="862"><span class="sd">    Reads NKM and KCL, extracts floor geometry, and converts checkpoint pairs</span>
</span><span data-line="863"><span class="sd">    from 2D to 3D using nearest floor elevation.</span>
</span><span data-line="864">
</span><span data-line="865"><span class="sd">    Args:</span>
</span><span data-line="866"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="867"><span class="sd">        device: Torch device.</span>
</span><span data-line="868">
</span><span data-line="869"><span class="sd">    Returns:</span>
</span><span data-line="870"><span class="sd">        Tensor shape (C, 2, 3) where C is number of checkpoints,</span>
</span><span data-line="871"><span class="sd">        containing [p1, p2] endpoints per checkpoint.</span>
</span><span data-line="872"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="873">    <span class="n">nkm</span> <span class="o">=</span> <span class="n">load_current_nkm</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="874">    <span class="n">kcl</span> <span class="o">=</span> <span class="n">load_current_kcl</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="875">    <span class="n">floor_mask</span> <span class="o">=</span> <span class="n">kcl</span><span class="o">.</span><span class="n">prisms</span><span class="o">.</span><span class="n">is_floor</span> <span class="o">==</span> <span class="mi">1</span>
</span><span data-line="876">    <span class="n">floor_points</span> <span class="o">=</span> <span class="n">kcl</span><span class="o">.</span><span class="n">triangles</span><span class="p">[</span><span class="n">floor_mask</span><span class="p">]</span>
</span><span data-line="877">    <span class="n">floor_points</span> <span class="o">=</span> <span class="n">floor_points</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">floor_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span data-line="878">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
</span><span data-line="879">        <span class="p">[</span>
</span><span data-line="880">            <span class="n">_convert_2d_checkpoints</span><span class="p">(</span><span class="n">nkm</span><span class="o">.</span><span class="n">_CPOI</span><span class="o">.</span><span class="n">position1</span><span class="p">,</span> <span class="n">floor_points</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span><span data-line="881">            <span class="n">_convert_2d_checkpoints</span><span class="p">(</span><span class="n">nkm</span><span class="o">.</span><span class="n">_CPOI</span><span class="o">.</span><span class="n">position2</span><span class="p">,</span> <span class="n">floor_points</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span><span data-line="882">        <span class="p">],</span>
</span><span data-line="883">        <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span data-line="884">    <span class="p">)</span></div>

</span><span data-line="885">
</span><span data-line="886">
<div class="viewcode-block" id="read_next_checkpoint_position">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_next_checkpoint_position">[docs]</a>
</span><span data-line="887"><span class="nd">@frame_cache</span>
</span><span data-line="888"><span class="k">def</span><span class="w"> </span><span class="nf">read_next_checkpoint_position</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="889"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the 3D endpoints of the next checkpoint segment.</span>
</span><span data-line="890">
</span><span data-line="891"><span class="sd">    Args:</span>
</span><span data-line="892"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="893"><span class="sd">        device: Torch device.</span>
</span><span data-line="894">
</span><span data-line="895"><span class="sd">    Returns:</span>
</span><span data-line="896"><span class="sd">        Tensor shape (2,3) representing the next checkpoint&#39;s [p1, p2].</span>
</span><span data-line="897"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="898">    <span class="n">nkm</span> <span class="o">=</span> <span class="n">load_current_nkm</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="899">    <span class="n">checkpoints</span> <span class="o">=</span> <span class="n">read_checkpoint_positions</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span data-line="900">    <span class="n">checkpoint_count</span> <span class="o">=</span> <span class="n">nkm</span><span class="o">.</span><span class="n">_CPOI</span><span class="o">.</span><span class="n">entry_count</span>
</span><span data-line="901">    <span class="n">next_checkpoint</span> <span class="o">=</span> <span class="n">read_next_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">checkpoint_count</span><span class="p">)</span>
</span><span data-line="902">    <span class="k">return</span> <span class="n">checkpoints</span><span class="p">[</span><span class="n">next_checkpoint</span><span class="p">]</span></div>

</span><span data-line="903">
</span><span data-line="904">
<div class="viewcode-block" id="read_current_checkpoint_position">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_current_checkpoint_position">[docs]</a>
</span><span data-line="905"><span class="nd">@frame_cache</span>
</span><span data-line="906"><span class="k">def</span><span class="w"> </span><span class="nf">read_current_checkpoint_position</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="907"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the 3D endpoints of the current checkpoint segment.</span>
</span><span data-line="908">
</span><span data-line="909"><span class="sd">    Args:</span>
</span><span data-line="910"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="911"><span class="sd">        device: Torch device.</span>
</span><span data-line="912">
</span><span data-line="913"><span class="sd">    Returns:</span>
</span><span data-line="914"><span class="sd">        Tensor shape (2,3) representing current checkpoint&#39;s [p1, p2].</span>
</span><span data-line="915"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="916">    <span class="n">checkpoints</span> <span class="o">=</span> <span class="n">read_checkpoint_positions</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="917">    <span class="n">current_checkpoint</span> <span class="o">=</span> <span class="n">read_current_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span>
</span><span data-line="918">    <span class="k">return</span> <span class="n">checkpoints</span><span class="p">[</span><span class="n">current_checkpoint</span><span class="p">]</span></div>

</span><span data-line="919">
</span><span data-line="920">
<div class="viewcode-block" id="read_facing_point_checkpoint">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_facing_point_checkpoint">[docs]</a>
</span><span data-line="921"><span class="nd">@frame_cache</span>
</span><span data-line="922"><span class="k">def</span><span class="w"> </span><span class="nf">read_facing_point_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="923"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Raycast from the player along a direction to the next checkpoint line (XZ).</span>
</span><span data-line="924">
</span><span data-line="925"><span class="sd">    Args:</span>
</span><span data-line="926"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="927"><span class="sd">        direction: Tensor shape (3,) direction vector.</span>
</span><span data-line="928"><span class="sd">        device: Torch device.</span>
</span><span data-line="929">
</span><span data-line="930"><span class="sd">    Returns:</span>
</span><span data-line="931"><span class="sd">        Tensor shape (3,) point of intersection in world coordinates.</span>
</span><span data-line="932"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="933">    <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="934">    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">read_next_checkpoint_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span data-line="935">    <span class="n">mask_xz</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="936">    <span class="n">pos_xz</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="n">mask_xz</span><span class="p">]</span>
</span><span data-line="937">    <span class="n">dir_xz</span> <span class="o">=</span> <span class="n">direction</span><span class="p">[</span><span class="n">mask_xz</span><span class="p">]</span>
</span><span data-line="938">    <span class="n">pxz_1</span><span class="p">,</span> <span class="n">pxz_2</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[:,</span> <span class="n">mask_xz</span><span class="p">]</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="939">    <span class="n">pxz_1</span> <span class="o">=</span> <span class="n">pxz_1</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="940">    <span class="n">pxz_2</span> <span class="o">=</span> <span class="n">pxz_2</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="941">    <span class="n">intersect</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">intersect_ray_line_2d</span><span class="p">(</span><span class="n">pos_xz</span><span class="p">,</span> <span class="n">dir_xz</span><span class="p">,</span> <span class="n">pxz_1</span><span class="p">,</span> <span class="n">pxz_2</span><span class="p">)</span>
</span><span data-line="942">    <span class="n">intersect</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">intersect</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">intersect</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="943">    <span class="k">return</span> <span class="n">intersect</span></div>

</span><span data-line="944">
</span><span data-line="945">
<div class="viewcode-block" id="read_forward_distance_checkpoint">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_forward_distance_checkpoint">[docs]</a>
</span><span data-line="946"><span class="nd">@frame_cache</span>
</span><span data-line="947"><span class="k">def</span><span class="w"> </span><span class="nf">read_forward_distance_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="948"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute forward distance from player to the next checkpoint line.</span>
</span><span data-line="949">
</span><span data-line="950"><span class="sd">    Args:</span>
</span><span data-line="951"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="952"><span class="sd">        device: Torch device.</span>
</span><span data-line="953">
</span><span data-line="954"><span class="sd">    Returns:</span>
</span><span data-line="955"><span class="sd">        Scalar torch.Tensor distance.</span>
</span><span data-line="956"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="957">    <span class="n">direction</span> <span class="o">=</span> <span class="n">read_direction</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="958">    <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="959">    <span class="n">ray_point</span> <span class="o">=</span> <span class="n">read_facing_point_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="960">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ray_point</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span></div>

</span><span data-line="961">
</span><span data-line="962">
<div class="viewcode-block" id="read_left_distance_checkpoint">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_left_distance_checkpoint">[docs]</a>
</span><span data-line="963"><span class="nd">@frame_cache</span>
</span><span data-line="964"><span class="k">def</span><span class="w"> </span><span class="nf">read_left_distance_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="965"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute leftward distance from player to the next checkpoint line.</span>
</span><span data-line="966">
</span><span data-line="967"><span class="sd">    Args:</span>
</span><span data-line="968"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="969"><span class="sd">        device: Torch device.</span>
</span><span data-line="970">
</span><span data-line="971"><span class="sd">    Returns:</span>
</span><span data-line="972"><span class="sd">        Scalar torch.Tensor distance.</span>
</span><span data-line="973"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="974">    <span class="n">direction</span> <span class="o">=</span> <span class="n">read_direction</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="975">    <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="976">    <span class="n">up_basis</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="977">    <span class="n">left_basis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">up_basis</span><span class="p">)</span>
</span><span data-line="978">    <span class="n">ray_point</span> <span class="o">=</span> <span class="n">read_facing_point_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">left_basis</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="979">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ray_point</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span></div>

</span><span data-line="980">
</span><span data-line="981">
<div class="viewcode-block" id="read_direction_to_checkpoint">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_direction_to_checkpoint">[docs]</a>
</span><span data-line="982"><span class="nd">@frame_cache</span>
</span><span data-line="983"><span class="k">def</span><span class="w"> </span><span class="nf">read_direction_to_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span data-line="984"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute a steering angle toward the next checkpoint from forward/left distances.</span>
</span><span data-line="985">
</span><span data-line="986"><span class="sd">    Angle is computed as atan(forward / left).</span>
</span><span data-line="987">
</span><span data-line="988"><span class="sd">    Args:</span>
</span><span data-line="989"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="990"><span class="sd">        device: Torch device.</span>
</span><span data-line="991">
</span><span data-line="992"><span class="sd">    Returns:</span>
</span><span data-line="993"><span class="sd">        Scalar torch.Tensor angle in radians.</span>
</span><span data-line="994"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="995">    <span class="n">f</span> <span class="o">=</span> <span class="n">read_forward_distance_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="996">    <span class="n">l</span> <span class="o">=</span> <span class="n">read_left_distance_checkpoint</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="997">    <span class="n">angle</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">f</span> <span class="o">/</span> <span class="n">l</span><span class="p">)</span>
</span><span data-line="998">    <span class="k">return</span> <span class="n">angle</span></div>

</span><span data-line="999">
</span><span data-line="1000">
</span><span data-line="1001"><span class="c1"># OBSTACLE INFO #</span>
</span><span data-line="1002">
</span><span data-line="1003">
<div class="viewcode-block" id="read_facing_point_obstacle">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_facing_point_obstacle">[docs]</a>
</span><span data-line="1004"><span class="nd">@frame_cache</span>
</span><span data-line="1005"><span class="k">def</span><span class="w"> </span><span class="nf">read_facing_point_obstacle</span><span class="p">(</span>
</span><span data-line="1006">    <span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span>
</span><span data-line="1007">    <span class="n">position</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1008">    <span class="n">direction</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1009">    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="1010"><span class="p">):</span>
</span><span data-line="1011"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Raycast toward walls/offroad and return the nearest hit point.</span>
</span><span data-line="1012">
</span><span data-line="1013"><span class="sd">    Samples a cone of directions around the provided (or player) direction, and</span>
</span><span data-line="1014"><span class="sd">    finds the nearest intersection against wall and offroad triangles.</span>
</span><span data-line="1015">
</span><span data-line="1016"><span class="sd">    Args:</span>
</span><span data-line="1017"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1018"><span class="sd">        position: Optional world position (3,). Defaults to player&#39;s position.</span>
</span><span data-line="1019"><span class="sd">        direction: Optional direction (3,). Defaults to player&#39;s forward vector.</span>
</span><span data-line="1020"><span class="sd">        device: Torch device.</span>
</span><span data-line="1021">
</span><span data-line="1022"><span class="sd">    Returns:</span>
</span><span data-line="1023"><span class="sd">        torch.Tensor shape (3,) hit point, or None if no intersections.</span>
</span><span data-line="1024"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1025">    <span class="k">assert</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1026">    <span class="n">kcl</span> <span class="o">=</span> <span class="n">load_current_kcl</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1027">    <span class="n">triangles</span> <span class="o">=</span> <span class="n">kcl</span><span class="o">.</span><span class="n">triangles</span>
</span><span data-line="1028">    <span class="n">wall_mask</span> <span class="o">=</span> <span class="n">kcl</span><span class="o">.</span><span class="n">prisms</span><span class="o">.</span><span class="n">is_wall</span> <span class="o">==</span> <span class="mi">1</span>
</span><span data-line="1029">    <span class="n">offroad_mask</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1030">        <span class="p">(</span><span class="n">kcl</span><span class="o">.</span><span class="n">prisms</span><span class="o">.</span><span class="n">collision_type</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
</span><span data-line="1031">        <span class="o">|</span> <span class="p">(</span><span class="n">kcl</span><span class="o">.</span><span class="n">prisms</span><span class="o">.</span><span class="n">collision_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
</span><span data-line="1032">        <span class="o">|</span> <span class="p">(</span><span class="n">kcl</span><span class="o">.</span><span class="n">prisms</span><span class="o">.</span><span class="n">collision_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
</span><span data-line="1033">    <span class="p">)</span>
</span><span data-line="1034">    <span class="n">triangles</span> <span class="o">=</span> <span class="n">triangles</span><span class="p">[</span><span class="n">wall_mask</span> <span class="o">|</span> <span class="n">offroad_mask</span><span class="p">]</span>
</span><span data-line="1035">    <span class="n">B</span> <span class="o">=</span> <span class="n">triangles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="1036">
</span><span data-line="1037">    <span class="k">if</span> <span class="n">B</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1038">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="1039">
</span><span data-line="1040">    <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span> <span class="o">=</span> <span class="n">triangles</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="1041">    <span class="n">v1</span> <span class="o">=</span> <span class="n">v1</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="1042">    <span class="n">v2</span> <span class="o">=</span> <span class="n">v2</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="1043">    <span class="n">v3</span> <span class="o">=</span> <span class="n">v3</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="1044">
</span><span data-line="1045">    <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1046">        <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1047">
</span><span data-line="1048">    <span class="k">if</span> <span class="n">direction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1049">        <span class="n">direction</span> <span class="o">=</span> <span class="n">read_direction</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1050">
</span><span data-line="1051">    <span class="n">ray_dir</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="1052">    <span class="n">angle</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1053">    <span class="n">ray_samples</span> <span class="o">=</span> <span class="n">sample_cone</span><span class="p">(</span><span class="n">ray_dir</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</span><span data-line="1054">    <span class="n">ray_dir</span> <span class="o">=</span> <span class="n">ray_dir</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span data-line="1055">    <span class="n">ray_samples</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">ray_dir</span><span class="p">,</span> <span class="n">ray_samples</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="1056">
</span><span data-line="1057">    <span class="n">ray_origin</span> <span class="o">=</span> <span class="n">position</span>
</span><span data-line="1058">    <span class="n">ray_origin</span> <span class="o">=</span> <span class="n">ray_origin</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="1059">    <span class="n">ray_origin</span> <span class="o">=</span> <span class="n">ray_origin</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span data-line="1060">    <span class="n">ray_origin_samples</span> <span class="o">=</span> <span class="n">ray_origin</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ray_samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</span><span data-line="1061">
</span><span data-line="1062">    <span class="n">points</span> <span class="o">=</span> <span class="n">triangle_raycast_batch</span><span class="p">(</span><span class="n">ray_origin_samples</span><span class="p">,</span> <span class="n">ray_samples</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">)</span>
</span><span data-line="1063">    <span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span>
</span><span data-line="1064">    <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">M</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</span><span data-line="1065">    <span class="k">if</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1066">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="1067">
</span><span data-line="1068">    <span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">ray_origin</span><span class="p">)</span>
</span><span data-line="1069">    <span class="n">min_id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
</span><span data-line="1070">    <span class="n">current_point_min</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">min_id</span><span class="p">]</span>
</span><span data-line="1071">    <span class="k">return</span> <span class="n">current_point_min</span></div>

</span><span data-line="1072">
</span><span data-line="1073">
<div class="viewcode-block" id="read_forward_distance_obstacle">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_forward_distance_obstacle">[docs]</a>
</span><span data-line="1074"><span class="nd">@frame_cache</span>
</span><span data-line="1075"><span class="k">def</span><span class="w"> </span><span class="nf">read_forward_distance_obstacle</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span data-line="1076"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute forward distance to the nearest wall/offroad obstacle.</span>
</span><span data-line="1077">
</span><span data-line="1078"><span class="sd">    Args:</span>
</span><span data-line="1079"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1080"><span class="sd">        device: Torch device.</span>
</span><span data-line="1081">
</span><span data-line="1082"><span class="sd">    Returns:</span>
</span><span data-line="1083"><span class="sd">        Scalar torch.Tensor distance; +inf if no hit.</span>
</span><span data-line="1084"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1085">    <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1086">    <span class="n">ray_point</span> <span class="o">=</span> <span class="n">read_facing_point_obstacle</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1087">    <span class="k">if</span> <span class="n">ray_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1088">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1089">
</span><span data-line="1090">    <span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">position</span> <span class="o">-</span> <span class="n">ray_point</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span data-line="1091">    <span class="k">return</span> <span class="n">dist</span></div>

</span><span data-line="1092">
</span><span data-line="1093">
<div class="viewcode-block" id="read_left_distance_obstacle">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_left_distance_obstacle">[docs]</a>
</span><span data-line="1094"><span class="nd">@frame_cache</span>
</span><span data-line="1095"><span class="k">def</span><span class="w"> </span><span class="nf">read_left_distance_obstacle</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span data-line="1096"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute leftward distance to the nearest wall/offroad obstacle.</span>
</span><span data-line="1097">
</span><span data-line="1098"><span class="sd">    Args:</span>
</span><span data-line="1099"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1100"><span class="sd">        device: Torch device.</span>
</span><span data-line="1101">
</span><span data-line="1102"><span class="sd">    Returns:</span>
</span><span data-line="1103"><span class="sd">        Scalar torch.Tensor distance; +inf if no hit.</span>
</span><span data-line="1104"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1105">    <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1106">    <span class="n">direction</span> <span class="o">=</span> <span class="n">read_direction</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1107">    <span class="n">up_basis</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="1108">    <span class="n">left_basis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">up_basis</span><span class="p">)</span>
</span><span data-line="1109">    <span class="n">ray_point</span> <span class="o">=</span> <span class="n">read_facing_point_obstacle</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">left_basis</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1110">    <span class="k">if</span> <span class="n">ray_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1111">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1112">
</span><span data-line="1113">    <span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">position</span> <span class="o">-</span> <span class="n">ray_point</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span data-line="1114">    <span class="k">return</span> <span class="n">dist</span></div>

</span><span data-line="1115">
</span><span data-line="1116">
<div class="viewcode-block" id="read_right_distance_obstacle">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_right_distance_obstacle">[docs]</a>
</span><span data-line="1117"><span class="nd">@frame_cache</span>
</span><span data-line="1118"><span class="k">def</span><span class="w"> </span><span class="nf">read_right_distance_obstacle</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span data-line="1119"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute rightward distance to the nearest wall/offroad obstacle.</span>
</span><span data-line="1120">
</span><span data-line="1121"><span class="sd">    Args:</span>
</span><span data-line="1122"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1123"><span class="sd">        device: Torch device.</span>
</span><span data-line="1124">
</span><span data-line="1125"><span class="sd">    Returns:</span>
</span><span data-line="1126"><span class="sd">        Scalar torch.Tensor distance; +inf if no hit.</span>
</span><span data-line="1127"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1128">    <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1129">    <span class="n">direction</span> <span class="o">=</span> <span class="n">read_direction</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1130">    <span class="n">up_basis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="1131">    <span class="n">right_basis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">up_basis</span><span class="p">)</span>
</span><span data-line="1132">    <span class="n">ray_point</span> <span class="o">=</span> <span class="n">read_facing_point_obstacle</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">right_basis</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1133">    <span class="k">if</span> <span class="n">ray_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1134">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1135">
</span><span data-line="1136">    <span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">position</span> <span class="o">-</span> <span class="n">ray_point</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span data-line="1137">    <span class="k">return</span> <span class="n">dist</span></div>

</span><span data-line="1138">
</span><span data-line="1139">
<div class="viewcode-block" id="read_checkpoint_distance_altitude">
<a class="viewcode-back" href="../../api/utils.html#utils.memory.read_checkpoint_distance_altitude">[docs]</a>
</span><span data-line="1140"><span class="nd">@frame_cache</span>
</span><span data-line="1141"><span class="k">def</span><span class="w"> </span><span class="nf">read_checkpoint_distance_altitude</span><span class="p">(</span><span class="n">emu</span><span class="p">:</span> <span class="n">DeSmuME</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span data-line="1142"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the altitude (height) of the triangle formed by player and checkpoint endpoints.</span>
</span><span data-line="1143">
</span><span data-line="1144"><span class="sd">    Uses the two checkpoint endpoints and the player&#39;s position to form sides a and b,</span>
</span><span data-line="1145"><span class="sd">    then returns the triangle altitude via `triangle_altitude(a, b)`.</span>
</span><span data-line="1146">
</span><span data-line="1147"><span class="sd">    Args:</span>
</span><span data-line="1148"><span class="sd">        emu: Emulator instance.</span>
</span><span data-line="1149"><span class="sd">        device: Torch device.</span>
</span><span data-line="1150">
</span><span data-line="1151"><span class="sd">    Returns:</span>
</span><span data-line="1152"><span class="sd">        Scalar torch.Tensor altitude value.</span>
</span><span data-line="1153"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1154">    <span class="n">next_checkpoint</span> <span class="o">=</span> <span class="n">read_next_checkpoint_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1155">    <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">next_checkpoint</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="1156">
</span><span data-line="1157">    <span class="n">position</span> <span class="o">=</span> <span class="n">read_position</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="1158">    <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span>
</span><span data-line="1159">    <span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span>
</span><span data-line="1160">    <span class="k">return</span> <span class="n">triangle_altitude</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></div>

</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2025, Blake Moody</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/shibuya.js?v=e730760c"></script></body>
</html>