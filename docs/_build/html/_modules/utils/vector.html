<!DOCTYPE html>
<html lang="en" data-accent-color="purple" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>utils.vector - MarI/O Kart documentation</title><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b1a1f93b" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=bb284d7b" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="utils.vector"/>
<meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../index.html">
      
      
      <strong>MarI/O Kart</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/articles/articles.html">Articles</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/utils.html">Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/visualization.html">Visulization Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/vector.html">utils.vector module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/memory.html">utils.memory module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/training.html">AI Pipeline</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/mkds.html">MKDS File Parsing Library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/mkds/nkm.html">mkds.nkm module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/mkds/kcl.html">mkds.kcl module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/mkds/utils.html">mkds.utils module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/mkds/nkm-t.html">utils.nkm_torch module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/mkds/kcl-t.html">utils.kcl_torch module</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">MarI/O Kart</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">utils.vector</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for utils.vector</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span data-line="2"><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
</span><span data-line="3"><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</span><span data-line="4"><span class="c1">#from utils.emulator import SCREEN_WIDTH, SCREEN_HEIGHT</span>
</span><span data-line="5">
</span><span data-line="6"><span class="n">SCREEN_WIDTH</span><span class="p">,</span> <span class="n">SCREEN_HEIGHT</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">192</span>
</span><span data-line="7">
<div class="viewcode-block" id="get_mps_device">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.get_mps_device">[docs]</a>
</span><span data-line="8"><span class="k">def</span><span class="w"> </span><span class="nf">get_mps_device</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">:</span>
</span><span data-line="9">    <span class="c1"># Check that MPS is available</span>
</span><span data-line="10">    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
</span><span data-line="11">        <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_built</span><span class="p">():</span>
</span><span data-line="12">            <span class="nb">print</span><span class="p">(</span>
</span><span data-line="13">                <span class="s2">&quot;MPS not available because the current PyTorch install was not &quot;</span>
</span><span data-line="14">                <span class="s2">&quot;built with MPS enabled.&quot;</span>
</span><span data-line="15">            <span class="p">)</span>
</span><span data-line="16">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="17">            <span class="nb">print</span><span class="p">(</span>
</span><span data-line="18">                <span class="s2">&quot;MPS not available because the current MacOS version is not 12.3+ &quot;</span>
</span><span data-line="19">                <span class="s2">&quot;and/or you do not have an MPS-enabled device on this machine.&quot;</span>
</span><span data-line="20">            <span class="p">)</span>
</span><span data-line="21">
</span><span data-line="22">        <span class="n">exit</span><span class="p">()</span>
</span><span data-line="23">
</span><span data-line="24">    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;mps&quot;</span><span class="p">)</span>
</span><span data-line="25">    <span class="k">return</span> <span class="n">device</span></div>

</span><span data-line="26">
</span><span data-line="27">
</span><span data-line="28"><span class="k">def</span><span class="w"> </span><span class="nf">_determinant_2d</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">):</span>
</span><span data-line="29">    <span class="k">return</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">x1</span>
</span><span data-line="30">
</span><span data-line="31">
<div class="viewcode-block" id="cross_product_2d">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.cross_product_2d">[docs]</a>
</span><span data-line="32"><span class="k">def</span><span class="w"> </span><span class="nf">cross_product_2d</span><span class="p">(</span><span class="n">p0</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">p1</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span data-line="33">    <span class="k">return</span> <span class="n">_determinant_2d</span><span class="p">(</span><span class="n">p0</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">p0</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span></div>

</span><span data-line="34">
</span><span data-line="35">
<div class="viewcode-block" id="triangle_raycast">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.triangle_raycast">[docs]</a>
</span><span data-line="36"><span class="k">def</span><span class="w"> </span><span class="nf">triangle_raycast</span><span class="p">(</span>
</span><span data-line="37">    <span class="n">ray_origin</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
</span><span data-line="38">    <span class="n">ray_dir</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
</span><span data-line="39">    <span class="n">v1</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
</span><span data-line="40">    <span class="n">v2</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
</span><span data-line="41">    <span class="n">v3</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
</span><span data-line="42">    <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-8</span>
</span><span data-line="43"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="44">    <span class="c1"># Test if the ray intersects the triangle</span>
</span><span data-line="45">    <span class="n">edge1</span> <span class="o">=</span> <span class="n">v2</span> <span class="o">-</span> <span class="n">v1</span>
</span><span data-line="46">    <span class="n">edge2</span> <span class="o">=</span> <span class="n">v3</span> <span class="o">-</span> <span class="n">v1</span>
</span><span data-line="47">    <span class="n">ray_cross_e2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">ray_dir</span><span class="p">,</span> <span class="n">edge2</span><span class="p">)</span>
</span><span data-line="48">    <span class="n">det</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">edge1</span><span class="p">,</span> <span class="n">ray_cross_e2</span><span class="p">)</span>
</span><span data-line="49">    
</span><span data-line="50">    <span class="k">if</span> <span class="n">det</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">epsilon</span> <span class="ow">and</span> <span class="n">det</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
</span><span data-line="51">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="52">        
</span><span data-line="53">    <span class="n">inv_det</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">det</span>
</span><span data-line="54">    <span class="n">s</span> <span class="o">=</span> <span class="n">ray_origin</span> <span class="o">-</span> <span class="n">v1</span>
</span><span data-line="55">    <span class="n">u</span> <span class="o">=</span> <span class="n">inv_det</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ray_cross_e2</span><span class="p">)</span>
</span><span data-line="56">    
</span><span data-line="57">    <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">u</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">):</span>
</span><span data-line="58">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="59">        
</span><span data-line="60">    <span class="n">s_cross_e1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">edge1</span><span class="p">)</span>
</span><span data-line="61">    <span class="n">v</span> <span class="o">=</span> <span class="n">inv_det</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ray_dir</span><span class="p">,</span> <span class="n">s_cross_e1</span><span class="p">)</span>
</span><span data-line="62">    
</span><span data-line="63">    <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">u</span> <span class="o">+</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u</span> <span class="o">+</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">):</span>
</span><span data-line="64">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="65">        
</span><span data-line="66">    <span class="c1"># Compute where the ray intersects the triangle</span>
</span><span data-line="67">    <span class="n">t</span> <span class="o">=</span> <span class="n">inv_det</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">edge2</span><span class="p">,</span> <span class="n">s_cross_e1</span><span class="p">)</span>
</span><span data-line="68">    <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">:</span>
</span><span data-line="69">        <span class="k">return</span> <span class="n">ray_origin</span> <span class="o">+</span> <span class="n">ray_dir</span> <span class="o">*</span> <span class="n">t</span>
</span><span data-line="70">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="71">        <span class="k">return</span> <span class="kc">None</span></div>

</span><span data-line="72">      
</span><span data-line="73"><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span data-line="74">
<div class="viewcode-block" id="intersect_ray_line_2d">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.intersect_ray_line_2d">[docs]</a>
</span><span data-line="75"><span class="k">def</span><span class="w"> </span><span class="nf">intersect_ray_line_2d</span><span class="p">(</span><span class="n">O</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
</span><span data-line="76"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="77"><span class="sd">    Find intersection of a ray (O + tD, t&gt;=0)</span>
</span><span data-line="78"><span class="sd">    with a line segment between P1 and P2.</span>
</span><span data-line="79">
</span><span data-line="80"><span class="sd">    All inputs are torch tensors of shape (..., 2)</span>
</span><span data-line="81"><span class="sd">    and can be batched.</span>
</span><span data-line="82"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="83">    <span class="c1"># Direction of the segment</span>
</span><span data-line="84">    <span class="n">v</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">-</span> <span class="n">P1</span>
</span><span data-line="85">
</span><span data-line="86">    <span class="c1"># 2D cross product helper (scalar)</span>
</span><span data-line="87">    <span class="k">def</span><span class="w"> </span><span class="nf">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span><span data-line="88">        <span class="k">return</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span data-line="89">
</span><span data-line="90">    <span class="c1"># Compute determinant</span>
</span><span data-line="91">    <span class="n">denom</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>  <span class="c1"># parallel if denom == 0</span>
</span><span data-line="92">
</span><span data-line="93">    <span class="c1"># Compute relative position</span>
</span><span data-line="94">    <span class="n">w</span> <span class="o">=</span> <span class="n">P1</span> <span class="o">-</span> <span class="n">O</span>
</span><span data-line="95">
</span><span data-line="96">    <span class="n">t</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">denom</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
</span><span data-line="97">    <span class="n">u</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">denom</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
</span><span data-line="98">
</span><span data-line="99">    <span class="c1"># Compute intersection point</span>
</span><span data-line="100">    <span class="n">intersection</span> <span class="o">=</span> <span class="n">O</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">D</span>
</span><span data-line="101">
</span><span data-line="102">    <span class="c1"># Valid if:</span>
</span><span data-line="103">    <span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">denom</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
</span><span data-line="104">
</span><span data-line="105">    <span class="k">return</span> <span class="n">intersection</span><span class="p">,</span> <span class="n">valid</span></div>

</span><span data-line="106">        
<div class="viewcode-block" id="triangle_raycast_batch">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.triangle_raycast_batch">[docs]</a>
</span><span data-line="107"><span class="k">def</span><span class="w"> </span><span class="nf">triangle_raycast_batch</span><span class="p">(</span>
</span><span data-line="108">    <span class="n">ray_origin</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>  <span class="c1"># (N, 3)</span>
</span><span data-line="109">    <span class="n">ray_dir</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>     <span class="c1"># (N, 3)</span>
</span><span data-line="110">    <span class="n">v1</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>          <span class="c1"># (M, 3)</span>
</span><span data-line="111">    <span class="n">v2</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>          <span class="c1"># (M, 3)</span>
</span><span data-line="112">    <span class="n">v3</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>          <span class="c1"># (M, 3)</span>
</span><span data-line="113">    <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-8</span>
</span><span data-line="114"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span data-line="115"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="116"><span class="sd">    Batched ray-triangle intersection using Möller–Trumbore.</span>
</span><span data-line="117"><span class="sd">    </span>
</span><span data-line="118"><span class="sd">    Args:</span>
</span><span data-line="119"><span class="sd">        ray_origin: (N, 3) origins</span>
</span><span data-line="120"><span class="sd">        ray_dir: (N, 3) directions (normalized)</span>
</span><span data-line="121"><span class="sd">        v1, v2, v3: (M, 3) triangle vertices</span>
</span><span data-line="122"><span class="sd">    Returns:</span>
</span><span data-line="123"><span class="sd">        intersections: (N, M, 3) intersection points (NaN if no hit)</span>
</span><span data-line="124"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="125">    <span class="c1"># Expand to (N, M, 3)</span>
</span><span data-line="126">    <span class="n">ro</span> <span class="o">=</span> <span class="n">ray_origin</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>   <span class="c1"># (N,1,3)</span>
</span><span data-line="127">    <span class="n">rd</span> <span class="o">=</span> <span class="n">ray_dir</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>      <span class="c1"># (N,1,3)</span>
</span><span data-line="128">    <span class="n">v1</span> <span class="o">=</span> <span class="n">v1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>           <span class="c1"># (1,M,3)</span>
</span><span data-line="129">    <span class="n">v2</span> <span class="o">=</span> <span class="n">v2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span data-line="130">    <span class="n">v3</span> <span class="o">=</span> <span class="n">v3</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span data-line="131">
</span><span data-line="132">    <span class="n">edge1</span> <span class="o">=</span> <span class="n">v2</span> <span class="o">-</span> <span class="n">v1</span>
</span><span data-line="133">    <span class="n">edge2</span> <span class="o">=</span> <span class="n">v3</span> <span class="o">-</span> <span class="n">v1</span>
</span><span data-line="134">
</span><span data-line="135">    <span class="n">h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="n">edge2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (N,M,3)</span>
</span><span data-line="136">    <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">edge1</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>    <span class="c1"># (N,M)</span>
</span><span data-line="137">
</span><span data-line="138">    <span class="n">mask_parallel</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span data-line="139">
</span><span data-line="140">    <span class="n">f</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="n">mask_parallel</span><span class="o">.</span><span class="n">sign</span><span class="p">())</span>  <span class="c1"># safe div</span>
</span><span data-line="141">    <span class="n">s</span> <span class="o">=</span> <span class="n">ro</span> <span class="o">-</span> <span class="n">v1</span>
</span><span data-line="142">    <span class="n">u</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="143">
</span><span data-line="144">    <span class="n">mask_u</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</span><span data-line="145">
</span><span data-line="146">    <span class="n">q</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">edge1</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="147">    <span class="n">v</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rd</span> <span class="o">*</span> <span class="n">q</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="148">    <span class="n">mask_v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u</span> <span class="o">+</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</span><span data-line="149">
</span><span data-line="150">    <span class="n">t</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">edge2</span> <span class="o">*</span> <span class="n">q</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="151">    <span class="n">mask_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span data-line="152">
</span><span data-line="153">    <span class="c1"># Valid hits</span>
</span><span data-line="154">    <span class="n">valid</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">mask_parallel</span> <span class="o">|</span> <span class="n">mask_u</span> <span class="o">|</span> <span class="n">mask_v</span> <span class="o">|</span> <span class="n">mask_t</span><span class="p">)</span>
</span><span data-line="155">
</span><span data-line="156">    <span class="c1"># Intersection points</span>
</span><span data-line="157">    <span class="n">pts</span> <span class="o">=</span> <span class="n">ro</span> <span class="o">+</span> <span class="n">rd</span> <span class="o">*</span> <span class="n">t</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># (N,M,3)</span>
</span><span data-line="158">    
</span><span data-line="159">    <span class="c1"># Mask invalid with NaN</span>
</span><span data-line="160">    <span class="n">pts</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">valid</span><span class="p">]</span>
</span><span data-line="161">
</span><span data-line="162">    <span class="k">return</span> <span class="n">pts</span></div>

</span><span data-line="163">    
</span><span data-line="164">
<div class="viewcode-block" id="pairwise_distances">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.pairwise_distances">[docs]</a>
</span><span data-line="165"><span class="k">def</span><span class="w"> </span><span class="nf">pairwise_distances</span><span class="p">(</span><span class="n">pts</span><span class="p">):</span>
</span><span data-line="166">    <span class="n">norms</span> <span class="o">=</span> <span class="p">(</span><span class="n">pts</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="167">    <span class="n">G</span> <span class="o">=</span> <span class="n">pts</span> <span class="o">@</span> <span class="n">pts</span><span class="o">.</span><span class="n">T</span>
</span><span data-line="168">    <span class="n">D2</span> <span class="o">=</span> <span class="n">norms</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">norms</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">G</span>
</span><span data-line="169">    <span class="n">D2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">D2</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span data-line="170">    <span class="n">D</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">D2</span><span class="p">)</span>
</span><span data-line="171">    <span class="k">return</span> <span class="n">D</span></div>

</span><span data-line="172">    
<div class="viewcode-block" id="pairwise_distances_cross">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.pairwise_distances_cross">[docs]</a>
</span><span data-line="173"><span class="k">def</span><span class="w"> </span><span class="nf">pairwise_distances_cross</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
</span><span data-line="174">    <span class="c1"># Compute squared norms</span>
</span><span data-line="175">    <span class="n">A_norms</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># n x 1</span>
</span><span data-line="176">    <span class="n">B_norms</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 1 x m</span>
</span><span data-line="177">    
</span><span data-line="178">    <span class="c1"># Compute pairwise squared distances</span>
</span><span data-line="179">    <span class="n">D_squared</span> <span class="o">=</span> <span class="n">A_norms</span> <span class="o">+</span> <span class="n">B_norms</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span data-line="180">    
</span><span data-line="181">    <span class="c1"># Euclidean distances</span>
</span><span data-line="182">    <span class="n">D</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">D_squared</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span data-line="183">    <span class="k">return</span> <span class="n">D</span></div>

</span><span data-line="184">
<div class="viewcode-block" id="compute_orthonormal_basis">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.compute_orthonormal_basis">[docs]</a>
</span><span data-line="185"><span class="k">def</span><span class="w"> </span><span class="nf">compute_orthonormal_basis</span><span class="p">(</span><span class="n">forward_vector_3d</span><span class="p">,</span> <span class="n">reference_vector_3d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="186">    <span class="k">if</span> <span class="n">reference_vector_3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="187">        <span class="n">reference_vector_3d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
</span><span data-line="188">            <span class="n">dtype</span><span class="o">=</span><span class="n">forward_vector_3d</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span data-line="189">            <span class="n">device</span><span class="o">=</span><span class="n">forward_vector_3d</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="190">
</span><span data-line="191">    <span class="n">right_vector_3d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">forward_vector_3d</span><span class="p">,</span> <span class="n">reference_vector_3d</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="192">    <span class="n">right_vector_3d</span> <span class="o">/=</span> <span class="n">right_vector_3d</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
</span><span data-line="193">    
</span><span data-line="194">    <span class="n">up_vector_3d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">right_vector_3d</span><span class="p">,</span> <span class="n">forward_vector_3d</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="195">    <span class="n">up_vector_3d</span> <span class="o">/=</span> <span class="n">up_vector_3d</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
</span><span data-line="196">    
</span><span data-line="197">    <span class="n">basis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
</span><span data-line="198">        <span class="n">right_vector_3d</span><span class="p">,</span>
</span><span data-line="199">        <span class="n">up_vector_3d</span><span class="p">,</span>
</span><span data-line="200">        <span class="n">forward_vector_3d</span><span class="p">,</span>
</span><span data-line="201">    <span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="202">
</span><span data-line="203">    <span class="k">return</span> <span class="n">basis</span></div>

</span><span data-line="204">
<div class="viewcode-block" id="compute_model_view">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.compute_model_view">[docs]</a>
</span><span data-line="205"><span class="k">def</span><span class="w"> </span><span class="nf">compute_model_view</span><span class="p">(</span><span class="n">camera_pos</span><span class="p">,</span> <span class="n">camera_target_pos</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="206">    <span class="n">forward</span> <span class="o">=</span> <span class="n">camera_target_pos</span> <span class="o">-</span> <span class="n">camera_pos</span>
</span><span data-line="207">    <span class="n">forward</span> <span class="o">/=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="208">    
</span><span data-line="209">    <span class="n">rot</span> <span class="o">=</span> <span class="n">compute_orthonormal_basis</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="210">
</span><span data-line="211">    <span class="n">pos_proj</span> <span class="o">=</span> <span class="n">rot</span> <span class="o">@</span> <span class="n">camera_pos</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="212">    
</span><span data-line="213">    <span class="n">model_view</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">rot</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="214">    <span class="n">model_view</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot</span>
</span><span data-line="215">    <span class="n">model_view</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos_proj</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="216">    
</span><span data-line="217">    <span class="k">return</span> <span class="n">model_view</span></div>

</span><span data-line="218">    
<div class="viewcode-block" id="project_to_screen">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.project_to_screen">[docs]</a>
</span><span data-line="219"><span class="k">def</span><span class="w"> </span><span class="nf">project_to_screen</span><span class="p">(</span><span class="n">world_points</span><span class="p">,</span> <span class="n">model_view</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">aspect</span><span class="p">,</span> <span class="n">far</span><span class="p">,</span> <span class="n">near</span><span class="p">,</span> <span class="n">z_scale</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="220">    <span class="n">N</span> <span class="o">=</span> <span class="n">world_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="221">        
</span><span data-line="222">    <span class="c1"># Homogenize points</span>
</span><span data-line="223">    <span class="n">ones</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="224">    <span class="n">world_points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">world_points</span><span class="p">,</span> <span class="n">ones</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="225">    <span class="n">cam_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_view</span> <span class="o">@</span> <span class="n">world_points</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span data-line="226">    
</span><span data-line="227">    <span class="c1"># Perspective projection</span>
</span><span data-line="228">    <span class="n">f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">fov</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span data-line="229">    
</span><span data-line="230">    <span class="k">if</span> <span class="n">cam_space</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="231">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="232">    
</span><span data-line="233">    <span class="n">fov_h</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">fov</span><span class="p">)</span>
</span><span data-line="234">    <span class="n">fov_w</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">fov</span><span class="p">)</span> <span class="o">*</span> <span class="n">aspect</span>
</span><span data-line="235">    
</span><span data-line="236">    
</span><span data-line="237">    
</span><span data-line="238">    <span class="n">projection_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="239">    <span class="n">projection_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">fov_w</span>
</span><span data-line="240">    <span class="n">projection_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">fov_h</span>
</span><span data-line="241">    <span class="n">projection_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">far</span> <span class="o">+</span> <span class="n">near</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">near</span> <span class="o">-</span> <span class="n">far</span><span class="p">)</span>
</span><span data-line="242">    <span class="n">projection_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">far</span> <span class="o">*</span> <span class="n">near</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">near</span> <span class="o">-</span> <span class="n">far</span><span class="p">)</span>
</span><span data-line="243">    <span class="n">projection_matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span data-line="244">    
</span><span data-line="245">    <span class="n">clip_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">projection_matrix</span> <span class="o">@</span> <span class="n">cam_space</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span data-line="246">    
</span><span data-line="247">    <span class="n">ndc</span> <span class="o">=</span> <span class="n">clip_space</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">clip_space</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</span><span data-line="248">    
</span><span data-line="249">    <span class="n">screen_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">ndc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SCREEN_WIDTH</span>
</span><span data-line="250">    <span class="n">screen_y</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ndc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SCREEN_HEIGHT</span>
</span><span data-line="251">    <span class="n">screen_depth</span> <span class="o">=</span> <span class="n">clip_space</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
</span><span data-line="252">    <span class="n">screen_depth_norm</span> <span class="o">=</span> <span class="o">-</span><span class="n">far</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span><span class="n">far</span> <span class="o">+</span> <span class="n">z_scale</span> <span class="o">*</span> <span class="n">clip_space</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
</span><span data-line="253">    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">screen_x</span><span class="p">,</span> <span class="n">screen_y</span><span class="p">,</span> <span class="n">screen_depth</span><span class="p">,</span> <span class="n">screen_depth_norm</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>

</span><span data-line="254">
<div class="viewcode-block" id="sample_cone">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.sample_cone">[docs]</a>
</span><span data-line="255"><span class="k">def</span><span class="w"> </span><span class="nf">sample_cone</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
</span><span data-line="256">    <span class="n">device</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span>
</span><span data-line="257">    <span class="n">dtype</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span>
</span><span data-line="258">    <span class="n">phi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span>
</span><span data-line="259">    
</span><span data-line="260">    <span class="n">cos_alpha</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
</span><span data-line="261">    <span class="n">alpha</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_alpha</span><span class="p">)</span>
</span><span data-line="262">    <span class="n">sin_alpha</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
</span><span data-line="263">    <span class="n">cos_phi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
</span><span data-line="264">    <span class="n">sin_phi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
</span><span data-line="265">    <span class="n">local</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
</span><span data-line="266">        <span class="n">sin_alpha</span> <span class="o">*</span> <span class="n">cos_phi</span><span class="p">,</span> 
</span><span data-line="267">        <span class="n">sin_alpha</span> <span class="o">*</span> <span class="n">sin_phi</span><span class="p">,</span> 
</span><span data-line="268">        <span class="n">cos_alpha</span>
</span><span data-line="269">    <span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="270">    
</span><span data-line="271">    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.99</span><span class="p">:</span>
</span><span data-line="272">        <span class="n">ref</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span data-line="273">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="274">        <span class="n">ref</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span data-line="275">
</span><span data-line="276">    <span class="n">u</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="277">    <span class="n">v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
</span><span data-line="278">
</span><span data-line="279">    <span class="c1"># Basis matrix</span>
</span><span data-line="280">    <span class="n">basis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (3,3)</span>
</span><span data-line="281">
</span><span data-line="282">    <span class="c1"># Step 3: rotate local vectors into world space</span>
</span><span data-line="283">    <span class="n">world</span> <span class="o">=</span> <span class="n">local</span> <span class="o">@</span> <span class="n">basis</span><span class="o">.</span><span class="n">T</span>
</span><span data-line="284">    <span class="k">return</span> <span class="n">world</span></div>

</span><span data-line="285">    
<div class="viewcode-block" id="clipped_mean">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.clipped_mean">[docs]</a>
</span><span data-line="286"><span class="k">def</span><span class="w"> </span><span class="nf">clipped_mean</span><span class="p">(</span><span class="n">points</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">std_thresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
</span><span data-line="287"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="288"><span class="sd">    Compute mean of 3D points, keeping only those within `std_thresh` stds</span>
</span><span data-line="289"><span class="sd">    of the mean.</span>
</span><span data-line="290"><span class="sd">    </span>
</span><span data-line="291"><span class="sd">    points: (N,3) tensor</span>
</span><span data-line="292"><span class="sd">    std_thresh: threshold in standard deviations</span>
</span><span data-line="293"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="294">    <span class="c1"># First-pass mean and std (over points, separately for x/y/z)</span>
</span><span data-line="295">    <span class="n">mean</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    <span class="c1"># (1,3)</span>
</span><span data-line="296">    <span class="n">std</span>  <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">unbiased</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># (1,3)</span>
</span><span data-line="297">
</span><span data-line="298">    <span class="c1"># Compute z-scores (absolute deviations scaled by std)</span>
</span><span data-line="299">    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">points</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">std</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>   <span class="c1"># (N,3)</span>
</span><span data-line="300">
</span><span data-line="301">    <span class="c1"># A point is valid if *all* coords are within the threshold</span>
</span><span data-line="302">    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="n">std_thresh</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>        <span class="c1"># (N,)</span>
</span><span data-line="303">
</span><span data-line="304">    <span class="c1"># Filter points</span>
</span><span data-line="305">    <span class="n">valid_points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</span><span data-line="306">
</span><span data-line="307">    <span class="k">if</span> <span class="n">valid_points</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="308">        <span class="c1"># fallback: return global mean if all filtered out</span>
</span><span data-line="309">        <span class="k">return</span> <span class="n">mean</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">mask</span>
</span><span data-line="310">
</span><span data-line="311">    <span class="k">return</span> <span class="n">valid_points</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">mask</span></div>

</span><span data-line="312">    
</span><span data-line="313">
<div class="viewcode-block" id="interpolate">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.interpolate">[docs]</a>
</span><span data-line="314"><span class="k">def</span><span class="w"> </span><span class="nf">interpolate</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
</span><span data-line="315">    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">x1</span><span class="p">)</span></div>

</span><span data-line="316">
<div class="viewcode-block" id="smooth_mean">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.smooth_mean">[docs]</a>
</span><span data-line="317"><span class="k">def</span><span class="w"> </span><span class="nf">smooth_mean</span><span class="p">(</span><span class="n">x0</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">sx1</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">std_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
</span><span data-line="318">    <span class="n">x1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clipped_mean</span><span class="p">(</span><span class="n">sx1</span><span class="p">,</span> <span class="n">std_threshold</span><span class="p">)</span>
</span><span data-line="319">    <span class="k">return</span> <span class="n">interpolate</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span></div>

</span><span data-line="320">    
<div class="viewcode-block" id="project">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.project">[docs]</a>
</span><span data-line="321"><span class="k">def</span><span class="w"> </span><span class="nf">project</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span data-line="322">    <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span data-line="323">    <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span data-line="324">    <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span> <span class="o">*</span> <span class="n">b</span></div>

</span><span data-line="325">    
<div class="viewcode-block" id="extrapolate">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.extrapolate">[docs]</a>
</span><span data-line="326"><span class="k">def</span><span class="w"> </span><span class="nf">extrapolate</span><span class="p">(</span><span class="n">P</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span data-line="327">    <span class="n">dim_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dim</span>
</span><span data-line="328">    
</span><span data-line="329">    <span class="n">D</span> <span class="o">=</span> <span class="n">pairwise_distances_cross</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">source</span><span class="p">[:,</span> <span class="n">dim_mask</span><span class="p">])</span>
</span><span data-line="330">    <span class="n">min_idx</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="331">    
</span><span data-line="332">    <span class="n">result</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">P</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span data-line="333">    <span class="n">result</span><span class="p">[:,</span> <span class="n">dim_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span>
</span><span data-line="334">    <span class="n">result</span><span class="p">[:,</span> <span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="n">min_idx</span><span class="p">,</span> <span class="n">dim</span><span class="p">]</span>
</span><span data-line="335">    
</span><span data-line="336">    <span class="k">return</span> <span class="n">result</span></div>

</span><span data-line="337">    
<div class="viewcode-block" id="triangle_altitude">
<a class="viewcode-back" href="../../api/vector.html#utils.vector.triangle_altitude">[docs]</a>
</span><span data-line="338"><span class="k">def</span><span class="w"> </span><span class="nf">triangle_altitude</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span><span data-line="339">    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">==</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
</span><span data-line="340">    
</span><span data-line="341">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span data-line="342">        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="343">        
</span><span data-line="344">    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>

</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2025, Blake Moody</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/shibuya.js?v=e730760c"></script></body>
</html>